<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>BI Notes</title>
  <meta name="description" content="Study notes taken from BI courses and self learning.">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="BI Notes" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://github.com/James-SR/BI-Notes" />
  
  <meta property="og:description" content="Study notes taken from BI courses and self learning." />
  <meta name="github-repo" content="James-SR/BI-Notes" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="BI Notes" />
  
  <meta name="twitter:description" content="Study notes taken from BI courses and self learning." />
  

<meta name="author" content="James Solomon-Rounce">


<meta name="date" content="2018-03-12">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="index.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Business Intelligence Notes</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html"><i class="fa fa-check"></i><b>1</b> Querying Data with Transact-SQL</a><ul>
<li class="chapter" data-level="1.1" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#introduction-to-transact-sql"><i class="fa fa-check"></i><b>1.1</b> Introduction to Transact-SQL</a><ul>
<li class="chapter" data-level="1.1.1" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#data-types"><i class="fa fa-check"></i><b>1.1.1</b> Data Types</a></li>
<li class="chapter" data-level="1.1.2" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#working-with-nulls"><i class="fa fa-check"></i><b>1.1.2</b> Working with NULLs</a></li>
<li class="chapter" data-level="1.1.3" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#lab-exercises"><i class="fa fa-check"></i><b>1.1.3</b> Lab Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#querying-tables-with-select"><i class="fa fa-check"></i><b>1.2</b> Querying Tables with SELECT</a><ul>
<li class="chapter" data-level="1.2.1" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#removing-duplicates"><i class="fa fa-check"></i><b>1.2.1</b> Removing Duplicates</a></li>
<li class="chapter" data-level="1.2.2" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#sorting-results"><i class="fa fa-check"></i><b>1.2.2</b> Sorting Results</a></li>
<li class="chapter" data-level="1.2.3" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#paging-through-results"><i class="fa fa-check"></i><b>1.2.3</b> Paging through results</a></li>
<li class="chapter" data-level="1.2.4" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#filtering-and-using-predicates"><i class="fa fa-check"></i><b>1.2.4</b> Filtering and Using Predicates</a></li>
<li class="chapter" data-level="1.2.5" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#lab-exercises-1"><i class="fa fa-check"></i><b>1.2.5</b> Lab Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#querying-tables-with-joins"><i class="fa fa-check"></i><b>1.3</b> Querying Tables with Joins</a><ul>
<li class="chapter" data-level="1.3.1" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#inner-joins"><i class="fa fa-check"></i><b>1.3.1</b> INNER Joins</a></li>
<li class="chapter" data-level="1.3.2" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#outer-joins"><i class="fa fa-check"></i><b>1.3.2</b> OUTER Joins</a></li>
<li class="chapter" data-level="1.3.3" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#cross-joins"><i class="fa fa-check"></i><b>1.3.3</b> Cross Joins</a></li>
<li class="chapter" data-level="1.3.4" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#self-joins"><i class="fa fa-check"></i><b>1.3.4</b> Self Joins</a></li>
<li class="chapter" data-level="1.3.5" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#lab-exercises-2"><i class="fa fa-check"></i><b>1.3.5</b> Lab Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#using-set-operators"><i class="fa fa-check"></i><b>1.4</b> Using Set Operators</a><ul>
<li class="chapter" data-level="1.4.1" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#intersect-and-except-queries"><i class="fa fa-check"></i><b>1.4.1</b> INTERSECT and EXCEPT Queries</a></li>
<li class="chapter" data-level="1.4.2" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#lab-exercises-3"><i class="fa fa-check"></i><b>1.4.2</b> Lab Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#using-functions-and-aggregating-data"><i class="fa fa-check"></i><b>1.5</b> Using Functions and Aggregating Data</a><ul>
<li class="chapter" data-level="1.5.1" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#scalar-functions"><i class="fa fa-check"></i><b>1.5.1</b> Scalar Functions</a></li>
<li class="chapter" data-level="1.5.2" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#logical-functions"><i class="fa fa-check"></i><b>1.5.2</b> Logical Functions</a></li>
<li class="chapter" data-level="1.5.3" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#window-functions"><i class="fa fa-check"></i><b>1.5.3</b> Window Functions</a></li>
<li class="chapter" data-level="1.5.4" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#aggregate-functions"><i class="fa fa-check"></i><b>1.5.4</b> Aggregate Functions</a></li>
<li class="chapter" data-level="1.5.5" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#filtering-groups"><i class="fa fa-check"></i><b>1.5.5</b> Filtering Groups</a></li>
<li class="chapter" data-level="1.5.6" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#lab-exercises-4"><i class="fa fa-check"></i><b>1.5.6</b> Lab Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#sub-queries-and-apply"><i class="fa fa-check"></i><b>1.6</b> Sub-queries and Apply</a><ul>
<li class="chapter" data-level="1.6.1" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#self-contained-or-correlated-query"><i class="fa fa-check"></i><b>1.6.1</b> Self Contained or Correlated Query</a></li>
<li class="chapter" data-level="1.6.2" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#the-apply-operator"><i class="fa fa-check"></i><b>1.6.2</b> The Apply Operator</a></li>
<li class="chapter" data-level="1.6.3" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#lab-exercises-5"><i class="fa fa-check"></i><b>1.6.3</b> Lab Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#using-table-expressions"><i class="fa fa-check"></i><b>1.7</b> Using Table Expressions</a><ul>
<li class="chapter" data-level="1.7.1" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#views"><i class="fa fa-check"></i><b>1.7.1</b> Views</a></li>
<li class="chapter" data-level="1.7.2" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#using-temporary-tables-and-table-variables"><i class="fa fa-check"></i><b>1.7.2</b> Using Temporary Tables and Table Variables</a></li>
<li class="chapter" data-level="1.7.3" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#table-value-functions-tvf"><i class="fa fa-check"></i><b>1.7.3</b> Table Value Functions (TVF)</a></li>
<li class="chapter" data-level="1.7.4" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#derived-tables"><i class="fa fa-check"></i><b>1.7.4</b> Derived Tables</a></li>
<li class="chapter" data-level="1.7.5" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#using-common-table-expressions-ctes"><i class="fa fa-check"></i><b>1.7.5</b> Using Common Table Expressions (CTEs)</a></li>
<li class="chapter" data-level="1.7.6" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#lab-exercises-6"><i class="fa fa-check"></i><b>1.7.6</b> Lab Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#grouping-sets-and-pivoting-data"><i class="fa fa-check"></i><b>1.8</b> Grouping Sets and Pivoting Data</a><ul>
<li class="chapter" data-level="1.8.1" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#pivoting-data"><i class="fa fa-check"></i><b>1.8.1</b> Pivoting Data</a></li>
<li class="chapter" data-level="1.8.2" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#lab-exercises-7"><i class="fa fa-check"></i><b>1.8.2</b> Lab Exercises</a></li>
</ul></li>
<li class="chapter" data-level="1.9" data-path="querying-data-with-transact-sql.html"><a href="querying-data-with-transact-sql.html#modifying-data"><i class="fa fa-check"></i><b>1.9</b> Modifying Data</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">BI Notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="querying-data-with-transact-sql" class="section level1">
<h1><span class="header-section-number">1</span> Querying Data with Transact-SQL</h1>
<hr />
<p>Notes taken during/inspired by the edX course ‘Querying Data with Transact-SQL - Microsoft: DAT201x’ by Graeme Malcolm and Geoff Allix.</p>
<p><strong><em>Course Handouts</em></strong></p>
<ul>
<li><a href="../files/TSQL/Syllabus.PDF">Course Syllabus</a></li>
<li><a href="../files/TSQL/DAT201x.PDF">Getting Started Guide Including Install</a></li>
<li><a href="../files/TSQL/AW_ER.pdf">Adventure Works Entity Relationship Diagram</a></li>
<li><a href="../files/TSQL/AW-oltp-install-script">Adeventure Works db install script</a><br />
NOTE: Remember to ensure read only access for everyone to the folder containing the .SQL and other files</li>
<li><a href="https://microsoftlearning.github.io/QueryingT-SQL/">GitHib Repo for course including course materials, slids, labs etc</a></li>
<li><a href="../files/TSQL/TSQLCourseFiles.zip">A copy of the above materials should they be changed or removed</a></li>
</ul>
<p><strong><em>Other useful links</em></strong> * <a href="https://docs.microsoft.com/en-gb/sql/t-sql/language-reference">Transact-SQL Refrence</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(DBI)</code></pre></div>
<pre><code>## Loading required package: methods</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># creates a connection to the SQL database</span>
<span class="co"># note that &quot;con&quot; will be used later in each connection to the database</span>
con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(odbc<span class="op">::</span><span class="kw">odbc</span>(), 
                      <span class="dt">Driver =</span> <span class="st">&quot;SQL Server&quot;</span>, 
                      <span class="dt">Server =</span> <span class="st">&quot;localhost</span><span class="ch">\\</span><span class="st">SQLEXPRESS&quot;</span>, 
                      <span class="dt">Database =</span> <span class="st">&quot;AdventureWorksLT&quot;</span>, 
                      <span class="dt">Trusted_Connection =</span> <span class="st">&quot;True&quot;</span>)

<span class="co"># Sets knitr to use this connection as the default so we don&#39;t need to specify it for every chunk</span>
knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">connection =</span> <span class="st">&quot;con&quot;</span>)</code></pre></div>
<div id="introduction-to-transact-sql" class="section level2">
<h2><span class="header-section-number">1.1</span> Introduction to Transact-SQL</h2>
<p>SQL or Structured Query Language was first developed in the 1970s by IBM as a way of interacting with databases. Other vendors have specfic versions of SQL for instance Oracle is PL/SQL, Microsoft’s implentation is TSQL or Transact SQL. Both SQL Server (on prem) and Azure SQL Databases (cloud) use the same query language, however Azure is a subset of full TSQL since it some commands relate to local files and data functions within .NET that relate only to SQL Server. However, as new features are added to Azure, some new commands are being added to Azure.</p>
<p>SQL is a declarative language - you express what it is that you want, the results - rather than specifying the steps taken to acheive that - it is not prodecural like other programming languages, it is set theory based. It is possible to write proceedural elements or steps within TSQL, however if this is ocurring a lot, it is perhaps better done in another language, which may also perform or run better.</p>
<p>In databases, we typically talk about entities - one type of thing - which is contained in each table.<br />
* Entities are represented as relations (tables) * And entity attributes as domains (columns)</p>
<p>Most relationships are normalized, with relationships between primary and foreign keys. This helps to reduce duplication, however there are instances where de-normalised data is desired.</p>
<p>Schemas are namespaces for database objects - is shows a logical layout for all or part of a relational database, <em>“As part of a data dictionary, a database schema indicates how the entities that make up the database relate to one another, including tables, views, stored procedures, and more.”</em>(see <a href="https://www.lucidchart.com/pages/database-diagram/database-schema">Lucid Chart on Database Schemas</a>). The process of creating a database schema is called data modelling.</p>
<p>When referring to objects in a database, we could use a fully qualified name, such as:</p>
<ul>
<li>[server_name.][database_name.][schema_name.]object_name</li>
</ul>
<p>This is only really relevant for SQL Server, since Azure will only work with one database at a time. Most of the time we typically just use</p>
<ul>
<li>schema_name.object_name</li>
</ul>
<p>The schema name somwtimes be discarded, but it is considered best practice to include this, since there is sometimes some ambiguity about tables e.g. if we have two tables - Product.Order and Customer.Order - which order table is being referred to, that in the customer or product schema?</p>
<p>SQL has a number of SQL Statement Types:</p>
<ul>
<li>DML or Data Manipulation Language - SELECT, INSERT, UPDATE, DELETE</li>
<li>DDL or Data Definition Language - CREATE, ALTER, DROP</li>
<li>DCL or Data Control Language - GRANT, REVOKE, DENY</li>
</ul>
<p>The course focuses on DML which is typically for working with data.</p>
<p><strong>SELECT</strong> statement has a number of possible sub-components:</p>
<ul>
<li>FROM [table]</li>
<li>WHERE [condition for filtering rows]</li>
<li>GROUP BY [arranges rows by groups]</li>
<li>HAVING [condition for filtering groups]</li>
<li>ORDER BY [sorts the output]</li>
</ul>
<p>Whilst a SQL statement can look like English, it doesn’t neccessarily run from top to bottom in terms of the sequence of elements that are run in a query. For instance, the FROM is the first thing that will be run, then the WHERE filter will be run, then we GROUP BY, then SELECT the columns we are interested in and finally ORDER the results. This can be important when running some queries, which will be explored later in the course. When we run a query, it is not an actual table in a database that is return but a set of rows or record set or subset.</p>
<div id="data-types" class="section level3">
<h3><span class="header-section-number">1.1.1</span> Data Types</h3>
<p>There are a number of different data types in T-SQL as shown below, which are grouped in to a number of different types.</p>
<div class="figure">
<img src="images/TSQL/TSQLDataTypes.png" alt="Transact-SQL Data Types" width="742" />
<p class="caption">
(#fig:Data Types)Transact-SQL Data Types
</p>
</div>
<p>This is more relevant when designing a database, however it is useful to know when querying what data type you have in a broad sense - numeric, data, string and so on - as the types will determine what type of combinations can be combined together in expressions e.g. you can concatenate strings or add numbers together, but you can’t concatenate a string and a number together.</p>
<p>Sometimes it is neccessary to convert data from one type to another, there are two ways this could happen</p>
<ul>
<li>Implicit conversion - compatible data types are automatically converted</li>
<li>Explicit conversion - requires an explicit function e.g. CAST / TRY_CAST, STR, PARSE ? TRY_PARSE, CONVERT / TRY_CONVERT</li>
</ul>
<p>The TRY options will attempt a conversion and if it does not work, a NULL will be returned rather than an error in the non-TRY version.</p>
</div>
<div id="working-with-nulls" class="section level3">
<h3><span class="header-section-number">1.1.2</span> Working with NULLs</h3>
<p>There are recognised standards for treating NULL values - ANSI - which says that anythign involving a NULL should return a NULL. There are functions that help us handle NULL values:</p>
<ul>
<li>ISNULL(column/variable, value) - Returns <em>value</em> (which you can specify) if the column or variable is NULL</li>
<li>NULLIF(column/variable, value) - Returns NULL if the column or variable is a value - we are almost recoding a non-null to a null</li>
<li>COALESCE (column/variable1, column/variable2, …) - Returns the value of the first non-NULL column or variable in the list - for instance if contact details, someone might not have an email, so we might want a telephone number, if they don’t have that, return an address etc</li>
</ul>
<p>NULL is used to indicate an unknown or missing value. NULL is <strong>not</strong> equivalent to zero or an empty string.</p>
<p>ISNULL can be used like an IF function in excel, for instance:</p>
<blockquote>
<p>SELECT name, ISNULL(TRY_CAST(size AS Integer), 0) AS NumericSize<br />
FROM SalesLT.Product;</p>
</blockquote>
<p>In this instance, if there is a value that will be returned, if not, the NULL value will be returned as a 0.</p>
<p>We can also use a CASE statement to return a value whilst integrating NULL in to our query, e.g.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> name,  
    <span class="kw">CASE</span> <span class="kw">size</span>  
      <span class="kw">WHEN</span> <span class="st">&#39;S&#39;</span> <span class="kw">THEN</span> <span class="st">&#39;SMALL&#39;</span>  
      <span class="kw">WHEN</span> <span class="st">&#39;M&#39;</span> <span class="kw">THEN</span> <span class="st">&#39;MEDIUM&#39;</span>  
      <span class="kw">WHEN</span> <span class="st">&#39;L&#39;</span> <span class="kw">THEN</span> <span class="st">&#39;LARGE&#39;</span>  
      <span class="kw">WHEN</span> <span class="st">&#39;XL&#39;</span> <span class="kw">THEN</span> <span class="st">&#39;EXTRA LARGE&#39;</span>  
      <span class="kw">ELSE</span> ISNULL(<span class="kw">Size</span>, <span class="st">&#39;N/A&#39;</span>)  
    <span class="kw">END</span> <span class="kw">AS</span> PRODUCT  
  <span class="kw">FROM</span> SalesLT.Product; </code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-1">Table 1.1: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">PRODUCT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HL Road Frame - Black, 58</td>
<td align="left">58</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 58</td>
<td align="left">58</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">N/A</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Black</td>
<td align="left">N/A</td>
</tr>
<tr class="odd">
<td align="left">Mountain Bike Socks, M</td>
<td align="left">MEDIUM</td>
</tr>
<tr class="even">
<td align="left">Mountain Bike Socks, L</td>
<td align="left">LARGE</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Blue</td>
<td align="left">N/A</td>
</tr>
<tr class="even">
<td align="left">AWC Logo Cap</td>
<td align="left">N/A</td>
</tr>
<tr class="odd">
<td align="left">Long-Sleeve Logo Jersey, S</td>
<td align="left">SMALL</td>
</tr>
<tr class="even">
<td align="left">Long-Sleeve Logo Jersey, M</td>
<td align="left">MEDIUM</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="lab-exercises" class="section level3">
<h3><span class="header-section-number">1.1.3</span> Lab Exercises</h3>
<p>AdventureWorks Cycles is a company that sells directly to retailers, who then sell products to consumers. Each retailer that is an AdventureWorks customer has provided a named contact for all communication from AdventureWorks.</p>
<p>The sales manager at AdventureWorks has asked you to generate some reports containing details of the company’s customers to support a direct sales campaign. Let’s start with some basic exploration.</p>
<p>First we display the sales person, the customer’s title, surname and telephone number</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> SalesPerson, Title + <span class="st">&#39; &#39;</span> + LastName <span class="kw">AS</span> CustomerName, Phone
<span class="kw">FROM</span> SalesLT.Customer;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-2">Table 1.2: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">SalesPerson</th>
<th align="left">CustomerName</th>
<th align="left">Phone</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">Mr. Gee</td>
<td align="left">245-555-0173</td>
</tr>
<tr class="even">
<td align="left">adventure-works8</td>
<td align="left">Mr. Harris</td>
<td align="left">170-555-0127</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">Ms. Carreras</td>
<td align="left">279-555-0130</td>
</tr>
<tr class="even">
<td align="left">adventure-works0</td>
<td align="left">Ms. Gates</td>
<td align="left">710-555-0173</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">Mr. Harrington</td>
<td align="left">828-555-0186</td>
</tr>
<tr class="even">
<td align="left">adventure-works3</td>
<td align="left">Ms. Carroll</td>
<td align="left">244-555-0112</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">Mr. Gash</td>
<td align="left">192-555-0173</td>
</tr>
<tr class="even">
<td align="left">adventure-works1</td>
<td align="left">Ms. Garza</td>
<td align="left">150-555-0127</td>
</tr>
<tr class="odd">
<td align="left">adventure-works1</td>
<td align="left">Ms. Harding</td>
<td align="left">926-555-0159</td>
</tr>
<tr class="even">
<td align="left">adventure-works1</td>
<td align="left">Mr. Caprio</td>
<td align="left">112-555-0191</td>
</tr>
</tbody>
</table>
</div>
<p>Next we cast the CustomerID column to a VARCHAR and concatenate with the CompanyName column</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="fu">CAST</span>(CustomerID <span class="kw">AS</span> <span class="dt">VARCHAR</span>) + <span class="st">&#39;: &#39;</span> + CompanyName <span class="kw">AS</span> CustomerCompany
<span class="kw">FROM</span> SalesLT.Customer;</code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">CustomerCompany</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1: A Bike Store</td>
</tr>
<tr class="even">
<td align="left">2: Progressive Sports</td>
</tr>
<tr class="odd">
<td align="left">3: Advanced Bike Components</td>
</tr>
<tr class="even">
<td align="left">4: Modular Cycle Systems</td>
</tr>
<tr class="odd">
<td align="left">5: Metropolitan Sports Supply</td>
</tr>
<tr class="even">
<td align="left">6: Aerobic Exercise Company</td>
</tr>
<tr class="odd">
<td align="left">7: Associated Bikes</td>
</tr>
<tr class="even">
<td align="left">10: Rural Cycle Emporium</td>
</tr>
<tr class="odd">
<td align="left">11: Sharp Bikes</td>
</tr>
<tr class="even">
<td align="left">12: Bikes and Motorbikes</td>
</tr>
</tbody>
</table>
</div>
<p>The SalesLT.SalesOrderHeader table contains records of sales orders. You have been asked to retrieve data for a report that shows:</p>
<p>The sales order number and revision number in the format <Order Number> (<Revision>) (e.g. SO71774 (2)). The order date converted to ANSI standard format yyyy.mm.dd (e.g. 2015.01.31).</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> SalesOrderNumber + <span class="st">&#39; (&#39;</span> + STR(RevisionNumber, <span class="dv">1</span>) + <span class="st">&#39;)&#39;</span> <span class="kw">AS</span> OrderRevision,
       <span class="fu">CONVERT</span>(<span class="dt">NVARCHAR</span>(<span class="dv">30</span>), OrderDate, <span class="dv">102</span>) <span class="kw">AS</span> OrderDate
<span class="kw">FROM</span> SalesLT.SalesOrderHeader;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-4">Table 1.3: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">OrderRevision</th>
<th align="left">OrderDate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">SO71774 (2)</td>
<td align="left">2008.06.01</td>
</tr>
<tr class="even">
<td align="left">SO71776 (2)</td>
<td align="left">2008.06.01</td>
</tr>
<tr class="odd">
<td align="left">SO71780 (2)</td>
<td align="left">2008.06.01</td>
</tr>
<tr class="even">
<td align="left">SO71782 (2)</td>
<td align="left">2008.06.01</td>
</tr>
<tr class="odd">
<td align="left">SO71783 (2)</td>
<td align="left">2008.06.01</td>
</tr>
<tr class="even">
<td align="left">SO71784 (2)</td>
<td align="left">2008.06.01</td>
</tr>
<tr class="odd">
<td align="left">SO71796 (2)</td>
<td align="left">2008.06.01</td>
</tr>
<tr class="even">
<td align="left">SO71797 (2)</td>
<td align="left">2008.06.01</td>
</tr>
<tr class="odd">
<td align="left">SO71815 (2)</td>
<td align="left">2008.06.01</td>
</tr>
<tr class="even">
<td align="left">SO71816 (2)</td>
<td align="left">2008.06.01</td>
</tr>
</tbody>
</table>
</div>
<p>Next we write a query that returns a list of customer names. We use ISNULL to check for middle names and concatenate with FirstName and LastName.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> FirstName + <span class="st">&#39; &#39;</span> + ISNULL(MiddleName + <span class="st">&#39; &#39;</span>, <span class="st">&#39;&#39;</span>) + LastName
<span class="kw">AS</span> CustomerName
<span class="kw">FROM</span> SalesLT.Customer;</code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">CustomerName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Orlando N. Gee</td>
</tr>
<tr class="even">
<td align="left">Keith Harris</td>
</tr>
<tr class="odd">
<td align="left">Donna F. Carreras</td>
</tr>
<tr class="even">
<td align="left">Janet M. Gates</td>
</tr>
<tr class="odd">
<td align="left">Lucy Harrington</td>
</tr>
<tr class="even">
<td align="left">Rosmarie J. Carroll</td>
</tr>
<tr class="odd">
<td align="left">Dominic P. Gash</td>
</tr>
<tr class="even">
<td align="left">Kathleen M. Garza</td>
</tr>
<tr class="odd">
<td align="left">Katherine Harding</td>
</tr>
<tr class="even">
<td align="left">Johnny A. Caprio</td>
</tr>
</tbody>
</table>
</div>
<p>Next, we will imagine that some data has been deleted - customer email addresses - then we try to find contact details in sequence.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">UPDATE</span> SalesLT.Customer
<span class="kw">SET</span> EmailAddress = <span class="kw">NULL</span>
<span class="kw">WHERE</span> CustomerID % <span class="dv">7</span> = <span class="dv">1</span>;</code></pre></div>
<p>Next we write a query that returns a list of customer IDs in one column, and a second column named PrimaryContact that contains the email address if known, and otherwise the phone number.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> CustomerID, <span class="kw">COALESCE</span>(EmailAddress, Phone) <span class="kw">AS</span> PrimaryContact
<span class="kw">FROM</span> SalesLT.Customer;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-7">Table 1.4: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">CustomerID</th>
<th align="left">PrimaryContact</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="left">245-555-0173</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="left"><a href="mailto:keith0@adventure-works.com">keith0@adventure-works.com</a></td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="left"><a href="mailto:donna0@adventure-works.com">donna0@adventure-works.com</a></td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="left"><a href="mailto:janet1@adventure-works.com">janet1@adventure-works.com</a></td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="left"><a href="mailto:lucy0@adventure-works.com">lucy0@adventure-works.com</a></td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="left"><a href="mailto:rosmarie0@adventure-works.com">rosmarie0@adventure-works.com</a></td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="left"><a href="mailto:dominic0@adventure-works.com">dominic0@adventure-works.com</a></td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="left"><a href="mailto:kathleen0@adventure-works.com">kathleen0@adventure-works.com</a></td>
</tr>
<tr class="odd">
<td align="right">11</td>
<td align="left"><a href="mailto:katherine0@adventure-works.com">katherine0@adventure-works.com</a></td>
</tr>
<tr class="even">
<td align="right">12</td>
<td align="left"><a href="mailto:johnny0@adventure-works.com">johnny0@adventure-works.com</a></td>
</tr>
</tbody>
</table>
</div>
<p>You have been asked to create a query that returns a list of sales order IDs and order dates with a column named ShippingStatus that contains the text “Shipped” for orders with a known ship date, and “Awaiting Shipment” for orders with no ship date.</p>
<p>Again, we imagine that some data is missing by deleting some first.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">UPDATE</span> SalesLT.SalesOrderHeader
<span class="kw">SET</span> ShipDate = <span class="kw">NULL</span>
<span class="kw">WHERE</span> SalesOrderID &gt; <span class="dv">71899</span>;</code></pre></div>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> SalesOrderID, OrderDate,
  <span class="kw">CASE</span>
    <span class="kw">WHEN</span> ShipDate <span class="kw">IS</span> <span class="kw">NULL</span> <span class="kw">THEN</span> <span class="st">&#39;Awaiting Shipment&#39;</span>
    <span class="kw">ELSE</span> <span class="st">&#39;Shipped&#39;</span>
  <span class="kw">END</span> <span class="kw">AS</span> ShippingStatus
<span class="kw">FROM</span> SalesLT.SalesOrderHeader;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-9">Table 1.5: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">SalesOrderID</th>
<th align="left">OrderDate</th>
<th align="left">ShippingStatus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">71774</td>
<td align="left">2008-06-01</td>
<td align="left">Shipped</td>
</tr>
<tr class="even">
<td align="right">71776</td>
<td align="left">2008-06-01</td>
<td align="left">Shipped</td>
</tr>
<tr class="odd">
<td align="right">71780</td>
<td align="left">2008-06-01</td>
<td align="left">Shipped</td>
</tr>
<tr class="even">
<td align="right">71782</td>
<td align="left">2008-06-01</td>
<td align="left">Shipped</td>
</tr>
<tr class="odd">
<td align="right">71783</td>
<td align="left">2008-06-01</td>
<td align="left">Shipped</td>
</tr>
<tr class="even">
<td align="right">71784</td>
<td align="left">2008-06-01</td>
<td align="left">Shipped</td>
</tr>
<tr class="odd">
<td align="right">71796</td>
<td align="left">2008-06-01</td>
<td align="left">Shipped</td>
</tr>
<tr class="even">
<td align="right">71797</td>
<td align="left">2008-06-01</td>
<td align="left">Shipped</td>
</tr>
<tr class="odd">
<td align="right">71815</td>
<td align="left">2008-06-01</td>
<td align="left">Shipped</td>
</tr>
<tr class="even">
<td align="right">71816</td>
<td align="left">2008-06-01</td>
<td align="left">Shipped</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="querying-tables-with-select" class="section level2">
<h2><span class="header-section-number">1.2</span> Querying Tables with SELECT</h2>
<div id="removing-duplicates" class="section level3">
<h3><span class="header-section-number">1.2.1</span> Removing Duplicates</h3>
<p>If we wanted to know what colours our products are, we would run something like the following.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Color
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">Color</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Black</td>
</tr>
<tr class="even">
<td align="left">Red</td>
</tr>
<tr class="odd">
<td align="left">Red</td>
</tr>
<tr class="even">
<td align="left">Black</td>
</tr>
<tr class="odd">
<td align="left">White</td>
</tr>
<tr class="even">
<td align="left">White</td>
</tr>
<tr class="odd">
<td align="left">Blue</td>
</tr>
<tr class="even">
<td align="left">Multi</td>
</tr>
<tr class="odd">
<td align="left">Multi</td>
</tr>
<tr class="even">
<td align="left">Multi</td>
</tr>
</tbody>
</table>
</div>
<p>Here each product has a row and corresponding colour. However, if we just want colour, we are typically interested in removing duplicates to just show what colours we are actually producing. This is achieve using the DISTINCT keyword</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> Color
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">Color</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Black</td>
</tr>
<tr class="odd">
<td align="left">Blue</td>
</tr>
<tr class="even">
<td align="left">Grey</td>
</tr>
<tr class="odd">
<td align="left">Multi</td>
</tr>
<tr class="even">
<td align="left">Red</td>
</tr>
<tr class="odd">
<td align="left">Silver</td>
</tr>
<tr class="even">
<td align="left">Silver/Black</td>
</tr>
<tr class="odd">
<td align="left">White</td>
</tr>
<tr class="even">
<td align="left">Yellow</td>
</tr>
</tbody>
</table>
</div>
<p>These results are DISTINCT at the row level, so if we have two combinitions of columns - say size and colour - then it would be DISTINCT colour and size combinations that appear in the database.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> Color, <span class="kw">Size</span>
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-12">Table 1.6: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Color</th>
<th align="left">Size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">NA</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Black</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Black</td>
<td align="left">38</td>
</tr>
<tr class="even">
<td align="left">Black</td>
<td align="left">40</td>
</tr>
<tr class="odd">
<td align="left">Black</td>
<td align="left">42</td>
</tr>
<tr class="even">
<td align="left">Black</td>
<td align="left">44</td>
</tr>
<tr class="odd">
<td align="left">Black</td>
<td align="left">46</td>
</tr>
<tr class="even">
<td align="left">Black</td>
<td align="left">48</td>
</tr>
<tr class="odd">
<td align="left">Black</td>
<td align="left">52</td>
</tr>
<tr class="even">
<td align="left">Black</td>
<td align="left">58</td>
</tr>
</tbody>
</table>
</div>
<p>Here is just the size - here IS NULL will return a ‘None’ if the Size is missing (NA).</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> ISNULL(<span class="kw">Size</span>, <span class="st">&#39;None&#39;</span>) <span class="kw">AS</span> <span class="kw">Size</span>
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">Size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">38</td>
</tr>
<tr class="even">
<td align="left">40</td>
</tr>
<tr class="odd">
<td align="left">42</td>
</tr>
<tr class="even">
<td align="left">44</td>
</tr>
<tr class="odd">
<td align="left">46</td>
</tr>
<tr class="even">
<td align="left">48</td>
</tr>
<tr class="odd">
<td align="left">50</td>
</tr>
<tr class="even">
<td align="left">52</td>
</tr>
<tr class="odd">
<td align="left">54</td>
</tr>
<tr class="even">
<td align="left">56</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="sorting-results" class="section level3">
<h3><span class="header-section-number">1.2.2</span> Sorting Results</h3>
<p>ORDER By is how we sort the results. Any aliased fields used in the SELECT element are visible by ORDER BY. You can oder the results using columns that are not selected in the SELECT clause. You can also ORDER BY multiple columns, either ascending or descending.</p>
<p>We can also just show the top 10 products, e.g. the top 10 most expensive. This is done using the keywork TOP</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> TOP (<span class="dv">10</span>) ProductCategoryID <span class="kw">AS</span> <span class="kw">Category</span>, Name, ListPrice
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">ORDER</span> <span class="kw">BY</span> ListPrice <span class="kw">DESC</span>, <span class="kw">Category</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-14">Table 1.7: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">Category</th>
<th align="left">Name</th>
<th align="right">ListPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">6</td>
<td align="left">Road-150 Red, 62</td>
<td align="right">3578.27</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="left">Road-150 Red, 44</td>
<td align="right">3578.27</td>
</tr>
<tr class="odd">
<td align="right">6</td>
<td align="left">Road-150 Red, 48</td>
<td align="right">3578.27</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="left">Road-150 Red, 52</td>
<td align="right">3578.27</td>
</tr>
<tr class="odd">
<td align="right">6</td>
<td align="left">Road-150 Red, 56</td>
<td align="right">3578.27</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="left">Mountain-100 Silver, 38</td>
<td align="right">3399.99</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="left">Mountain-100 Silver, 42</td>
<td align="right">3399.99</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="left">Mountain-100 Silver, 44</td>
<td align="right">3399.99</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="left">Mountain-100 Silver, 48</td>
<td align="right">3399.99</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="left">Mountain-100 Black, 38</td>
<td align="right">3374.99</td>
</tr>
</tbody>
</table>
</div>
<p>We can also use TOP (N) Percent or TOP (N) WITH TIES. If we say wanted the bottom 10 items - say those with the lowest price - there is no ‘BOTTOM’ Keyword, instead we would sort our data so that they are now in the the order we want - with those we are interested at the top - the use TOP again.</p>
</div>
<div id="paging-through-results" class="section level3">
<h3><span class="header-section-number">1.2.3</span> Paging through results</h3>
<p>This is achieved through using the OFFSET-FETCH which is an extension of ORDER BY. This might be useful if you have a set of web page results and you want to see certain ones.</p>
<p>You first say how many rows you want to skip using e.g. OFFSET 10 ROWS, then use specify how many rows you are interested in retrieving from the database e.g. FETCH NEXT 10 ROWS ONLY.</p>
</div>
<div id="filtering-and-using-predicates" class="section level3">
<h3><span class="header-section-number">1.2.4</span> Filtering and Using Predicates</h3>
<p>We can use the WHERE clause with a number of coniditions or predicates. For instance = (equals) &lt;&gt; (not equals), IN, BETWEEN (is an inclusive statement e.g. BETWEEN 100 AND 200 includes 100 and 200), LIKE, AND, OR and NOT. IN can be more efficient in coding terms when testing multiple attributes, as you just say color IN (red, blue) rather than colour = ‘red’ OR colour = ‘blue’. This becomes more useful when testing multiple conditions e.g. IN (red, blue) AND size = large - this would have more typing with explicit code for each combition.</p>
<p>Like mathematics, SQL works on PEMDAS sequencing - parenthesis, exponents, multiplication, division, addition, subtraction.</p>
<p>Some examples.</p>
<p>First look for products that start with an FR:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, Color, <span class="kw">Size</span>, ProductNumber
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">WHERE</span> ProductNumber <span class="kw">LIKE</span> <span class="st">&#39;FR%&#39;</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-15">Table 1.8: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">Color</th>
<th align="left">Size</th>
<th align="left">ProductNumber</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HL Road Frame - Black, 58</td>
<td align="left">Black</td>
<td align="left">58</td>
<td align="left">FR-R92B-58</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 58</td>
<td align="left">Red</td>
<td align="left">58</td>
<td align="left">FR-R92R-58</td>
</tr>
<tr class="odd">
<td align="left">HL Road Frame - Red, 62</td>
<td align="left">Red</td>
<td align="left">62</td>
<td align="left">FR-R92R-62</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 44</td>
<td align="left">Red</td>
<td align="left">44</td>
<td align="left">FR-R92R-44</td>
</tr>
<tr class="odd">
<td align="left">HL Road Frame - Red, 48</td>
<td align="left">Red</td>
<td align="left">48</td>
<td align="left">FR-R92R-48</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 52</td>
<td align="left">Red</td>
<td align="left">52</td>
<td align="left">FR-R92R-52</td>
</tr>
<tr class="odd">
<td align="left">HL Road Frame - Red, 56</td>
<td align="left">Red</td>
<td align="left">56</td>
<td align="left">FR-R92R-56</td>
</tr>
<tr class="even">
<td align="left">LL Road Frame - Black, 58</td>
<td align="left">Black</td>
<td align="left">58</td>
<td align="left">FR-R38B-58</td>
</tr>
<tr class="odd">
<td align="left">LL Road Frame - Black, 60</td>
<td align="left">Black</td>
<td align="left">60</td>
<td align="left">FR-R38B-60</td>
</tr>
<tr class="even">
<td align="left">LL Road Frame - Black, 62</td>
<td align="left">Black</td>
<td align="left">62</td>
<td align="left">FR-R38B-62</td>
</tr>
</tbody>
</table>
</div>
<p>Or we can look for products that end in a 58:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, Color, <span class="kw">Size</span>, ProductNumber
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">WHERE</span> ProductNumber <span class="kw">LIKE</span> <span class="st">&#39;%58&#39;</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-16">Table 1.9: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">Color</th>
<th align="left">Size</th>
<th align="left">ProductNumber</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HL Road Frame - Black, 58</td>
<td align="left">Black</td>
<td align="left">58</td>
<td align="left">FR-R92B-58</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 58</td>
<td align="left">Red</td>
<td align="left">58</td>
<td align="left">FR-R92R-58</td>
</tr>
<tr class="odd">
<td align="left">LL Road Frame - Black, 58</td>
<td align="left">Black</td>
<td align="left">58</td>
<td align="left">FR-R38B-58</td>
</tr>
<tr class="even">
<td align="left">LL Road Frame - Red, 58</td>
<td align="left">Red</td>
<td align="left">58</td>
<td align="left">FR-R38R-58</td>
</tr>
<tr class="odd">
<td align="left">ML Road Frame - Red, 58</td>
<td align="left">Red</td>
<td align="left">58</td>
<td align="left">FR-R72R-58</td>
</tr>
<tr class="even">
<td align="left">Road-450 Red, 58</td>
<td align="left">Red</td>
<td align="left">58</td>
<td align="left">BK-R68R-58</td>
</tr>
<tr class="odd">
<td align="left">Road-650 Red, 58</td>
<td align="left">Red</td>
<td align="left">58</td>
<td align="left">BK-R50R-58</td>
</tr>
<tr class="even">
<td align="left">Road-650 Black, 58</td>
<td align="left">Black</td>
<td align="left">58</td>
<td align="left">BK-R50B-58</td>
</tr>
<tr class="odd">
<td align="left">Road-250 Red, 58</td>
<td align="left">Red</td>
<td align="left">58</td>
<td align="left">BK-R89R-58</td>
</tr>
<tr class="even">
<td align="left">Road-250 Black, 58</td>
<td align="left">Black</td>
<td align="left">58</td>
<td align="left">BK-R89B-58</td>
</tr>
</tbody>
</table>
</div>
<p>Or we can use underscores to specify a number of charecters e.g. one _ is one missing charecter. A wildcard (%) would match any number of chars. The figures in brackets then are like regex, so if we want a numeric value between 0 and 9 we use [0-9]. Equally we could use a similar query to find things like email addresses in a string, or email addresses that end in a .co.uk.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, Color, <span class="kw">Size</span>, ProductNumber
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">WHERE</span> ProductNumber <span class="kw">LIKE</span> <span class="st">&#39;BK-_[0-9][0-9]_-[0-9][0-9]&#39;</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-17">Table 1.10: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">Color</th>
<th align="left">Size</th>
<th align="left">ProductNumber</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Road-150 Red, 62</td>
<td align="left">Red</td>
<td align="left">62</td>
<td align="left">BK-R93R-62</td>
</tr>
<tr class="even">
<td align="left">Road-150 Red, 44</td>
<td align="left">Red</td>
<td align="left">44</td>
<td align="left">BK-R93R-44</td>
</tr>
<tr class="odd">
<td align="left">Road-150 Red, 48</td>
<td align="left">Red</td>
<td align="left">48</td>
<td align="left">BK-R93R-48</td>
</tr>
<tr class="even">
<td align="left">Road-150 Red, 52</td>
<td align="left">Red</td>
<td align="left">52</td>
<td align="left">BK-R93R-52</td>
</tr>
<tr class="odd">
<td align="left">Road-150 Red, 56</td>
<td align="left">Red</td>
<td align="left">56</td>
<td align="left">BK-R93R-56</td>
</tr>
<tr class="even">
<td align="left">Road-450 Red, 58</td>
<td align="left">Red</td>
<td align="left">58</td>
<td align="left">BK-R68R-58</td>
</tr>
<tr class="odd">
<td align="left">Road-450 Red, 60</td>
<td align="left">Red</td>
<td align="left">60</td>
<td align="left">BK-R68R-60</td>
</tr>
<tr class="even">
<td align="left">Road-450 Red, 44</td>
<td align="left">Red</td>
<td align="left">44</td>
<td align="left">BK-R68R-44</td>
</tr>
<tr class="odd">
<td align="left">Road-450 Red, 48</td>
<td align="left">Red</td>
<td align="left">48</td>
<td align="left">BK-R68R-48</td>
</tr>
<tr class="even">
<td align="left">Road-450 Red, 52</td>
<td align="left">Red</td>
<td align="left">52</td>
<td align="left">BK-R68R-52</td>
</tr>
</tbody>
</table>
</div>
<p>We can use the BETWEEN clause on things like dates to select all products that were removed from sale in 2016:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name
<span class="kw">FROM</span> SalesLT.Product 
<span class="kw">WHERE</span> SellEndDate <span class="kw">BETWEEN</span> <span class="st">&#39;2006/1/1&#39;</span> <span class="kw">AND</span> <span class="st">&#39;2006/12/31&#39;</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Mountain Bike Socks, M</td>
</tr>
<tr class="even">
<td align="left">Mountain Bike Socks, L</td>
</tr>
<tr class="odd">
<td align="left">ML Road Frame - Red, 44</td>
</tr>
<tr class="even">
<td align="left">ML Road Frame - Red, 48</td>
</tr>
<tr class="odd">
<td align="left">ML Road Frame - Red, 52</td>
</tr>
<tr class="even">
<td align="left">ML Road Frame - Red, 58</td>
</tr>
<tr class="odd">
<td align="left">ML Road Frame - Red, 60</td>
</tr>
<tr class="even">
<td align="left">HL Mountain Frame - Silver, 44</td>
</tr>
<tr class="odd">
<td align="left">HL Mountain Frame - Silver, 48</td>
</tr>
<tr class="even">
<td align="left">HL Mountain Frame - Black, 44</td>
</tr>
</tbody>
</table>
</div>
<p>Note that it is often useful to order results in the order you want, even if it currently appears it the correct order. Sometimes these queries may change as data or the database does, so it is best to be explicit and use an ORDER BY.</p>
</div>
<div id="lab-exercises-1" class="section level3">
<h3><span class="header-section-number">1.2.5</span> Lab Exercises</h3>
<p>You are being told that transportation costs are increasing and you need to identify the heaviest products.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- select the top 10 percent from the Name column</span>
<span class="kw">SELECT</span> TOP (<span class="dv">10</span>) <span class="kw">Percent</span> Name, Weight
<span class="kw">FROM</span> SalesLT.Product
<span class="co">-- order by the weight in descending order</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> Weight <span class="kw">DESC</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-19">Table 1.11: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="right">Weight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Touring-3000 Blue, 62</td>
<td align="right">13607.70</td>
</tr>
<tr class="even">
<td align="left">Touring-3000 Yellow, 62</td>
<td align="right">13607.70</td>
</tr>
<tr class="odd">
<td align="left">Touring-3000 Blue, 58</td>
<td align="right">13562.34</td>
</tr>
<tr class="even">
<td align="left">Touring-3000 Yellow, 58</td>
<td align="right">13512.45</td>
</tr>
<tr class="odd">
<td align="left">Touring-3000 Blue, 54</td>
<td align="right">13462.55</td>
</tr>
<tr class="even">
<td align="left">Touring-3000 Yellow, 54</td>
<td align="right">13344.62</td>
</tr>
<tr class="odd">
<td align="left">Touring-3000 Yellow, 50</td>
<td align="right">13213.08</td>
</tr>
<tr class="even">
<td align="left">Touring-3000 Blue, 50</td>
<td align="right">13213.08</td>
</tr>
<tr class="odd">
<td align="left">Touring-3000 Blue, 44</td>
<td align="right">13049.78</td>
</tr>
<tr class="even">
<td align="left">Touring-3000 Yellow, 44</td>
<td align="right">13049.78</td>
</tr>
</tbody>
</table>
</div>
<p>Next, we want to ignore the first 10 records - to page through using offset</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">ORDER</span> <span class="kw">BY</span> Weight <span class="kw">DESC</span>
<span class="co">-- offset 10 rows and get the next 100</span>
OFFSET <span class="dv">10</span> <span class="kw">ROWS</span> FETCH <span class="kw">NEXT</span> <span class="dv">100</span> <span class="kw">ROWS</span> <span class="kw">ONLY</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Mountain-500 Silver, 52</td>
</tr>
<tr class="even">
<td align="left">Mountain-500 Black, 52</td>
</tr>
<tr class="odd">
<td align="left">Mountain-500 Black, 48</td>
</tr>
<tr class="even">
<td align="left">Mountain-500 Silver, 48</td>
</tr>
<tr class="odd">
<td align="left">Mountain-500 Silver, 44</td>
</tr>
<tr class="even">
<td align="left">Mountain-500 Black, 44</td>
</tr>
<tr class="odd">
<td align="left">Touring-2000 Blue, 60</td>
</tr>
<tr class="even">
<td align="left">Mountain-500 Black, 42</td>
</tr>
<tr class="odd">
<td align="left">Mountain-500 Silver, 42</td>
</tr>
<tr class="even">
<td align="left">Touring-2000 Blue, 54</td>
</tr>
</tbody>
</table>
</div>
<p>Next we create a query to find the names, colors, and sizes of the products with a product model ID of 1.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- select the Name, Color, and Size columns</span>
<span class="kw">SELECT</span> Name, Color, <span class="kw">Size</span>
<span class="kw">FROM</span> SalesLT.Product
<span class="co">-- check ProductModelID is 1</span>
<span class="kw">WHERE</span> ProductModelID = <span class="dv">1</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-21">Table 1.12: </span>3 records</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">Color</th>
<th align="left">Size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Classic Vest, S</td>
<td align="left">Blue</td>
<td align="left">S</td>
</tr>
<tr class="even">
<td align="left">Classic Vest, M</td>
<td align="left">Blue</td>
<td align="left">M</td>
</tr>
<tr class="odd">
<td align="left">Classic Vest, L</td>
<td align="left">Blue</td>
<td align="left">L</td>
</tr>
</tbody>
</table>
</div>
<p>Now we would like more information on products of certain colors and sizes. We retrieve the product number and name of the products that have a Color of ‘Black’, ‘Red’, or ‘White’ and a Size of ‘S’ or ‘M’.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- select the ProductNumber and Name columns</span>
<span class="kw">SELECT</span> ProductNumber, Name
<span class="kw">FROM</span> SalesLT.Product
<span class="co">-- check that Color is one of &#39;Black&#39;, &#39;Red&#39; or &#39;White&#39;</span>
<span class="co">-- check that Size is one of &#39;S&#39; or &#39;M&#39;</span>
<span class="kw">WHERE</span> Color <span class="kw">IN</span> (<span class="st">&#39;Black&#39;</span>, <span class="st">&#39;Red&#39;</span>, <span class="st">&#39;White&#39;</span>) <span class="kw">AND</span> <span class="kw">Size</span> <span class="kw">IN</span> (<span class="st">&#39;S&#39;</span>, <span class="st">&#39;M&#39;</span>);</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-22">Table 1.13: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ProductNumber</th>
<th align="left">Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">SO-B909-M</td>
<td align="left">Mountain Bike Socks, M</td>
</tr>
<tr class="even">
<td align="left">SH-M897-S</td>
<td align="left">Men’s Sports Shorts, S</td>
</tr>
<tr class="odd">
<td align="left">SH-M897-M</td>
<td align="left">Men’s Sports Shorts, M</td>
</tr>
<tr class="even">
<td align="left">TG-W091-S</td>
<td align="left">Women’s Tights, S</td>
</tr>
<tr class="odd">
<td align="left">TG-W091-M</td>
<td align="left">Women’s Tights, M</td>
</tr>
<tr class="even">
<td align="left">GL-H102-S</td>
<td align="left">Half-Finger Gloves, S</td>
</tr>
<tr class="odd">
<td align="left">GL-H102-M</td>
<td align="left">Half-Finger Gloves, M</td>
</tr>
<tr class="even">
<td align="left">GL-F110-S</td>
<td align="left">Full-Finger Gloves, S</td>
</tr>
<tr class="odd">
<td align="left">GL-F110-M</td>
<td align="left">Full-Finger Gloves, M</td>
</tr>
<tr class="even">
<td align="left">SH-W890-S</td>
<td align="left">Women’s Mountain Shorts, S</td>
</tr>
</tbody>
</table>
</div>
<p>Next you have been asked to retrieve the product number, name, and list price of products that have a product number beginning with ‘BK-’.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- select the ProductNumber, Name, and ListPrice columns</span>
<span class="kw">SELECT</span> ProductNumber, Name, ListPrice
<span class="kw">FROM</span> SalesLT.Product
<span class="co">-- filter for product numbers beginning with BK- using LIKE</span>
<span class="kw">WHERE</span> ProductNumber <span class="kw">LIKE</span> <span class="st">&#39;BK-%&#39;</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-23">Table 1.14: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ProductNumber</th>
<th align="left">Name</th>
<th align="right">ListPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">BK-R93R-62</td>
<td align="left">Road-150 Red, 62</td>
<td align="right">3578.27</td>
</tr>
<tr class="even">
<td align="left">BK-R93R-44</td>
<td align="left">Road-150 Red, 44</td>
<td align="right">3578.27</td>
</tr>
<tr class="odd">
<td align="left">BK-R93R-48</td>
<td align="left">Road-150 Red, 48</td>
<td align="right">3578.27</td>
</tr>
<tr class="even">
<td align="left">BK-R93R-52</td>
<td align="left">Road-150 Red, 52</td>
<td align="right">3578.27</td>
</tr>
<tr class="odd">
<td align="left">BK-R93R-56</td>
<td align="left">Road-150 Red, 56</td>
<td align="right">3578.27</td>
</tr>
<tr class="even">
<td align="left">BK-R68R-58</td>
<td align="left">Road-450 Red, 58</td>
<td align="right">1457.99</td>
</tr>
<tr class="odd">
<td align="left">BK-R68R-60</td>
<td align="left">Road-450 Red, 60</td>
<td align="right">1457.99</td>
</tr>
<tr class="even">
<td align="left">BK-R68R-44</td>
<td align="left">Road-450 Red, 44</td>
<td align="right">1457.99</td>
</tr>
<tr class="odd">
<td align="left">BK-R68R-48</td>
<td align="left">Road-450 Red, 48</td>
<td align="right">1457.99</td>
</tr>
<tr class="even">
<td align="left">BK-R68R-52</td>
<td align="left">Road-450 Red, 52</td>
<td align="right">1457.99</td>
</tr>
</tbody>
</table>
</div>
<p>Finally, the product manager is interested in a slight variation of the last request regarding product numbers with a particular prefix.</p>
<p>We are interested in products with product number beginning with ‘BK-’ followed by any character other than ‘R’, and ending with a ‘-’ followed by any two numerals. Not an R is [^R].</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- select the ProductNumber, Name, and ListPrice columns</span>
<span class="kw">SELECT</span> ProductNumber, Name, ListPrice
<span class="kw">FROM</span> SalesLT.Product
<span class="co">-- filter for ProductNumbers</span>
<span class="kw">WHERE</span> ProductNumber <span class="kw">LIKE</span> <span class="st">&#39;BK-[^R]%-[0-9][0-9]&#39;</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-24">Table 1.15: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ProductNumber</th>
<th align="left">Name</th>
<th align="right">ListPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">BK-M82S-38</td>
<td align="left">Mountain-100 Silver, 38</td>
<td align="right">3399.99</td>
</tr>
<tr class="even">
<td align="left">BK-M82S-42</td>
<td align="left">Mountain-100 Silver, 42</td>
<td align="right">3399.99</td>
</tr>
<tr class="odd">
<td align="left">BK-M82S-44</td>
<td align="left">Mountain-100 Silver, 44</td>
<td align="right">3399.99</td>
</tr>
<tr class="even">
<td align="left">BK-M82S-48</td>
<td align="left">Mountain-100 Silver, 48</td>
<td align="right">3399.99</td>
</tr>
<tr class="odd">
<td align="left">BK-M82B-38</td>
<td align="left">Mountain-100 Black, 38</td>
<td align="right">3374.99</td>
</tr>
<tr class="even">
<td align="left">BK-M82B-42</td>
<td align="left">Mountain-100 Black, 42</td>
<td align="right">3374.99</td>
</tr>
<tr class="odd">
<td align="left">BK-M82B-44</td>
<td align="left">Mountain-100 Black, 44</td>
<td align="right">3374.99</td>
</tr>
<tr class="even">
<td align="left">BK-M82B-48</td>
<td align="left">Mountain-100 Black, 48</td>
<td align="right">3374.99</td>
</tr>
<tr class="odd">
<td align="left">BK-M68S-38</td>
<td align="left">Mountain-200 Silver, 38</td>
<td align="right">2319.99</td>
</tr>
<tr class="even">
<td align="left">BK-M68S-42</td>
<td align="left">Mountain-200 Silver, 42</td>
<td align="right">2319.99</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="querying-tables-with-joins" class="section level2">
<h2><span class="header-section-number">1.3</span> Querying Tables with Joins</h2>
<p>We usually join tables based on primary key - foreign key relationships. We don’t run two queries then join, but match at the time of the query. When we are talking about joins, we typically represent them as Venn diagrams.</p>
<p>The convention (ANSI SQL-92) is to specify the JOIN operator in the FROM clause:</p>
<blockquote>
<p>SELECT … FROM Table1 JOIN Table 2 ON <on_predicate>;</p>
</blockquote>
<p>There is an older standard (ANSI SQL-89) where the tables are joined using commas in the FROM clause and using a WHERE operator, but this can lead to accidental cartesian (aka cross) products.</p>
<div id="inner-joins" class="section level3">
<h3><span class="header-section-number">1.3.1</span> INNER Joins</h3>
<p>INNER Joins are typically the most common join type. It involves a join only where a match is found in both input tables. You can add multiple joins after each other.</p>
<p>Some examples - first a basic inner join where the schema, table and column are explicitly stated.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> SalesLT.Product.Name <span class="kw">AS</span> ProductName, SalesLT.ProductCategory.Name <span class="kw">AS</span> <span class="kw">Category</span>
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.ProductCategory
<span class="kw">ON</span> SalesLT.Product.ProductCategoryID = SalesLT.ProductCategory.ProductCategoryID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-25">Table 1.16: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ProductName</th>
<th align="left">Category</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Mountain-100 Silver, 38</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Silver, 42</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-100 Silver, 44</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Silver, 48</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-100 Black, 38</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Black, 42</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-100 Black, 44</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Black, 48</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-200 Silver, 38</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-200 Silver, 42</td>
<td align="left">Mountain Bikes</td>
</tr>
</tbody>
</table>
</div>
<p>Next, we can do the same query but make this less cumbersome by using table aliases.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> p.Name <span class="kw">AS</span> ProductName, c.Name <span class="kw">AS</span> <span class="kw">Category</span>
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> p
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.ProductCategory <span class="kw">AS</span> c
<span class="kw">on</span> p.ProductCategoryID = c.ProductCategoryID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-26">Table 1.17: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ProductName</th>
<th align="left">Category</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Mountain-100 Silver, 38</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Silver, 42</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-100 Silver, 44</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Silver, 48</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-100 Black, 38</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Black, 42</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-100 Black, 44</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Black, 48</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-200 Silver, 38</td>
<td align="left">Mountain Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-200 Silver, 42</td>
<td align="left">Mountain Bikes</td>
</tr>
</tbody>
</table>
</div>
<p>Next, we look at joining multiple tables, where we want the sales, including order level details, the products in the order and the product details. If we don’t specify the join type, the assumption is it is a INNER join, as shown below.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> oh.OrderDate, oh.SalesOrderNumber, p.Name <span class="kw">As</span> ProductName, od.OrderQty, od.UnitPrice, od.LineTotal
<span class="kw">FROM</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> oh
<span class="kw">JOIN</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> od
<span class="kw">ON</span> od.SalesOrderID = oh.SalesOrderID
<span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> p
<span class="kw">ON</span> od.ProductID = p.ProductID
<span class="kw">ORDER</span> <span class="kw">BY</span> oh.OrderDate, oh.SalesOrderID, od.SalesOrderDetailID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-27">Table 1.18: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">OrderDate</th>
<th align="left">SalesOrderNumber</th>
<th align="left">ProductName</th>
<th align="right">OrderQty</th>
<th align="right">UnitPrice</th>
<th align="right">LineTotal</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2008-06-01</td>
<td align="left">SO71774</td>
<td align="left">ML Road Frame-W - Yellow, 48</td>
<td align="right">1</td>
<td align="right">356.898</td>
<td align="right">356.8980</td>
</tr>
<tr class="even">
<td align="left">2008-06-01</td>
<td align="left">SO71774</td>
<td align="left">ML Road Frame-W - Yellow, 38</td>
<td align="right">1</td>
<td align="right">356.898</td>
<td align="right">356.8980</td>
</tr>
<tr class="odd">
<td align="left">2008-06-01</td>
<td align="left">SO71776</td>
<td align="left">Rear Brakes</td>
<td align="right">1</td>
<td align="right">63.900</td>
<td align="right">63.9000</td>
</tr>
<tr class="even">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">ML Mountain Frame-W - Silver, 42</td>
<td align="right">4</td>
<td align="right">218.454</td>
<td align="right">873.8160</td>
</tr>
<tr class="odd">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">Mountain-400-W Silver, 46</td>
<td align="right">2</td>
<td align="right">461.694</td>
<td align="right">923.3880</td>
</tr>
<tr class="even">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">Mountain-500 Silver, 52</td>
<td align="right">6</td>
<td align="right">112.998</td>
<td align="right">406.7928</td>
</tr>
<tr class="odd">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">HL Mountain Frame - Silver, 38</td>
<td align="right">2</td>
<td align="right">818.700</td>
<td align="right">1637.4000</td>
</tr>
<tr class="even">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">Mountain-500 Black, 42</td>
<td align="right">1</td>
<td align="right">323.994</td>
<td align="right">323.9940</td>
</tr>
<tr class="odd">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">LL Mountain Frame - Black, 48</td>
<td align="right">1</td>
<td align="right">149.874</td>
<td align="right">149.8740</td>
</tr>
<tr class="even">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">HL Mountain Frame - Black, 42</td>
<td align="right">1</td>
<td align="right">809.760</td>
<td align="right">809.7600</td>
</tr>
</tbody>
</table>
</div>
<p>It is possible to do joins based on more than one criteria, e.g. we could join based on the productID and where the ListPrice is less than the unitprice i.e. there has been a discount.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- Multiple join predicates</span>
<span class="kw">SELECT</span> oh.OrderDate, oh.SalesOrderNumber, p.Name <span class="kw">As</span> ProductName, od.OrderQty, od.UnitPrice, od.LineTotal
<span class="kw">FROM</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> oh
<span class="kw">JOIN</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> od
<span class="kw">ON</span> od.SalesOrderID = oh.SalesOrderID
<span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> p
<span class="kw">ON</span> od.ProductID = p.ProductID <span class="kw">AND</span> od.UnitPrice &lt; p.ListPrice <span class="co">--Note multiple predicates</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> oh.OrderDate, oh.SalesOrderID, od.SalesOrderDetailID; </code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-28">Table 1.19: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">OrderDate</th>
<th align="left">SalesOrderNumber</th>
<th align="left">ProductName</th>
<th align="right">OrderQty</th>
<th align="right">UnitPrice</th>
<th align="right">LineTotal</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2008-06-01</td>
<td align="left">SO71774</td>
<td align="left">ML Road Frame-W - Yellow, 48</td>
<td align="right">1</td>
<td align="right">356.898</td>
<td align="right">356.8980</td>
</tr>
<tr class="even">
<td align="left">2008-06-01</td>
<td align="left">SO71774</td>
<td align="left">ML Road Frame-W - Yellow, 38</td>
<td align="right">1</td>
<td align="right">356.898</td>
<td align="right">356.8980</td>
</tr>
<tr class="odd">
<td align="left">2008-06-01</td>
<td align="left">SO71776</td>
<td align="left">Rear Brakes</td>
<td align="right">1</td>
<td align="right">63.900</td>
<td align="right">63.9000</td>
</tr>
<tr class="even">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">ML Mountain Frame-W - Silver, 42</td>
<td align="right">4</td>
<td align="right">218.454</td>
<td align="right">873.8160</td>
</tr>
<tr class="odd">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">Mountain-400-W Silver, 46</td>
<td align="right">2</td>
<td align="right">461.694</td>
<td align="right">923.3880</td>
</tr>
<tr class="even">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">Mountain-500 Silver, 52</td>
<td align="right">6</td>
<td align="right">112.998</td>
<td align="right">406.7928</td>
</tr>
<tr class="odd">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">HL Mountain Frame - Silver, 38</td>
<td align="right">2</td>
<td align="right">818.700</td>
<td align="right">1637.4000</td>
</tr>
<tr class="even">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">Mountain-500 Black, 42</td>
<td align="right">1</td>
<td align="right">323.994</td>
<td align="right">323.9940</td>
</tr>
<tr class="odd">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">LL Mountain Frame - Black, 48</td>
<td align="right">1</td>
<td align="right">149.874</td>
<td align="right">149.8740</td>
</tr>
<tr class="even">
<td align="left">2008-06-01</td>
<td align="left">SO71780</td>
<td align="left">HL Mountain Frame - Black, 42</td>
<td align="right">1</td>
<td align="right">809.760</td>
<td align="right">809.7600</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outer-joins" class="section level3">
<h3><span class="header-section-number">1.3.2</span> OUTER Joins</h3>
<p>In an outer join we return all the rows from one table, and any matching rows from the second table. The records in the ‘outer’ table are preserved, typically we use language such as LEFT, RIGHT and FULL keywords. We are pulling in records from that OUTER table. FULL keeps records from both tables, but are typically not seen in practice. OUTER is OPTIONAL e.g. LEFT JOIN is the same as LEFT OUTER JOIN.</p>
<p>Now some examples. First, we bring up a list of customers, with any matching sales records i.e. we have a list of customers who HAVE bought someting and those WHO HAVE NOT.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">--Get all customers, with sales orders for those who&#39;ve bought anything</span>
<span class="kw">SELECT</span> c.FirstName, c.LastName, oh.SalesOrderNumber
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> oh
<span class="kw">ON</span> c.CustomerID = oh.CustomerID
<span class="kw">ORDER</span> <span class="kw">BY</span> c.CustomerID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-29">Table 1.20: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">FirstName</th>
<th align="left">LastName</th>
<th align="left">SalesOrderNumber</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Orlando</td>
<td align="left">Gee</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Keith</td>
<td align="left">Harris</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Donna</td>
<td align="left">Carreras</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Janet</td>
<td align="left">Gates</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Lucy</td>
<td align="left">Harrington</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Rosmarie</td>
<td align="left">Carroll</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Dominic</td>
<td align="left">Gash</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Kathleen</td>
<td align="left">Garza</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Katherine</td>
<td align="left">Harding</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Johnny</td>
<td align="left">Caprio</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
<p>Next we can look just for those customers who have not purchased anything using IS NULL.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">--Return only customers who haven&#39;t purchased anything</span>
<span class="kw">SELECT</span> c.FirstName, c.LastName, oh.SalesOrderNumber
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> oh
<span class="kw">ON</span> c.CustomerID = oh.CustomerID
<span class="kw">WHERE</span> oh.SalesOrderNumber <span class="kw">IS</span> <span class="kw">NULL</span> 
<span class="kw">ORDER</span> <span class="kw">BY</span> c.CustomerID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-30">Table 1.21: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">FirstName</th>
<th align="left">LastName</th>
<th align="left">SalesOrderNumber</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Orlando</td>
<td align="left">Gee</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Keith</td>
<td align="left">Harris</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Donna</td>
<td align="left">Carreras</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Janet</td>
<td align="left">Gates</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Lucy</td>
<td align="left">Harrington</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Rosmarie</td>
<td align="left">Carroll</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Dominic</td>
<td align="left">Gash</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Kathleen</td>
<td align="left">Garza</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Katherine</td>
<td align="left">Harding</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Johnny</td>
<td align="left">Caprio</td>
<td align="left">NA</td>
</tr>
</tbody>
</table>
</div>
<p>Next we add records from multiple tables. If we add tables on to the chain of tables, having first decleared a left or right join, you have to keep using LEFT joins. You could use an INNER Join but you would loose some records e.g. if you used an INNER join on the second table below, you would loose those records (products) that had never been sold.</p>
<p>Sometimes it is neccessary to go through one table to get to another e.g. to Products -&gt; Orders requires going through order details first. Even if, we are not brining back any tables from the intermediary table.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">--More than 2 tables</span>
<span class="kw">SELECT</span> p.Name <span class="kw">As</span> ProductName, oh.SalesOrderNumber
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> p
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> od
<span class="kw">ON</span> p.ProductID = od.ProductID
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> oh <span class="co">--Additional tables added to the right must also use a left join</span>
<span class="kw">ON</span> od.SalesOrderID = oh.SalesOrderID
<span class="kw">ORDER</span> <span class="kw">BY</span> p.ProductID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-31">Table 1.22: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ProductName</th>
<th align="left">SalesOrderNumber</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HL Road Frame - Black, 58</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 58</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">SO71782</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">SO71783</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">SO71784</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">SO71797</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">SO71902</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">SO71936</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">SO71938</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Black</td>
<td align="left">SO71782</td>
</tr>
</tbody>
</table>
</div>
<p>Next another example with multiple tables, but this time the order of the tables is different. We SELECT from the product table, then we LEFT Join the Order details so we can identify products that have never sold, then we LEFT JOIN to the order header table so we can get the order number where we use a left outer join as we are left joining those records to our original table. Then we INNER Join product category, because we are joining product category back to the first table - Products. The final table joins back to our original table, before the outer joins. So whether you need to use an OUTER or INNER join depends on where you wish to place the records based on the current list of tables, however you could reorder the tables to do it differently e.g. do the INNER JOIN first, then then LEFT JOINS.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> p.Name <span class="kw">As</span> ProductName, c.Name <span class="kw">AS</span> <span class="kw">Category</span>, oh.SalesOrderNumber
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> p
<span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> od
<span class="kw">ON</span> p.ProductID = od.ProductID
<span class="kw">LEFT</span> <span class="kw">OUTER</span> <span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> oh
<span class="kw">ON</span> od.SalesOrderID = oh.SalesOrderID
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.ProductCategory <span class="kw">AS</span> c <span class="co">--Added to the left, so can use inner join</span>
<span class="kw">ON</span> p.ProductCategoryID = c.ProductCategoryID
<span class="kw">ORDER</span> <span class="kw">BY</span> p.ProductID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-32">Table 1.23: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ProductName</th>
<th align="left">Category</th>
<th align="left">SalesOrderNumber</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HL Road Frame - Black, 58</td>
<td align="left">Road Frames</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 58</td>
<td align="left">Road Frames</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">Helmets</td>
<td align="left">SO71782</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">Helmets</td>
<td align="left">SO71783</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">Helmets</td>
<td align="left">SO71784</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">Helmets</td>
<td align="left">SO71797</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">Helmets</td>
<td align="left">SO71902</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">Helmets</td>
<td align="left">SO71936</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">Helmets</td>
<td align="left">SO71938</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Black</td>
<td align="left">Helmets</td>
<td align="left">SO71782</td>
</tr>
</tbody>
</table>
</div>
<p>** Key Points**</p>
<ul>
<li>Use a Left Outer Join to include all rows from the first table and values from matched rows in the second table. Columns in the second table for which no matching rows exist are populated with NULLs.</li>
<li>Use a Right Outer Join to include all rows from the second table and values from matched rows in the first table. Columns in the first table for which no matching rows exist are populated with NULLs.</li>
<li>Use a Full Outer Join to include all rows from the first and second tables. Columns in the either table for which no matching rows exist are populated with NULLs.</li>
</ul>
</div>
<div id="cross-joins" class="section level3">
<h3><span class="header-section-number">1.3.3</span> Cross Joins</h3>
<p>Cross Joins create caretesian products - they combine each row from the first table with each row from the second table - to give all possible combinations of products.</p>
<p>One example of it being used would be if we have a list of staff with their attributes, we might want to compare them to the attributes required for all jobs to see which they match, perhaps as an internal job search. Another example is if we have two list of addresses and we calculate the edit distance between the two addresses from the different sources, to try and match those addresses. We would rank the addresses based on their edit distance, with those scoring highest the closest and most likely to be the same address. It can be used to generate test data also.</p>
<p>An example</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">--Call each customer once per product - perhaps not the most realistic example!</span>
<span class="kw">SELECT</span> p.Name, c.FirstName, c.LastName, c.Phone
<span class="kw">FROM</span> SalesLT.Product <span class="kw">as</span> p
<span class="kw">CROSS</span> <span class="kw">JOIN</span> SalesLT.Customer <span class="kw">as</span> c;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-33">Table 1.24: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">FirstName</th>
<th align="left">LastName</th>
<th align="left">Phone</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">All-Purpose Bike Stand</td>
<td align="left">Orlando</td>
<td align="left">Gee</td>
<td align="left">245-555-0173</td>
</tr>
<tr class="even">
<td align="left">All-Purpose Bike Stand</td>
<td align="left">Keith</td>
<td align="left">Harris</td>
<td align="left">170-555-0127</td>
</tr>
<tr class="odd">
<td align="left">All-Purpose Bike Stand</td>
<td align="left">Donna</td>
<td align="left">Carreras</td>
<td align="left">279-555-0130</td>
</tr>
<tr class="even">
<td align="left">All-Purpose Bike Stand</td>
<td align="left">Janet</td>
<td align="left">Gates</td>
<td align="left">710-555-0173</td>
</tr>
<tr class="odd">
<td align="left">All-Purpose Bike Stand</td>
<td align="left">Lucy</td>
<td align="left">Harrington</td>
<td align="left">828-555-0186</td>
</tr>
<tr class="even">
<td align="left">All-Purpose Bike Stand</td>
<td align="left">Rosmarie</td>
<td align="left">Carroll</td>
<td align="left">244-555-0112</td>
</tr>
<tr class="odd">
<td align="left">All-Purpose Bike Stand</td>
<td align="left">Dominic</td>
<td align="left">Gash</td>
<td align="left">192-555-0173</td>
</tr>
<tr class="even">
<td align="left">All-Purpose Bike Stand</td>
<td align="left">Kathleen</td>
<td align="left">Garza</td>
<td align="left">150-555-0127</td>
</tr>
<tr class="odd">
<td align="left">All-Purpose Bike Stand</td>
<td align="left">Katherine</td>
<td align="left">Harding</td>
<td align="left">926-555-0159</td>
</tr>
<tr class="even">
<td align="left">All-Purpose Bike Stand</td>
<td align="left">Johnny</td>
<td align="left">Caprio</td>
<td align="left">112-555-0191</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="self-joins" class="section level3">
<h3><span class="header-section-number">1.3.4</span> Self Joins</h3>
<p>You might want to join data on to itself but in a different sequence. For instance, we might want to join a person’s manager on to their employee(s), but managers are also employees, so this would be a self join. We would use aliases for the table names as we have the same table twice. So when defining a self-join, you must specify an alias for at least one instance of the table being joined.</p>
<p>So our original table looks like this:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> *
<span class="kw">FROM</span> SalesLT.Employee;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-34">Table 1.25: </span>9 records</caption>
<thead>
<tr class="header">
<th align="left">EmployeeID</th>
<th align="left">EmployeeName</th>
<th align="right">ManagerID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">adventure-works8</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">adventure-works1</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">adventure-works0</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">adventure-works0</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">adventure-works1</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">adventure-works3</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="left">adventure-works9</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="left">adventure-works0</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="left">adventure-works0</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
</div>
<p>Then the actual self join query - we use a left join as some people i.e. the CEO, will not have a manager.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> e.EmployeeName, m.EmployeeName <span class="kw">AS</span> ManagerName
<span class="kw">FROM</span> SalesLT.Employee <span class="kw">AS</span> e
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.Employee <span class="kw">AS</span> m
<span class="kw">ON</span> e.ManagerID = m.EmployeeID
<span class="kw">ORDER</span> <span class="kw">BY</span> e.ManagerID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-35">Table 1.26: </span>9 records</caption>
<thead>
<tr class="header">
<th align="left">EmployeeName</th>
<th align="left">ManagerName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">adventure-works1</td>
<td align="left">adventure-works8</td>
</tr>
<tr class="odd">
<td align="left">adventure-works1</td>
<td align="left">adventure-works8</td>
</tr>
<tr class="even">
<td align="left">adventure-works3</td>
<td align="left">adventure-works0</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">adventure-works0</td>
</tr>
<tr class="even">
<td align="left">adventure-works0</td>
<td align="left">adventure-works0</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">adventure-works0</td>
</tr>
<tr class="even">
<td align="left">adventure-works8</td>
<td align="left">adventure-works0</td>
</tr>
<tr class="odd">
<td align="left">adventure-works9</td>
<td align="left">adventure-works0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="lab-exercises-2" class="section level3">
<h3><span class="header-section-number">1.3.5</span> Lab Exercises</h3>
<p>Write a query that returns the company name from the Sale.Customer table, the sales order ID and total due from the SalesLT.SalesOrderHeader table.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- select the CompanyName, SalesOrderId, and TotalDue columns from the appropriate tables</span>
<span class="kw">SELECT</span> c.CompanyName, oh.SalesOrderId, oh.TotalDue
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> oh
<span class="co">-- join tables based on CustomerID</span>
<span class="kw">ON</span> c.CustomerID = oh.CustomerID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-36">Table 1.27: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
<th align="right">SalesOrderId</th>
<th align="right">TotalDue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Professional Sales and Service</td>
<td align="right">71782</td>
<td align="right">43962.7901</td>
</tr>
<tr class="even">
<td align="left">Remarkable Bike Store</td>
<td align="right">71935</td>
<td align="right">7330.8972</td>
</tr>
<tr class="odd">
<td align="left">Bulk Discount Store</td>
<td align="right">71938</td>
<td align="right">98138.2131</td>
</tr>
<tr class="even">
<td align="left">Coalition Bike Company</td>
<td align="right">71899</td>
<td align="right">2669.3183</td>
</tr>
<tr class="odd">
<td align="left">Futuristic Bikes</td>
<td align="right">71895</td>
<td align="right">272.6468</td>
</tr>
<tr class="even">
<td align="left">Channel Outlet</td>
<td align="right">71885</td>
<td align="right">608.1766</td>
</tr>
<tr class="odd">
<td align="left">Aerobic Exercise Company</td>
<td align="right">71915</td>
<td align="right">2361.6403</td>
</tr>
<tr class="even">
<td align="left">Vigorous Sports Store</td>
<td align="right">71867</td>
<td align="right">1170.5376</td>
</tr>
<tr class="odd">
<td align="left">Thrilling Bike Tours</td>
<td align="right">71858</td>
<td align="right">15275.1977</td>
</tr>
<tr class="even">
<td align="left">Extreme Riding Supplies</td>
<td align="right">71796</td>
<td align="right">63686.2708</td>
</tr>
</tbody>
</table>
</div>
<p>In order to send out invoices to the customers, we need their addresses. Extend your customer orders query to include the main office address for each customer, including the full street address, city, state or province, postal code, and country or region.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.CompanyName, a.AddressLine1, ISNULL(a.AddressLine2, <span class="st">&#39;&#39;</span>) <span class="kw">AS</span> AddressLine2, a.City, a.StateProvince, a.PostalCode, a.CountryRegion, oh.SalesOrderID, oh.TotalDue
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="co">-- join the SalesOrderHeader table</span>
<span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> oh
<span class="kw">ON</span> oh.CustomerID = c.CustomerID
<span class="co">-- join the CustomerAddress table</span>
<span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="co">-- filter for where the AddressType is &#39;Main Office&#39;</span>
<span class="kw">ON</span> c.CustomerID = ca.CustomerID <span class="kw">AND</span> AddressType = <span class="st">&#39;Main Office&#39;</span>
<span class="kw">JOIN</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">ON</span> ca.AddressID = a.AddressID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-37">Table 1.28: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
<th align="left">AddressLine1</th>
<th align="left">AddressLine2</th>
<th align="left">City</th>
<th align="left">StateProvince</th>
<th align="left">PostalCode</th>
<th align="left">CountryRegion</th>
<th align="right">SalesOrderID</th>
<th align="right">TotalDue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Good Toys</td>
<td align="left">99700 Bell Road</td>
<td align="left"></td>
<td align="left">Auburn</td>
<td align="left">California</td>
<td align="left">95603</td>
<td align="left">United States</td>
<td align="right">71774</td>
<td align="right">972.7850</td>
</tr>
<tr class="even">
<td align="left">West Side Mart</td>
<td align="left">251 The Metro Center</td>
<td align="left"></td>
<td align="left">Wokingham</td>
<td align="left">England</td>
<td align="left">RG41 1QW</td>
<td align="left">United Kingdom</td>
<td align="right">71776</td>
<td align="right">87.0851</td>
</tr>
<tr class="odd">
<td align="left">Nearby Cycle Shop</td>
<td align="left">Burgess Hill</td>
<td align="left">Edward Way</td>
<td align="left">West Sussex</td>
<td align="left">England</td>
<td align="left">RH15 9UD</td>
<td align="left">United Kingdom</td>
<td align="right">71780</td>
<td align="right">42452.6519</td>
</tr>
<tr class="even">
<td align="left">Professional Sales and Service</td>
<td align="left">57251 Serene Blvd</td>
<td align="left"></td>
<td align="left">Van Nuys</td>
<td align="left">California</td>
<td align="left">91411</td>
<td align="left">United States</td>
<td align="right">71782</td>
<td align="right">43962.7901</td>
</tr>
<tr class="odd">
<td align="left">Eastside Department Store</td>
<td align="left">9992 Whipple Rd</td>
<td align="left"></td>
<td align="left">Union City</td>
<td align="left">California</td>
<td align="left">94587</td>
<td align="left">United States</td>
<td align="right">71783</td>
<td align="right">92663.5609</td>
</tr>
<tr class="even">
<td align="left">Action Bicycle Specialists</td>
<td align="left">Warrington Ldc Unit 25/2</td>
<td align="left"></td>
<td align="left">Woolston</td>
<td align="left">England</td>
<td align="left">WA1 4SY</td>
<td align="left">United Kingdom</td>
<td align="right">71784</td>
<td align="right">119960.8240</td>
</tr>
<tr class="odd">
<td align="left">Extreme Riding Supplies</td>
<td align="left">Riverside</td>
<td align="left"></td>
<td align="left">Sherman Oaks</td>
<td align="left">California</td>
<td align="left">91403</td>
<td align="left">United States</td>
<td align="right">71796</td>
<td align="right">63686.2708</td>
</tr>
<tr class="even">
<td align="left">Riding Cycles</td>
<td align="left">Galashiels</td>
<td align="left"></td>
<td align="left">Liverpool</td>
<td align="left">England</td>
<td align="left">L4 4HB</td>
<td align="left">United Kingdom</td>
<td align="right">71797</td>
<td align="right">86222.8072</td>
</tr>
<tr class="odd">
<td align="left">Thrifty Parts and Sales</td>
<td align="left">Oxnard Outlet</td>
<td align="left"></td>
<td align="left">Oxnard</td>
<td align="left">California</td>
<td align="left">93030</td>
<td align="left">United States</td>
<td align="right">71815</td>
<td align="right">1261.4440</td>
</tr>
<tr class="even">
<td align="left">Engineered Bike Systems</td>
<td align="left">123 Camelia Avenue</td>
<td align="left"></td>
<td align="left">Oxnard</td>
<td align="left">California</td>
<td align="left">93030</td>
<td align="left">United States</td>
<td align="right">71816</td>
<td align="right">3754.9733</td>
</tr>
</tbody>
</table>
</div>
<p>The sales manager wants a list of all customer companies and their contacts (first name and last name), showing the sales order ID and total due for each order they have placed. Customers who have not placed any orders should be included at the bottom of the list with NULL values for the order ID and total due.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- select the CompanyName, FirstName, LastName, SalesOrderID and TotalDue columns</span>
<span class="co">-- from the appropriate tables</span>
<span class="kw">SELECT</span> c.CompanyName, c.FirstName, c.LastName, oh.SalesOrderID, oh.TotalDue
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> oh
<span class="co">-- join based on CustomerID</span>
<span class="kw">ON</span> oh.CustomerID  = c.CustomerID
<span class="co">-- order the SalesOrderIDs from highest to lowest</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> oh.SalesOrderID <span class="kw">DESC</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-38">Table 1.29: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
<th align="left">FirstName</th>
<th align="left">LastName</th>
<th align="right">SalesOrderID</th>
<th align="right">TotalDue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Central Bicycle Specialists</td>
<td align="left">Janeth</td>
<td align="left">Esteves</td>
<td align="right">71946</td>
<td align="right">43.0437</td>
</tr>
<tr class="even">
<td align="left">Bulk Discount Store</td>
<td align="left">Christopher</td>
<td align="left">Beck</td>
<td align="right">71938</td>
<td align="right">98138.2131</td>
</tr>
<tr class="odd">
<td align="left">Metropolitan Bicycle Supply</td>
<td align="left">Krishna</td>
<td align="left">Sunkammurali</td>
<td align="right">71936</td>
<td align="right">108597.9536</td>
</tr>
<tr class="even">
<td align="left">Remarkable Bike Store</td>
<td align="left">Cory</td>
<td align="left">Booth</td>
<td align="right">71935</td>
<td align="right">7330.8972</td>
</tr>
<tr class="odd">
<td align="left">The Bicycle Accessories Company</td>
<td align="left">Guy</td>
<td align="left">Gilbert</td>
<td align="right">71923</td>
<td align="right">117.7276</td>
</tr>
<tr class="even">
<td align="left">Discount Tours</td>
<td align="left">Melissa</td>
<td align="left">Marple</td>
<td align="right">71920</td>
<td align="right">3293.7761</td>
</tr>
<tr class="odd">
<td align="left">Essential Bike Works</td>
<td align="left">Linda</td>
<td align="left">Mitchell</td>
<td align="right">71917</td>
<td align="right">45.1995</td>
</tr>
<tr class="even">
<td align="left">Aerobic Exercise Company</td>
<td align="left">Rosmarie</td>
<td align="left">Carroll</td>
<td align="right">71915</td>
<td align="right">2361.6403</td>
</tr>
<tr class="odd">
<td align="left">Many Bikes Store</td>
<td align="left">Jeffrey</td>
<td align="left">Kurtz</td>
<td align="right">71902</td>
<td align="right">81834.9826</td>
</tr>
<tr class="even">
<td align="left">Coalition Bike Company</td>
<td align="left">Donald</td>
<td align="left">Blanton</td>
<td align="right">71899</td>
<td align="right">2669.3183</td>
</tr>
</tbody>
</table>
</div>
<p>A sales employee has noticed that AdventureWorks does not have address information for all customers. Write a query that returns a list of customer IDs, company names, contact names (first name and last name), and phone numbers for customers with no address stored in the database.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.CompanyName, c.FirstName, c.LastName, c.Phone
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="co">-- join based on CustomerID</span>
<span class="kw">ON</span> c.CustomerID = ca.CustomerID
<span class="co">-- filter for when the AddressID doesn&#39;t exist</span>
<span class="kw">WHERE</span> ca.AddressID <span class="kw">IS</span> <span class="kw">NULL</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-39">Table 1.30: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
<th align="left">FirstName</th>
<th align="left">LastName</th>
<th align="left">Phone</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">A Bike Store</td>
<td align="left">Orlando</td>
<td align="left">Gee</td>
<td align="left">245-555-0173</td>
</tr>
<tr class="even">
<td align="left">Progressive Sports</td>
<td align="left">Keith</td>
<td align="left">Harris</td>
<td align="left">170-555-0127</td>
</tr>
<tr class="odd">
<td align="left">Advanced Bike Components</td>
<td align="left">Donna</td>
<td align="left">Carreras</td>
<td align="left">279-555-0130</td>
</tr>
<tr class="even">
<td align="left">Modular Cycle Systems</td>
<td align="left">Janet</td>
<td align="left">Gates</td>
<td align="left">710-555-0173</td>
</tr>
<tr class="odd">
<td align="left">Metropolitan Sports Supply</td>
<td align="left">Lucy</td>
<td align="left">Harrington</td>
<td align="left">828-555-0186</td>
</tr>
<tr class="even">
<td align="left">Aerobic Exercise Company</td>
<td align="left">Rosmarie</td>
<td align="left">Carroll</td>
<td align="left">244-555-0112</td>
</tr>
<tr class="odd">
<td align="left">Associated Bikes</td>
<td align="left">Dominic</td>
<td align="left">Gash</td>
<td align="left">192-555-0173</td>
</tr>
<tr class="even">
<td align="left">Rural Cycle Emporium</td>
<td align="left">Kathleen</td>
<td align="left">Garza</td>
<td align="left">150-555-0127</td>
</tr>
<tr class="odd">
<td align="left">Sharp Bikes</td>
<td align="left">Katherine</td>
<td align="left">Harding</td>
<td align="left">926-555-0159</td>
</tr>
<tr class="even">
<td align="left">Bikes and Motorbikes</td>
<td align="left">Johnny</td>
<td align="left">Caprio</td>
<td align="left">112-555-0191</td>
</tr>
</tbody>
</table>
</div>
<p>Some customers have never placed orders, and some products have never been ordered.</p>
<p>Write a query that returns a column of customer IDs for customers who have never placed an order, and a column of product IDs for products that have never been ordered.</p>
<p>Each row with a customer ID should have a NULL product ID (because the customer has never ordered a product) and each row with a product ID should have a NULL customer ID (because the product has never been ordered by a customer).</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.CustomerID, p.ProductID
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">FULL</span> <span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> oh
<span class="kw">ON</span> c.CustomerID = oh.CustomerID
<span class="kw">FULL</span> <span class="kw">JOIN</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> od
<span class="co">-- join based on the SalesOrderID</span>
<span class="kw">ON</span> od.SalesOrderID = oh.SalesOrderID
<span class="kw">FULL</span> <span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> p
<span class="co">-- join based on the ProductID</span>
<span class="kw">ON</span> p.ProductID = od.ProductID
<span class="co">-- filter for nonexistent SalesOrderIDs</span>
<span class="kw">WHERE</span> oh.SalesOrderID <span class="kw">IS</span> <span class="kw">NULL</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> ProductID, CustomerID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-40">Table 1.31: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">CustomerID</th>
<th align="right">ProductID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">11</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">12</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="using-set-operators" class="section level2">
<h2><span class="header-section-number">1.4</span> Using Set Operators</h2>
<p>A union query is unlike a join, where as a join adds more columns, a union typically adds more rows. You put all records from one query on to the records at the end of another query. NOTE that it is a list of distinct (non duplicate) records - this will be checked every single row in one table and then checks if that record exists across every single row in the other table. Obviously as more tables are added, checking this can become more time consuming and affects performance.</p>
<p>UNION ALL will not undertake this checking, leading to more performance, but some duplicates. John Smith may appear in the employees table but he may also appear in the customers table. Sometimes this is the desired result. In such an instance it makes sense to add a new field using an alias at the time of ther query, such as record type, so we know where this record occurs.</p>
<p>When using Union:</p>
<ul>
<li>It is a good idea to use column aliases, so we know which table the column occurs in. However, only aliases in the first query are recognised, so any aliases should be set against the first table</li>
<li>The number of columns must be the same across tables, you can add an additional column but this must be given a specific value or a NULL</li>
<li>The data types must be approximatley similar i.e. we can do an implicit or explict conversion so they match.</li>
</ul>
<p>The following example joins the Employees to the customer using Union i.e. removing duplicates.</p>
<p>NOTE: In the following example, views were created (using code provided in the course), before running the queries on the database. Therefore to reproduce these results, it is neccessary to run that same code (Module 4, Union sql file, in the CourseFiles zip) before the following queries will run on the AdventureWorksLT db.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> FirstName, LastName
<span class="kw">FROM</span> SalesLT.Employees
<span class="kw">UNION</span>
<span class="kw">SELECT</span> FirstName, LastName
<span class="kw">FROM</span> SalesLT.Customers
<span class="kw">ORDER</span> <span class="kw">BY</span> LastName;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-41">Table 1.32: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">FirstName</th>
<th align="left">LastName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Catherine</td>
<td align="left">Abel</td>
</tr>
<tr class="even">
<td align="left">Kim</td>
<td align="left">Abercrombie</td>
</tr>
<tr class="odd">
<td align="left">Frances</td>
<td align="left">Adams</td>
</tr>
<tr class="even">
<td align="left">Jay</td>
<td align="left">Adams</td>
</tr>
<tr class="odd">
<td align="left">Samuel</td>
<td align="left">Agcaoili</td>
</tr>
<tr class="even">
<td align="left">Robert</td>
<td align="left">Ahlering</td>
</tr>
<tr class="odd">
<td align="left">Stanley</td>
<td align="left">Alan</td>
</tr>
<tr class="even">
<td align="left">Amy</td>
<td align="left">Alberts</td>
</tr>
<tr class="odd">
<td align="left">Paul</td>
<td align="left">Alcorn</td>
</tr>
<tr class="even">
<td align="left">Gregory</td>
<td align="left">Alderson</td>
</tr>
</tbody>
</table>
</div>
<p>This gives 440 rows, if however we use UNION ALL</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> FirstName, LastName
<span class="kw">FROM</span> SalesLT.Employees
<span class="kw">UNION</span> <span class="kw">ALL</span>
<span class="kw">SELECT</span> FirstName, LastName
<span class="kw">FROM</span> SalesLT.Customers
<span class="kw">ORDER</span> <span class="kw">BY</span> LastName;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-42">Table 1.33: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">FirstName</th>
<th align="left">LastName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Catherine</td>
<td align="left">Abel</td>
</tr>
<tr class="even">
<td align="left">Kim</td>
<td align="left">Abercrombie</td>
</tr>
<tr class="odd">
<td align="left">Frances</td>
<td align="left">Adams</td>
</tr>
<tr class="even">
<td align="left">Jay</td>
<td align="left">Adams</td>
</tr>
<tr class="odd">
<td align="left">Samuel</td>
<td align="left">Agcaoili</td>
</tr>
<tr class="even">
<td align="left">Robert</td>
<td align="left">Ahlering</td>
</tr>
<tr class="odd">
<td align="left">Stanley</td>
<td align="left">Alan</td>
</tr>
<tr class="even">
<td align="left">Amy</td>
<td align="left">Alberts</td>
</tr>
<tr class="odd">
<td align="left">Paul</td>
<td align="left">Alcorn</td>
</tr>
<tr class="even">
<td align="left">Gregory</td>
<td align="left">Alderson</td>
</tr>
</tbody>
</table>
</div>
<p>This results in 441 rows, so there is 1 row which occurs in both - a Donna Carreras appears both in the customer and emplyee table. This could be the same person or indeed just someone with the same name.</p>
<p>It might be useful to know which table the record occurs in, which is where we can introduce a Type column. Not that after the first alias AS Type, subsequent fields e.g. ‘Customer’ as shown below do not need to be explicitly aliased, however it can make it easier to understand if we do include the AS Type.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> FirstName, LastName, <span class="st">&#39;Employee&#39;</span> <span class="kw">AS</span> <span class="kw">Type</span>
<span class="kw">FROM</span> SalesLT.Employees
<span class="kw">UNION</span> 
<span class="kw">SELECT</span> FirstName, LastName, <span class="st">&#39;Customer&#39;</span> <span class="kw">AS</span> <span class="kw">Type</span>
<span class="kw">FROM</span> SalesLT.Customers
<span class="kw">ORDER</span> <span class="kw">BY</span> LastName
OFFSET <span class="dv">100</span> <span class="kw">ROWS</span> FETCH <span class="kw">NEXT</span> <span class="dv">5</span> <span class="kw">ROWS</span> <span class="kw">ONLY</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-43">Table 1.34: </span>5 records</caption>
<thead>
<tr class="header">
<th align="left">FirstName</th>
<th align="left">LastName</th>
<th align="left">Type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Andy</td>
<td align="left">Carothers</td>
<td align="left">Employee</td>
</tr>
<tr class="even">
<td align="left">Donna</td>
<td align="left">Carreras</td>
<td align="left">Customer</td>
</tr>
<tr class="odd">
<td align="left">Donna</td>
<td align="left">Carreras</td>
<td align="left">Employee</td>
</tr>
<tr class="even">
<td align="left">Rosmarie</td>
<td align="left">Carroll</td>
<td align="left">Employee</td>
</tr>
<tr class="odd">
<td align="left">Joseph</td>
<td align="left">Castellucio</td>
<td align="left">Employee</td>
</tr>
</tbody>
</table>
</div>
<p>Note that even though we have used UNION rather than UNION ALL, this would result in the same number of rows as UNION ALL (441), because the presence of the type column means this is no longer the same person - it is not a duplicate record but a unique one. However, it is worth using UNION ALL to limit the number of records that have to be checked for duplicates, so improving peformance.</p>
<p><strong>By default, UNION eliminates duplicate rows. Specify the ALL option to include duplicates (or to avoid the overhead of checking for duplicates when you know in advance that there are none).</strong></p>
<div id="intersect-and-except-queries" class="section level3">
<h3><span class="header-section-number">1.4.1</span> INTERSECT and EXCEPT Queries</h3>
<p>In INTERSECT we look at only rows that appear in each set - we are looking for the duplicates. Whereas using a JOIN would append columns to the source table, in set theory, we are looking for rows, so in an INTERSECT we are looking for those rows that appear in both datasets.</p>
<p>IN EXCEPT we are looking for records that appear in one source but not the other. In such a scenario, the order of the tables matters.</p>
<p>If we now try and identify the person who appears in both our datasets, we can identify the person directly.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> FirstName, LastName
<span class="kw">FROM</span> SalesLT.Customers
<span class="kw">INTERSECT</span>
<span class="kw">SELECT</span> FirstName, LastName
<span class="kw">FROM</span> SalesLT.Employees;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-44">Table 1.35: </span>1 records</caption>
<thead>
<tr class="header">
<th align="left">FirstName</th>
<th align="left">LastName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Donna</td>
<td align="left">Carreras</td>
</tr>
</tbody>
</table>
</div>
<p>Next we want to find the EXCEPT - so let’s find customers who are not employees, so we don’t try and sel products to employees. There are 104 customers, so we should get 103 rows, as we remove Donna Carreras.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> FirstName, LastName
<span class="kw">FROM</span> SalesLT.Customers
<span class="kw">EXCEPT</span>
<span class="kw">SELECT</span> FirstName, LastName
<span class="kw">FROM</span> SalesLT.Employees;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-45">Table 1.36: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">FirstName</th>
<th align="left">LastName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Abraham</td>
<td align="left">Swearengin</td>
</tr>
<tr class="even">
<td align="left">Ajay</td>
<td align="left">Manchepalli</td>
</tr>
<tr class="odd">
<td align="left">Alan</td>
<td align="left">Steiner</td>
</tr>
<tr class="even">
<td align="left">Alice</td>
<td align="left">Steiner</td>
</tr>
<tr class="odd">
<td align="left">Andrea</td>
<td align="left">Thomsen</td>
</tr>
<tr class="even">
<td align="left">Ben</td>
<td align="left">Miller</td>
</tr>
<tr class="odd">
<td align="left">Billy</td>
<td align="left">Trent</td>
</tr>
<tr class="even">
<td align="left">Brad</td>
<td align="left">Sutton</td>
</tr>
<tr class="odd">
<td align="left">Caroline</td>
<td align="left">Vicknair</td>
</tr>
<tr class="even">
<td align="left">Cecelia</td>
<td align="left">Marshall</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="lab-exercises-3" class="section level3">
<h3><span class="header-section-number">1.4.2</span> Lab Exercises</h3>
<p>Customers can have two kinds of address: a main office address and a shipping address. The accounts department wants to ensure that the main office address is always used for billing, and have asked you to write a query that clearly identifies the different types of address for each customer.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- select the CompanyName, AddressLine1 columns</span>
<span class="co">-- alias as per the instructions</span>
<span class="kw">SELECT</span> CompanyName, AddressLine1, City, <span class="st">&#39;Billing&#39;</span> <span class="kw">AS</span> AddressType
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="co">-- join based on CustomerID</span>
<span class="kw">ON</span> c.CustomerID = ca.CustomerID
<span class="co">-- join another table</span>
<span class="kw">JOIN</span> SalesLT.Address <span class="kw">AS</span> a
<span class="co">-- join based on AddressID</span>
<span class="kw">ON</span> ca.AddressID = a.AddressID
<span class="co">-- filter for where the correct AddressType</span>
<span class="kw">WHERE</span> ca.AddressType = <span class="st">&#39;Main Office&#39;</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-46">Table 1.37: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
<th align="left">AddressLine1</th>
<th align="left">City</th>
<th align="left">AddressType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Professional Sales and Service</td>
<td align="left">57251 Serene Blvd</td>
<td align="left">Van Nuys</td>
<td align="left">Billing</td>
</tr>
<tr class="even">
<td align="left">Riders Company</td>
<td align="left">Tanger Factory</td>
<td align="left">Branch</td>
<td align="left">Billing</td>
</tr>
<tr class="odd">
<td align="left">Area Bike Accessories</td>
<td align="left">6900 Sisk Road</td>
<td align="left">Modesto</td>
<td align="left">Billing</td>
</tr>
<tr class="even">
<td align="left">Bicycle Accessories and Kits</td>
<td align="left">Lewiston Mall</td>
<td align="left">Lewiston</td>
<td align="left">Billing</td>
</tr>
<tr class="odd">
<td align="left">Valley Bicycle Specialists</td>
<td align="left">Blue Ridge Mall</td>
<td align="left">Kansas City</td>
<td align="left">Billing</td>
</tr>
<tr class="even">
<td align="left">Vinyl and Plastic Goods Corporation</td>
<td align="left">No. 25800-130 King Street West</td>
<td align="left">Toronto</td>
<td align="left">Billing</td>
</tr>
<tr class="odd">
<td align="left">Fun Toys and Bikes</td>
<td align="left">6500 East Grant Road</td>
<td align="left">Tucson</td>
<td align="left">Billing</td>
</tr>
<tr class="even">
<td align="left">Great Bikes</td>
<td align="left">Eastridge Mall</td>
<td align="left">Casper</td>
<td align="left">Billing</td>
</tr>
<tr class="odd">
<td align="left">Valley Toy Store</td>
<td align="left">252851 Rowan Place</td>
<td align="left">Richmond</td>
<td align="left">Billing</td>
</tr>
<tr class="even">
<td align="left">Major Sport Suppliers</td>
<td align="left">White Mountain Mall</td>
<td align="left">Rock Springs</td>
<td align="left">Billing</td>
</tr>
</tbody>
</table>
</div>
<p>Adapt the query to retrieve the company name, first line of the street address, city, and a column named AddressType with the value ‘Shipping’ for customers where the address type in the SalesLT.CustomerAddress table is ‘Shipping’.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.CompanyName, a.AddressLine1, a.City, <span class="st">&#39;Shipping&#39;</span> <span class="kw">AS</span> AddressType
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="kw">ON</span> c.CustomerID = ca.CustomerID
<span class="kw">JOIN</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">ON</span> ca.AddressID = a.AddressID
<span class="kw">WHERE</span> ca.AddressType = <span class="st">&#39;Shipping&#39;</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-47">Table 1.38: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
<th align="left">AddressLine1</th>
<th align="left">City</th>
<th align="left">AddressType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Family’s Favorite Bike Shop</td>
<td align="left">26910 Indela Road</td>
<td align="left">Montreal</td>
<td align="left">Shipping</td>
</tr>
<tr class="even">
<td align="left">Center Cycle Shop</td>
<td align="left">1318 Lasalle Street</td>
<td align="left">Bothell</td>
<td align="left">Shipping</td>
</tr>
<tr class="odd">
<td align="left">Safe Cycles Shop</td>
<td align="left">2681 Eagle Peak</td>
<td align="left">Bellevue</td>
<td align="left">Shipping</td>
</tr>
<tr class="even">
<td align="left">Modular Cycle Systems</td>
<td align="left">165 North Main</td>
<td align="left">Austin</td>
<td align="left">Shipping</td>
</tr>
<tr class="odd">
<td align="left">Progressive Sports</td>
<td align="left">7943 Walnut Ave</td>
<td align="left">Renton</td>
<td align="left">Shipping</td>
</tr>
<tr class="even">
<td align="left">Hardware Components</td>
<td align="left">99 Front Street</td>
<td align="left">Minneapolis</td>
<td align="left">Shipping</td>
</tr>
<tr class="odd">
<td align="left">Sample Bike Store</td>
<td align="left">2000 300th Street</td>
<td align="left">Denver</td>
<td align="left">Shipping</td>
</tr>
<tr class="even">
<td align="left">Racing Toys</td>
<td align="left">9228 Via Del Sol</td>
<td align="left">Phoenix</td>
<td align="left">Shipping</td>
</tr>
<tr class="odd">
<td align="left">Elite Bikes</td>
<td align="left">9178 Jumping St.</td>
<td align="left">Dallas</td>
<td align="left">Shipping</td>
</tr>
<tr class="even">
<td align="left">All Cycle Shop</td>
<td align="left">8713 Yosemite Ct.</td>
<td align="left">Bothell</td>
<td align="left">Shipping</td>
</tr>
</tbody>
</table>
</div>
<p>Next we can union all these records together to create a list of shipping and billing addresses, using UNION ALL.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.CompanyName, a.AddressLine1, a.City, <span class="st">&#39;Billing&#39;</span> <span class="kw">AS</span> AddressType
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="kw">ON</span> c.CustomerID = ca.CustomerID
<span class="kw">JOIN</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">ON</span> ca.AddressID = a.AddressID
<span class="kw">WHERE</span> ca.AddressType = <span class="st">&#39;Main Office&#39;</span>
<span class="co">-- UNION</span>
<span class="kw">UNION</span> <span class="kw">ALL</span>
<span class="kw">SELECT</span> c.CompanyName, a.AddressLine1, a.City, <span class="st">&#39;Shipping&#39;</span> <span class="kw">AS</span> AddressType
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="kw">ON</span> c.CustomerID = ca.CustomerID
<span class="kw">JOIN</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">ON</span> ca.AddressID = a.AddressID
<span class="kw">WHERE</span> ca.AddressType = <span class="st">&#39;Shipping&#39;</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> c.CompanyName
OFFSET <span class="dv">10</span> <span class="kw">ROWS</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-48">Table 1.39: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
<th align="left">AddressLine1</th>
<th align="left">City</th>
<th align="left">AddressType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">All Cycle Shop</td>
<td align="left">8713 Yosemite Ct.</td>
<td align="left">Bothell</td>
<td align="left">Shipping</td>
</tr>
<tr class="even">
<td align="left">All Cycle Shop</td>
<td align="left">25111 228th St Sw</td>
<td align="left">Bothell</td>
<td align="left">Billing</td>
</tr>
<tr class="odd">
<td align="left">All Seasons Sports Supply</td>
<td align="left">Ohms Road</td>
<td align="left">Houston</td>
<td align="left">Billing</td>
</tr>
<tr class="even">
<td align="left">Alpine Ski House</td>
<td align="left">7505 Laguna Boulevard</td>
<td align="left">Elk Grove</td>
<td align="left">Billing</td>
</tr>
<tr class="odd">
<td align="left">Alternative Vehicles</td>
<td align="left">3307 Evergreen Blvd</td>
<td align="left">Washougal</td>
<td align="left">Billing</td>
</tr>
<tr class="even">
<td align="left">Another Bicycle Company</td>
<td align="left">567 Sw Mcloughlin Blvd</td>
<td align="left">Milwaukie</td>
<td align="left">Billing</td>
</tr>
<tr class="odd">
<td align="left">Area Bike Accessories</td>
<td align="left">6900 Sisk Road</td>
<td align="left">Modesto</td>
<td align="left">Billing</td>
</tr>
<tr class="even">
<td align="left">Area Sheet Metal Supply</td>
<td align="left">399 Clearing Green</td>
<td align="left">London</td>
<td align="left">Billing</td>
</tr>
<tr class="odd">
<td align="left">Associated Bikes</td>
<td align="left">5420 West 22500 South</td>
<td align="left">Salt Lake City</td>
<td align="left">Billing</td>
</tr>
<tr class="even">
<td align="left">Authentic Sales and Service</td>
<td align="left">99 Dean Street, Soho</td>
<td align="left">London</td>
<td align="left">Billing</td>
</tr>
</tbody>
</table>
</div>
<p>You have created a master list of all customer addresses, but now you have been asked to create filtered lists that show which customers have only a main office address, and which customers have both a main office and a shipping address.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.CompanyName
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="kw">ON</span> c.CustomerID = ca.CustomerID
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">ON</span> a.AddressID = ca.AddressID
<span class="kw">WHERE</span> ca.AddressType = <span class="st">&#39;Main Office&#39;</span> <span class="co">--Filters out shipping addresses.  This is a table of all Billing addresses.</span>
<span class="kw">EXCEPT</span>
<span class="kw">SELECT</span> c.CompanyName
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="kw">ON</span> c.CustomerID = ca.CustomerID
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">ON</span> a.AddressID = ca.AddressID
<span class="kw">WHERE</span> ca.AddressType = <span class="st">&#39;Shipping&#39;</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> c.CompanyName;</code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">A Bike Store</td>
</tr>
<tr class="even">
<td align="left">A Great Bicycle Company</td>
</tr>
<tr class="odd">
<td align="left">A Typical Bike Shop</td>
</tr>
<tr class="even">
<td align="left">Acceptable Sales &amp; Service</td>
</tr>
<tr class="odd">
<td align="left">Action Bicycle Specialists</td>
</tr>
<tr class="even">
<td align="left">Active Life Toys</td>
</tr>
<tr class="odd">
<td align="left">Active Systems</td>
</tr>
<tr class="even">
<td align="left">Advanced Bike Components</td>
</tr>
<tr class="odd">
<td align="left">Aerobic Exercise Company</td>
</tr>
<tr class="even">
<td align="left">Affordable Sports Equipment</td>
</tr>
</tbody>
</table>
</div>
<p>Or the INTERSECT version to identify the company name of each company that appears in a table of customers with a ‘Main Office’ address, and also in a table of customers with a ‘Shipping’ address.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.CompanyName
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="kw">ON</span> c.CustomerID = ca.CustomerID
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">ON</span> a.AddressID = ca.AddressID
<span class="kw">WHERE</span> ca.AddressType = <span class="st">&#39;Main Office&#39;</span> <span class="co">--Filters out shipping addresses.  This is a table of all Billing addresses.</span>
<span class="kw">INTERSECT</span>
<span class="kw">SELECT</span> c.CompanyName
<span class="kw">FROM</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="kw">ON</span> c.CustomerID = ca.CustomerID
<span class="kw">INNER</span> <span class="kw">JOIN</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">ON</span> a.AddressID = ca.AddressID
<span class="kw">WHERE</span> ca.AddressType = <span class="st">&#39;Shipping&#39;</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> c.CompanyName;</code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">All Cycle Shop</td>
</tr>
<tr class="even">
<td align="left">Center Cycle Shop</td>
</tr>
<tr class="odd">
<td align="left">Elite Bikes</td>
</tr>
<tr class="even">
<td align="left">Family’s Favorite Bike Shop</td>
</tr>
<tr class="odd">
<td align="left">Hardware Components</td>
</tr>
<tr class="even">
<td align="left">Modular Cycle Systems</td>
</tr>
<tr class="odd">
<td align="left">Progressive Sports</td>
</tr>
<tr class="even">
<td align="left">Racing Toys</td>
</tr>
<tr class="odd">
<td align="left">Safe Cycles Shop</td>
</tr>
<tr class="even">
<td align="left">Sample Bike Store</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="using-functions-and-aggregating-data" class="section level2">
<h2><span class="header-section-number">1.5</span> Using Functions and Aggregating Data</h2>
<p>Now we are looking to not just bring back individual rows but perform calculations, such as aggregations, on those results.</p>
<p>The functions we will look at are shown below.</p>
<div class="figure"><span id="fig:Functions"></span>
<img src="images/TSQL/Functions.png" alt="Transact-SQL Functions" width="610" />
<p class="caption">
Figure 1.1: Transact-SQL Functions
</p>
</div>
<div id="scalar-functions" class="section level3">
<h3><span class="header-section-number">1.5.1</span> Scalar Functions</h3>
<p>A scalar function returns a single value, not a row or column or table. In database design things can be deterministic or non-deterministic</p>
<ul>
<li>Deterministic - we know what the result will be, assuming the data hasn’t changed. The data going in and coming out will be the same</li>
<li>Non-deterministic - we cannot gaurantee what the result will be. For instance if we tested if todays date was less than a value in a table, it would depend on the time and day that the query was run. We can’t say what the result will be, based on the data going in/from the db.</li>
</ul>
<p>A scalar function can be either deterministic or non-deterministic. Scalar is a set of functions, and can do multiple things - date and times, text and image, mathematical, system and system statistical, metadata and so on.</p>
<p>We might want to extract the year from a date, for instance to determine when a product was first sold.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="dt">YEAR</span>(SellStartDate) SellStartYear, ProductID, Name
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">ORDER</span> <span class="kw">BY</span> SellStartYear;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-51">Table 1.40: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">SellStartYear</th>
<th align="right">ProductID</th>
<th align="left">Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2002</td>
<td align="right">680</td>
<td align="left">HL Road Frame - Black, 58</td>
</tr>
<tr class="even">
<td align="right">2002</td>
<td align="right">706</td>
<td align="left">HL Road Frame - Red, 58</td>
</tr>
<tr class="odd">
<td align="right">2005</td>
<td align="right">707</td>
<td align="left">Sport-100 Helmet, Red</td>
</tr>
<tr class="even">
<td align="right">2005</td>
<td align="right">708</td>
<td align="left">Sport-100 Helmet, Black</td>
</tr>
<tr class="odd">
<td align="right">2005</td>
<td align="right">709</td>
<td align="left">Mountain Bike Socks, M</td>
</tr>
<tr class="even">
<td align="right">2005</td>
<td align="right">710</td>
<td align="left">Mountain Bike Socks, L</td>
</tr>
<tr class="odd">
<td align="right">2005</td>
<td align="right">711</td>
<td align="left">Sport-100 Helmet, Blue</td>
</tr>
<tr class="even">
<td align="right">2005</td>
<td align="right">712</td>
<td align="left">AWC Logo Cap</td>
</tr>
<tr class="odd">
<td align="right">2005</td>
<td align="right">713</td>
<td align="left">Long-Sleeve Logo Jersey, S</td>
</tr>
<tr class="even">
<td align="right">2005</td>
<td align="right">714</td>
<td align="left">Long-Sleeve Logo Jersey, M</td>
</tr>
</tbody>
</table>
</div>
<p>Other examples might include being able to extract certain parts of the date, like the month or day of the week, this can be achived with the DATENAME function</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="dt">YEAR</span>(SellStartDate) SellStartYear, DATENAME(mm,SellStartDate) SellStartMonth,
       <span class="dt">DAY</span>(SellStartDate) SellStartDay, DATENAME(dw, SellStartDate) SellStartWeekday,
       ProductID, Name
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">ORDER</span> <span class="kw">BY</span> SellStartYear;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-52">Table 1.41: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">SellStartYear</th>
<th align="left">SellStartMonth</th>
<th align="right">SellStartDay</th>
<th align="left">SellStartWeekday</th>
<th align="right">ProductID</th>
<th align="left">Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">2002</td>
<td align="left">June</td>
<td align="right">1</td>
<td align="left">Saturday</td>
<td align="right">680</td>
<td align="left">HL Road Frame - Black, 58</td>
</tr>
<tr class="even">
<td align="right">2002</td>
<td align="left">June</td>
<td align="right">1</td>
<td align="left">Saturday</td>
<td align="right">706</td>
<td align="left">HL Road Frame - Red, 58</td>
</tr>
<tr class="odd">
<td align="right">2005</td>
<td align="left">July</td>
<td align="right">1</td>
<td align="left">Friday</td>
<td align="right">707</td>
<td align="left">Sport-100 Helmet, Red</td>
</tr>
<tr class="even">
<td align="right">2005</td>
<td align="left">July</td>
<td align="right">1</td>
<td align="left">Friday</td>
<td align="right">708</td>
<td align="left">Sport-100 Helmet, Black</td>
</tr>
<tr class="odd">
<td align="right">2005</td>
<td align="left">July</td>
<td align="right">1</td>
<td align="left">Friday</td>
<td align="right">709</td>
<td align="left">Mountain Bike Socks, M</td>
</tr>
<tr class="even">
<td align="right">2005</td>
<td align="left">July</td>
<td align="right">1</td>
<td align="left">Friday</td>
<td align="right">710</td>
<td align="left">Mountain Bike Socks, L</td>
</tr>
<tr class="odd">
<td align="right">2005</td>
<td align="left">July</td>
<td align="right">1</td>
<td align="left">Friday</td>
<td align="right">711</td>
<td align="left">Sport-100 Helmet, Blue</td>
</tr>
<tr class="even">
<td align="right">2005</td>
<td align="left">July</td>
<td align="right">1</td>
<td align="left">Friday</td>
<td align="right">712</td>
<td align="left">AWC Logo Cap</td>
</tr>
<tr class="odd">
<td align="right">2005</td>
<td align="left">July</td>
<td align="right">1</td>
<td align="left">Friday</td>
<td align="right">713</td>
<td align="left">Long-Sleeve Logo Jersey, S</td>
</tr>
<tr class="even">
<td align="right">2005</td>
<td align="left">July</td>
<td align="right">1</td>
<td align="left">Friday</td>
<td align="right">714</td>
<td align="left">Long-Sleeve Logo Jersey, M</td>
</tr>
</tbody>
</table>
</div>
<p>Or we might want to calculate how long a product has been sold, we can use the DATEDIFF function to work this out.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> DATEDIFF(yy,SellStartDate, GETDATE()) YearsSold, 
       DATEDIFF(mm,SellStartDate, GETDATE()) MonthsSold,
       ProductID, Name
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">ORDER</span> <span class="kw">BY</span> ProductID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-53">Table 1.42: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">YearsSold</th>
<th align="right">MonthsSold</th>
<th align="right">ProductID</th>
<th align="left">Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">16</td>
<td align="right">189</td>
<td align="right">680</td>
<td align="left">HL Road Frame - Black, 58</td>
</tr>
<tr class="even">
<td align="right">16</td>
<td align="right">189</td>
<td align="right">706</td>
<td align="left">HL Road Frame - Red, 58</td>
</tr>
<tr class="odd">
<td align="right">13</td>
<td align="right">152</td>
<td align="right">707</td>
<td align="left">Sport-100 Helmet, Red</td>
</tr>
<tr class="even">
<td align="right">13</td>
<td align="right">152</td>
<td align="right">708</td>
<td align="left">Sport-100 Helmet, Black</td>
</tr>
<tr class="odd">
<td align="right">13</td>
<td align="right">152</td>
<td align="right">709</td>
<td align="left">Mountain Bike Socks, M</td>
</tr>
<tr class="even">
<td align="right">13</td>
<td align="right">152</td>
<td align="right">710</td>
<td align="left">Mountain Bike Socks, L</td>
</tr>
<tr class="odd">
<td align="right">13</td>
<td align="right">152</td>
<td align="right">711</td>
<td align="left">Sport-100 Helmet, Blue</td>
</tr>
<tr class="even">
<td align="right">13</td>
<td align="right">152</td>
<td align="right">712</td>
<td align="left">AWC Logo Cap</td>
</tr>
<tr class="odd">
<td align="right">13</td>
<td align="right">152</td>
<td align="right">713</td>
<td align="left">Long-Sleeve Logo Jersey, S</td>
</tr>
<tr class="even">
<td align="right">13</td>
<td align="right">152</td>
<td align="right">714</td>
<td align="left">Long-Sleeve Logo Jersey, M</td>
</tr>
</tbody>
</table>
</div>
<p>Another common example might be to convert text to upper case.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="fu">UPPER</span>(Name) <span class="kw">AS</span> ProductName
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">ProductName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">ALL-PURPOSE BIKE STAND</td>
</tr>
<tr class="even">
<td align="left">AWC LOGO CAP</td>
</tr>
<tr class="odd">
<td align="left">BIKE WASH - DISSOLVER</td>
</tr>
<tr class="even">
<td align="left">CABLE LOCK</td>
</tr>
<tr class="odd">
<td align="left">CHAIN</td>
</tr>
<tr class="even">
<td align="left">CLASSIC VEST, L</td>
</tr>
<tr class="odd">
<td align="left">CLASSIC VEST, M</td>
</tr>
<tr class="even">
<td align="left">CLASSIC VEST, S</td>
</tr>
<tr class="odd">
<td align="left">FENDER SET - MOUNTAIN</td>
</tr>
<tr class="even">
<td align="left">FRONT BRAKES</td>
</tr>
</tbody>
</table>
</div>
<p>We might want to add two strings together but with a space or other text, so we could use the CONCAT function to achieve this.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="fu">CONCAT</span>(FirstName + <span class="st">&#39; &#39;</span>, LastName) <span class="kw">AS</span> FullName,
       FirstName, LastName
<span class="kw">FROM</span> SalesLT.Customer;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-55">Table 1.43: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">FullName</th>
<th align="left">FirstName</th>
<th align="left">LastName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Orlando Gee</td>
<td align="left">Orlando</td>
<td align="left">Gee</td>
</tr>
<tr class="even">
<td align="left">Keith Harris</td>
<td align="left">Keith</td>
<td align="left">Harris</td>
</tr>
<tr class="odd">
<td align="left">Donna Carreras</td>
<td align="left">Donna</td>
<td align="left">Carreras</td>
</tr>
<tr class="even">
<td align="left">Janet Gates</td>
<td align="left">Janet</td>
<td align="left">Gates</td>
</tr>
<tr class="odd">
<td align="left">Lucy Harrington</td>
<td align="left">Lucy</td>
<td align="left">Harrington</td>
</tr>
<tr class="even">
<td align="left">Rosmarie Carroll</td>
<td align="left">Rosmarie</td>
<td align="left">Carroll</td>
</tr>
<tr class="odd">
<td align="left">Dominic Gash</td>
<td align="left">Dominic</td>
<td align="left">Gash</td>
</tr>
<tr class="even">
<td align="left">Kathleen Garza</td>
<td align="left">Kathleen</td>
<td align="left">Garza</td>
</tr>
<tr class="odd">
<td align="left">Katherine Harding</td>
<td align="left">Katherine</td>
<td align="left">Harding</td>
</tr>
<tr class="even">
<td align="left">Johnny Caprio</td>
<td align="left">Johnny</td>
<td align="left">Caprio</td>
</tr>
</tbody>
</table>
</div>
<p>Or we might want to return just a specific number of charecters from a string, perhaps there is a structure in the sequence - like the first two chars relate to a product type - so we want to just extract these first two.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, ProductNumber, <span class="kw">LEFT</span>(ProductNumber, <span class="dv">2</span>) <span class="kw">AS</span> ProductType
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-56">Table 1.44: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">ProductNumber</th>
<th align="left">ProductType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HL Road Frame - Black, 58</td>
<td align="left">FR-R92B-58</td>
<td align="left">FR</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 58</td>
<td align="left">FR-R92R-58</td>
<td align="left">FR</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">HL-U509-R</td>
<td align="left">HL</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Black</td>
<td align="left">HL-U509</td>
<td align="left">HL</td>
</tr>
<tr class="odd">
<td align="left">Mountain Bike Socks, M</td>
<td align="left">SO-B909-M</td>
<td align="left">SO</td>
</tr>
<tr class="even">
<td align="left">Mountain Bike Socks, L</td>
<td align="left">SO-B909-L</td>
<td align="left">SO</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Blue</td>
<td align="left">HL-U509-B</td>
<td align="left">HL</td>
</tr>
<tr class="even">
<td align="left">AWC Logo Cap</td>
<td align="left">CA-1098</td>
<td align="left">CA</td>
</tr>
<tr class="odd">
<td align="left">Long-Sleeve Logo Jersey, S</td>
<td align="left">LJ-0192-S</td>
<td align="left">LJ</td>
</tr>
<tr class="even">
<td align="left">Long-Sleeve Logo Jersey, M</td>
<td align="left">LJ-0192-M</td>
<td align="left">LJ</td>
</tr>
</tbody>
</table>
</div>
<p>Or we might have something more complex, where we want to find certain elements of text, we can use CHARINDEX to identify where a char occurs, then combine it with SUBSTRING to extract just a portion of the full string which is n chars before or after a particular charecter.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, ProductNumber, <span class="kw">LEFT</span>(ProductNumber, <span class="dv">2</span>) <span class="kw">AS</span> ProductType,
                            SUBSTRING(ProductNumber,CHARINDEX(<span class="st">&#39;-&#39;</span>, ProductNumber) + <span class="dv">1</span>, <span class="dv">4</span>) <span class="kw">AS</span> ModelCode,
                                          SUBSTRING(ProductNumber, LEN(ProductNumber) - CHARINDEX(<span class="st">&#39;-&#39;</span>, <span class="kw">REVERSE</span>(<span class="kw">RIGHT</span>(ProductNumber, <span class="dv">3</span>))) + <span class="dv">2</span>, <span class="dv">2</span>) <span class="kw">AS</span> SizeCode
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-57">Table 1.45: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">ProductNumber</th>
<th align="left">ProductType</th>
<th align="left">ModelCode</th>
<th align="left">SizeCode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HL Road Frame - Black, 58</td>
<td align="left">FR-R92B-58</td>
<td align="left">FR</td>
<td align="left">R92B</td>
<td align="left">58</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 58</td>
<td align="left">FR-R92R-58</td>
<td align="left">FR</td>
<td align="left">R92R</td>
<td align="left">58</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">HL-U509-R</td>
<td align="left">HL</td>
<td align="left">U509</td>
<td align="left">R</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Black</td>
<td align="left">HL-U509</td>
<td align="left">HL</td>
<td align="left">U509</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Mountain Bike Socks, M</td>
<td align="left">SO-B909-M</td>
<td align="left">SO</td>
<td align="left">B909</td>
<td align="left">M</td>
</tr>
<tr class="even">
<td align="left">Mountain Bike Socks, L</td>
<td align="left">SO-B909-L</td>
<td align="left">SO</td>
<td align="left">B909</td>
<td align="left">L</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Blue</td>
<td align="left">HL-U509-B</td>
<td align="left">HL</td>
<td align="left">U509</td>
<td align="left">B</td>
</tr>
<tr class="even">
<td align="left">AWC Logo Cap</td>
<td align="left">CA-1098</td>
<td align="left">CA</td>
<td align="left">1098</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Long-Sleeve Logo Jersey, S</td>
<td align="left">LJ-0192-S</td>
<td align="left">LJ</td>
<td align="left">0192</td>
<td align="left">S</td>
</tr>
<tr class="even">
<td align="left">Long-Sleeve Logo Jersey, M</td>
<td align="left">LJ-0192-M</td>
<td align="left">LJ</td>
<td align="left">0192</td>
<td align="left">M</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="logical-functions" class="section level3">
<h3><span class="header-section-number">1.5.2</span> Logical Functions</h3>
<p>Logical functions test if someting is true or not i.e. traditional boolean. But we can use logical functions as filters by using CHOOSE for example, you could use IIF which is also a logical, or we could use CASE to achieve the same result.</p>
<p>An exmaple might be if we want to return some numeric sizes, for instance if we have a table of data with different size formats:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, <span class="kw">Size</span>
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-58">Table 1.46: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">Size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HL Road Frame - Black, 58</td>
<td align="left">58</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 58</td>
<td align="left">58</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Black</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Mountain Bike Socks, M</td>
<td align="left">M</td>
</tr>
<tr class="even">
<td align="left">Mountain Bike Socks, L</td>
<td align="left">L</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Blue</td>
<td align="left">NA</td>
</tr>
<tr class="even">
<td align="left">AWC Logo Cap</td>
<td align="left">NA</td>
</tr>
<tr class="odd">
<td align="left">Long-Sleeve Logo Jersey, S</td>
<td align="left">S</td>
</tr>
<tr class="even">
<td align="left">Long-Sleeve Logo Jersey, M</td>
<td align="left">M</td>
</tr>
</tbody>
</table>
</div>
<p>We might only be interested in those that have a numeric type, even though the data is in a char data string, 1 in this instance means true:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, <span class="kw">Size</span> <span class="kw">AS</span> NumericSize
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">WHERE</span> ISNUMERIC(<span class="kw">Size</span>) = <span class="dv">1</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-59">Table 1.47: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">NumericSize</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HL Road Frame - Black, 58</td>
<td align="left">58</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 58</td>
<td align="left">58</td>
</tr>
<tr class="odd">
<td align="left">HL Road Frame - Red, 62</td>
<td align="left">62</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 44</td>
<td align="left">44</td>
</tr>
<tr class="odd">
<td align="left">HL Road Frame - Red, 48</td>
<td align="left">48</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 52</td>
<td align="left">52</td>
</tr>
<tr class="odd">
<td align="left">HL Road Frame - Red, 56</td>
<td align="left">56</td>
</tr>
<tr class="even">
<td align="left">LL Road Frame - Black, 58</td>
<td align="left">58</td>
</tr>
<tr class="odd">
<td align="left">LL Road Frame - Black, 60</td>
<td align="left">60</td>
</tr>
<tr class="even">
<td align="left">LL Road Frame - Black, 62</td>
<td align="left">62</td>
</tr>
</tbody>
</table>
</div>
<p>Or we might want to assign a value to something, like a product type of bike to certain values and other to everything else.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, IIF(ProductCategoryID <span class="kw">IN</span> (<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>), <span class="st">&#39;Bike&#39;</span>, <span class="st">&#39;Other&#39;</span>) ProductType
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-60">Table 1.48: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">ProductType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">HL Road Frame - Black, 58</td>
<td align="left">Other</td>
</tr>
<tr class="even">
<td align="left">HL Road Frame - Red, 58</td>
<td align="left">Other</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Red</td>
<td align="left">Other</td>
</tr>
<tr class="even">
<td align="left">Sport-100 Helmet, Black</td>
<td align="left">Other</td>
</tr>
<tr class="odd">
<td align="left">Mountain Bike Socks, M</td>
<td align="left">Other</td>
</tr>
<tr class="even">
<td align="left">Mountain Bike Socks, L</td>
<td align="left">Other</td>
</tr>
<tr class="odd">
<td align="left">Sport-100 Helmet, Blue</td>
<td align="left">Other</td>
</tr>
<tr class="even">
<td align="left">AWC Logo Cap</td>
<td align="left">Other</td>
</tr>
<tr class="odd">
<td align="left">Long-Sleeve Logo Jersey, S</td>
<td align="left">Other</td>
</tr>
<tr class="even">
<td align="left">Long-Sleeve Logo Jersey, M</td>
<td align="left">Other</td>
</tr>
</tbody>
</table>
</div>
<p>Or a more complicated query where we assign mutiple product types.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> prd.Name <span class="kw">AS</span> ProductName, cat.Name <span class="kw">AS</span> <span class="kw">Category</span>,
      <span class="kw">CHOOSE</span> (cat.ParentProductCategoryID, <span class="st">&#39;Bikes&#39;</span>,<span class="st">&#39;Components&#39;</span>,<span class="st">&#39;Clothing&#39;</span>,<span class="st">&#39;Accessories&#39;</span>) <span class="kw">AS</span> ProductType
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> prd
<span class="kw">JOIN</span> SalesLT.ProductCategory <span class="kw">AS</span> cat
<span class="kw">ON</span> prd.ProductCategoryID = cat.ProductCategoryID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-61">Table 1.49: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ProductName</th>
<th align="left">Category</th>
<th align="left">ProductType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Mountain-100 Silver, 38</td>
<td align="left">Mountain Bikes</td>
<td align="left">Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Silver, 42</td>
<td align="left">Mountain Bikes</td>
<td align="left">Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-100 Silver, 44</td>
<td align="left">Mountain Bikes</td>
<td align="left">Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Silver, 48</td>
<td align="left">Mountain Bikes</td>
<td align="left">Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-100 Black, 38</td>
<td align="left">Mountain Bikes</td>
<td align="left">Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Black, 42</td>
<td align="left">Mountain Bikes</td>
<td align="left">Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-100 Black, 44</td>
<td align="left">Mountain Bikes</td>
<td align="left">Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-100 Black, 48</td>
<td align="left">Mountain Bikes</td>
<td align="left">Bikes</td>
</tr>
<tr class="odd">
<td align="left">Mountain-200 Silver, 38</td>
<td align="left">Mountain Bikes</td>
<td align="left">Bikes</td>
</tr>
<tr class="even">
<td align="left">Mountain-200 Silver, 42</td>
<td align="left">Mountain Bikes</td>
<td align="left">Bikes</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="window-functions" class="section level3">
<h3><span class="header-section-number">1.5.3</span> Window Functions</h3>
<p>A window in this context is a set of rows - a window in to the database or table. For instance, we might want to RANK a set (or window) of data. The query below will pull out the top 100 more expensive products (ordered by list price) then creates a ranking based on this list price, then orders the results by this ranking.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> TOP(<span class="dv">100</span>) ProductID, Name, ListPrice,
    <span class="fu">RANK</span>() <span class="kw">OVER</span>(<span class="kw">ORDER</span> <span class="kw">BY</span> ListPrice <span class="kw">DESC</span>) <span class="kw">AS</span> RankByPrice
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> p
<span class="kw">ORDER</span> <span class="kw">BY</span> RankByPrice;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-62">Table 1.50: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">ProductID</th>
<th align="left">Name</th>
<th align="right">ListPrice</th>
<th align="right">RankByPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">749</td>
<td align="left">Road-150 Red, 62</td>
<td align="right">3578.27</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">750</td>
<td align="left">Road-150 Red, 44</td>
<td align="right">3578.27</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">751</td>
<td align="left">Road-150 Red, 48</td>
<td align="right">3578.27</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">752</td>
<td align="left">Road-150 Red, 52</td>
<td align="right">3578.27</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">753</td>
<td align="left">Road-150 Red, 56</td>
<td align="right">3578.27</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">771</td>
<td align="left">Mountain-100 Silver, 38</td>
<td align="right">3399.99</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="right">772</td>
<td align="left">Mountain-100 Silver, 42</td>
<td align="right">3399.99</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="right">773</td>
<td align="left">Mountain-100 Silver, 44</td>
<td align="right">3399.99</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="right">774</td>
<td align="left">Mountain-100 Silver, 48</td>
<td align="right">3399.99</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="right">775</td>
<td align="left">Mountain-100 Black, 38</td>
<td align="right">3374.99</td>
<td align="right">10</td>
</tr>
</tbody>
</table>
</div>
<p>Or we might want to partition the results by product category, similar to grouping by product category. This will result in a ranking for each product category. The results might look a little odd at first glance.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.Name <span class="kw">AS</span> <span class="kw">Category</span>, p.Name <span class="kw">AS</span> Product, ListPrice,
    <span class="fu">RANK</span>() <span class="kw">OVER</span>(<span class="kw">PARTITION</span> <span class="kw">BY</span> c.Name <span class="kw">ORDER</span> <span class="kw">BY</span> ListPrice <span class="kw">DESC</span>) <span class="kw">AS</span> RankByPrice
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> p
<span class="kw">JOIN</span> SalesLT.ProductCategory <span class="kw">AS</span> c
<span class="kw">ON</span> p.ProductCategoryID = c.ProductcategoryID
<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">Category</span>, RankByPrice;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-63">Table 1.51: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Category</th>
<th align="left">Product</th>
<th align="right">ListPrice</th>
<th align="right">RankByPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Bib-Shorts</td>
<td align="left">Men’s Bib-Shorts, S</td>
<td align="right">89.99</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Bib-Shorts</td>
<td align="left">Men’s Bib-Shorts, M</td>
<td align="right">89.99</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Bib-Shorts</td>
<td align="left">Men’s Bib-Shorts, L</td>
<td align="right">89.99</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Bike Racks</td>
<td align="left">Hitch Rack - 4-Bike</td>
<td align="right">120.00</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Bike Stands</td>
<td align="left">All-Purpose Bike Stand</td>
<td align="right">159.00</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Bottles and Cages</td>
<td align="left">Mountain Bottle Cage</td>
<td align="right">9.99</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Bottles and Cages</td>
<td align="left">Road Bottle Cage</td>
<td align="right">8.99</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">Bottles and Cages</td>
<td align="left">Water Bottle - 30 oz.</td>
<td align="right">4.99</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Bottom Brackets</td>
<td align="left">HL Bottom Bracket</td>
<td align="right">121.49</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Bottom Brackets</td>
<td align="left">ML Bottom Bracket</td>
<td align="right">101.24</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="aggregate-functions" class="section level3">
<h3><span class="header-section-number">1.5.4</span> Aggregate Functions</h3>
<p>There are a lot of aggregate functions including some statistical functions like s.d. as well as some more standard things like MIN, MAX, SUM etc over a set of data. We can use GROUP BY.</p>
<p>First we can get some headline stats of what is in the table.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="fu">COUNT</span>(*) <span class="kw">AS</span> Products, <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> ProductCategoryID) <span class="kw">AS</span> Categories, <span class="fu">AVG</span>(ListPrice) <span class="kw">AS</span> AveragePrice
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-64">Table 1.52: </span>1 records</caption>
<thead>
<tr class="header">
<th align="left">Products</th>
<th align="right">Categories</th>
<th align="right">AveragePrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">295</td>
<td align="right">37</td>
<td align="right">744.5952</td>
</tr>
</tbody>
</table>
</div>
<p>Or we might be interested in summary figures for just one product type, like bikes. Note that we use COUNT then the specific item, since using COUNT(*) would return the number of rows, which may include duplicates.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="fu">COUNT</span>(p.ProductID) BikeModels, <span class="fu">AVG</span>(p.ListPrice) AveragePrice
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> p
<span class="kw">JOIN</span> SalesLT.ProductCategory <span class="kw">AS</span> c
<span class="kw">ON</span> p.ProductCategoryID = c.ProductCategoryID
<span class="kw">WHERE</span> c.Name <span class="kw">LIKE</span> <span class="st">&#39;%Bikes&#39;</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-65">Table 1.53: </span>1 records</caption>
<thead>
<tr class="header">
<th align="left">BikeModels</th>
<th align="right">AveragePrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">97</td>
<td align="right">1586.737</td>
</tr>
</tbody>
</table>
</div>
<p>However, our aggregate functions are currently returnign totals. In practice, we may want to return figures by groups, so we need to use GROUP BY in our queries. When we use a GROUP BY which groups up the results, we have to group up everything in the select row that isn’t being aggregated. You can’t have something in the SELECT which is neither being aggregated nor being grouped. As we are grouping the results, we don’t see individual rows of data anymore.</p>
<p>The following example calulates the sales revenue for each sales person.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.Salesperson, <span class="fu">SUM</span>(oh.SubTotal) SalesRevenue
<span class="kw">FROM</span> SalesLT.Customer c
<span class="kw">JOIN</span> SalesLT.SalesOrderHeader oh
<span class="kw">ON</span> c.CustomerID = oh.CustomerID
<span class="kw">GROUP</span> <span class="kw">BY</span> c.Salesperson
<span class="kw">ORDER</span> <span class="kw">BY</span> SalesRevenue <span class="kw">DESC</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-66">Table 1.54: </span>3 records</caption>
<thead>
<tr class="header">
<th align="left">Salesperson</th>
<th align="right">SalesRevenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="right">518096.4</td>
</tr>
<tr class="even">
<td align="left">adventure-works3</td>
<td align="right">209219.8</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="right">138116.9</td>
</tr>
</tbody>
</table>
</div>
<p>Could it be that some sales people have no sales? If so, we need to return values where the total is NULL, by assigning NULL a value of zero. WE also use the LEFT JOIN rather than the INNER JOIN previously, we get sales people included who haven’t sold anything.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.Salesperson, ISNULL(<span class="fu">SUM</span>(oh.SubTotal), <span class="fl">0.00</span>) SalesRevenue
<span class="kw">FROM</span> SalesLT.Customer c
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.SalesOrderHeader oh
<span class="kw">ON</span> c.CustomerID = oh.CustomerID
<span class="kw">GROUP</span> <span class="kw">BY</span> c.Salesperson
<span class="kw">ORDER</span> <span class="kw">BY</span> SalesRevenue <span class="kw">DESC</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-67">Table 1.55: </span>9 records</caption>
<thead>
<tr class="header">
<th align="left">Salesperson</th>
<th align="right">SalesRevenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="right">518096.4</td>
</tr>
<tr class="even">
<td align="left">adventure-works3</td>
<td align="right">209219.8</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="right">138116.9</td>
</tr>
<tr class="even">
<td align="left">adventure-works9</td>
<td align="right">0.0</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="right">0.0</td>
</tr>
<tr class="even">
<td align="left">adventure-works0</td>
<td align="right">0.0</td>
</tr>
<tr class="odd">
<td align="left">adventure-works1</td>
<td align="right">0.0</td>
</tr>
<tr class="even">
<td align="left">adventure-works8</td>
<td align="right">0.0</td>
</tr>
<tr class="odd">
<td align="left">adventure-works1</td>
<td align="right">0.0</td>
</tr>
</tbody>
</table>
</div>
<p>Or we might want to know the number of customers each sales person has.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Salesperson, <span class="fu">COUNT</span>(CustomerID) Customers
<span class="kw">FROM</span> SalesLT.Customer
<span class="kw">GROUP</span> <span class="kw">BY</span> Salesperson
<span class="kw">ORDER</span> <span class="kw">BY</span> Salesperson;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-68">Table 1.56: </span>9 records</caption>
<thead>
<tr class="header">
<th align="left">Salesperson</th>
<th align="right">Customers</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">adventure-works8</td>
<td align="right">73</td>
</tr>
<tr class="even">
<td align="left">adventure-works1</td>
<td align="right">78</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="right">78</td>
</tr>
<tr class="even">
<td align="left">adventure-works0</td>
<td align="right">148</td>
</tr>
<tr class="odd">
<td align="left">adventure-works1</td>
<td align="right">142</td>
</tr>
<tr class="even">
<td align="left">adventure-works3</td>
<td align="right">71</td>
</tr>
<tr class="odd">
<td align="left">adventure-works9</td>
<td align="right">32</td>
</tr>
<tr class="even">
<td align="left">adventure-works0</td>
<td align="right">74</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="right">151</td>
</tr>
</tbody>
</table>
</div>
<p>We might also want to know the sales Revenue by sales person and customer. Note that we now includer the customer details, we cannot use the CUSTOMER alias from the SELECT query in the GROUP BY, as the SELECT query is run after the GROUP BY.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.Salesperson, <span class="fu">CONCAT</span>(c.FirstName +<span class="st">&#39; &#39;</span>, c.LastName) <span class="kw">AS</span> Customer, ISNULL(<span class="fu">SUM</span>(oh.SubTotal), <span class="fl">0.00</span>) SalesRevenue
<span class="kw">FROM</span> SalesLT.Customer c
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.SalesOrderHeader oh
<span class="kw">ON</span> c.CustomerID = oh.CustomerID
<span class="kw">GROUP</span> <span class="kw">BY</span> c.Salesperson, <span class="fu">CONCAT</span>(c.FirstName +<span class="st">&#39; &#39;</span>, c.LastName)
<span class="kw">ORDER</span> <span class="kw">BY</span> SalesRevenue <span class="kw">DESC</span>, Customer;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-69">Table 1.57: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Salesperson</th>
<th align="left">Customer</th>
<th align="right">SalesRevenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">Terry Eminhizer</td>
<td align="right">108561.83</td>
</tr>
<tr class="even">
<td align="left">adventure-works0</td>
<td align="left">Krishna Sunkammurali</td>
<td align="right">98278.69</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">Christopher Beck</td>
<td align="right">88812.86</td>
</tr>
<tr class="even">
<td align="left">adventure-works3</td>
<td align="left">Kevin Liu</td>
<td align="right">83858.43</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">Jon Grande</td>
<td align="right">78029.69</td>
</tr>
<tr class="even">
<td align="left">adventure-works0</td>
<td align="left">Jeffrey Kurtz</td>
<td align="right">74058.81</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">Rebecca Laszlo</td>
<td align="right">63980.99</td>
</tr>
<tr class="even">
<td align="left">adventure-works3</td>
<td align="left">Anthony Chor</td>
<td align="right">57634.63</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="left">Frank Campbell</td>
<td align="right">41622.05</td>
</tr>
<tr class="even">
<td align="left">adventure-works3</td>
<td align="left">Catherine Abel</td>
<td align="right">39785.33</td>
</tr>
</tbody>
</table>
</div>
<p>Or the number of products in each category.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.Name <span class="kw">AS</span> <span class="kw">Category</span>, <span class="fu">COUNT</span>(p.ProductID) <span class="kw">AS</span> Products
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> p
<span class="kw">JOIN</span> SalesLT.ProductCategory <span class="kw">AS</span> c
<span class="kw">ON</span> p.ProductCategoryID = c.ProductCategoryID
<span class="kw">GROUP</span> <span class="kw">BY</span> c.Name
<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">Category</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-70">Table 1.58: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Category</th>
<th align="right">Products</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Bib-Shorts</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Bike Racks</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Bike Stands</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Bottles and Cages</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Bottom Brackets</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Brakes</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Caps</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Chains</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Cleaners</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Cranksets</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="filtering-groups" class="section level3">
<h3><span class="header-section-number">1.5.5</span> Filtering Groups</h3>
<p>If we want to filter, we can use the WHERE clause as we have seen in some previous examples. However, most of the time we filter with the HAVING caluse. <strong>HAVING will filter the resutls RATHER than the input</strong>.</p>
<p>Having clause provides a search condition that each group must satisfy, for instance where the number of orders by a customer is greater than 10.</p>
<p>In the example below, we are interested in finding out which sales people have more than 100 customers.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Salesperson, <span class="fu">COUNT</span>(CustomerID) Customers
<span class="kw">FROM</span> SalesLT.Customer
<span class="kw">GROUP</span> <span class="kw">BY</span> Salesperson
<span class="kw">HAVING</span> <span class="fu">COUNT</span>(CustomerID) &gt; <span class="dv">100</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> Salesperson;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-71">Table 1.59: </span>3 records</caption>
<thead>
<tr class="header">
<th align="left">Salesperson</th>
<th align="right">Customers</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="right">148</td>
</tr>
<tr class="even">
<td align="left">adventure-works1</td>
<td align="right">142</td>
</tr>
<tr class="odd">
<td align="left">adventure-works0</td>
<td align="right">151</td>
</tr>
</tbody>
</table>
</div>
<p>Key Points:</p>
<ul>
<li>You can use GROUP BY with aggregate functions to return aggregations grouped by one or more columns or expressions.</li>
<li>All columns in the SELECT clause that are not aggregate function expressions must be included in a GROUP BY clause.</li>
<li>The order in which columns or expressions are listed in the GROUP BY clause determines the grouping hierarchy.</li>
<li>You can filter the groups that are included in the query results by specifying a HAVING clause.</li>
</ul>
</div>
<div id="lab-exercises-4" class="section level3">
<h3><span class="header-section-number">1.5.6</span> Lab Exercises</h3>
<p>Write a query to return the product ID of each product, together with the product name formatted as upper case and a column named ApproxWeight with the weight of each product rounded to the nearest whole unit.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ProductID, <span class="fu">UPPER</span>(Name) <span class="kw">AS</span> ProductName, <span class="fu">ROUND</span>(WEIGHT, <span class="dv">0</span>) <span class="kw">AS</span> ApproxWeight
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-72">Table 1.60: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">ProductID</th>
<th align="left">ProductName</th>
<th align="right">ApproxWeight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">680</td>
<td align="left">HL ROAD FRAME - BLACK, 58</td>
<td align="right">1016</td>
</tr>
<tr class="even">
<td align="right">706</td>
<td align="left">HL ROAD FRAME - RED, 58</td>
<td align="right">1016</td>
</tr>
<tr class="odd">
<td align="right">707</td>
<td align="left">SPORT-100 HELMET, RED</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">708</td>
<td align="left">SPORT-100 HELMET, BLACK</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">709</td>
<td align="left">MOUNTAIN BIKE SOCKS, M</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">710</td>
<td align="left">MOUNTAIN BIKE SOCKS, L</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">711</td>
<td align="left">SPORT-100 HELMET, BLUE</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">712</td>
<td align="left">AWC LOGO CAP</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">713</td>
<td align="left">LONG-SLEEVE LOGO JERSEY, S</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">714</td>
<td align="left">LONG-SLEEVE LOGO JERSEY, M</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
</div>
<p>Extend your query to include columns named SellStartYear and SellStartMonth containing the year and month in which AdventureWorks started selling each product. The month should be displayed as the month name (e.g. ‘January’).</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ProductID, <span class="fu">UPPER</span>(Name) <span class="kw">AS</span> ProductName, <span class="fu">ROUND</span>(Weight, <span class="dv">0</span>) <span class="kw">AS</span> ApproxWeight,
       <span class="dt">YEAR</span>(SellStartDate) <span class="kw">as</span> SellStartYear,
       DATENAME(m, SellStartDate) <span class="kw">as</span> SellStartMonth
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-73">Table 1.61: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">ProductID</th>
<th align="left">ProductName</th>
<th align="right">ApproxWeight</th>
<th align="right">SellStartYear</th>
<th align="left">SellStartMonth</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">680</td>
<td align="left">HL ROAD FRAME - BLACK, 58</td>
<td align="right">1016</td>
<td align="right">2002</td>
<td align="left">June</td>
</tr>
<tr class="even">
<td align="right">706</td>
<td align="left">HL ROAD FRAME - RED, 58</td>
<td align="right">1016</td>
<td align="right">2002</td>
<td align="left">June</td>
</tr>
<tr class="odd">
<td align="right">707</td>
<td align="left">SPORT-100 HELMET, RED</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
</tr>
<tr class="even">
<td align="right">708</td>
<td align="left">SPORT-100 HELMET, BLACK</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
</tr>
<tr class="odd">
<td align="right">709</td>
<td align="left">MOUNTAIN BIKE SOCKS, M</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
</tr>
<tr class="even">
<td align="right">710</td>
<td align="left">MOUNTAIN BIKE SOCKS, L</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
</tr>
<tr class="odd">
<td align="right">711</td>
<td align="left">SPORT-100 HELMET, BLUE</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
</tr>
<tr class="even">
<td align="right">712</td>
<td align="left">AWC LOGO CAP</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
</tr>
<tr class="odd">
<td align="right">713</td>
<td align="left">LONG-SLEEVE LOGO JERSEY, S</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
</tr>
<tr class="even">
<td align="right">714</td>
<td align="left">LONG-SLEEVE LOGO JERSEY, M</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
</tr>
</tbody>
</table>
</div>
<p>Extend your query to include a column named ProductType that contains the leftmost two characters from the product number.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ProductID, <span class="fu">UPPER</span>(Name) <span class="kw">AS</span> ProductName, <span class="fu">ROUND</span>(Weight, <span class="dv">0</span>) <span class="kw">AS</span> ApproxWeight,
       <span class="dt">YEAR</span>(SellStartDate) <span class="kw">as</span> SellStartYear,
       DATENAME(m, SellStartDate) <span class="kw">as</span> SellStartMonth,
       <span class="kw">LEFT</span>(ProductNumber, <span class="dv">2</span>) <span class="kw">AS</span> ProductType
<span class="kw">FROM</span> SalesLT.Product;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-74">Table 1.62: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">ProductID</th>
<th align="left">ProductName</th>
<th align="right">ApproxWeight</th>
<th align="right">SellStartYear</th>
<th align="left">SellStartMonth</th>
<th align="left">ProductType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">680</td>
<td align="left">HL ROAD FRAME - BLACK, 58</td>
<td align="right">1016</td>
<td align="right">2002</td>
<td align="left">June</td>
<td align="left">FR</td>
</tr>
<tr class="even">
<td align="right">706</td>
<td align="left">HL ROAD FRAME - RED, 58</td>
<td align="right">1016</td>
<td align="right">2002</td>
<td align="left">June</td>
<td align="left">FR</td>
</tr>
<tr class="odd">
<td align="right">707</td>
<td align="left">SPORT-100 HELMET, RED</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">HL</td>
</tr>
<tr class="even">
<td align="right">708</td>
<td align="left">SPORT-100 HELMET, BLACK</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">HL</td>
</tr>
<tr class="odd">
<td align="right">709</td>
<td align="left">MOUNTAIN BIKE SOCKS, M</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">SO</td>
</tr>
<tr class="even">
<td align="right">710</td>
<td align="left">MOUNTAIN BIKE SOCKS, L</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">SO</td>
</tr>
<tr class="odd">
<td align="right">711</td>
<td align="left">SPORT-100 HELMET, BLUE</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">HL</td>
</tr>
<tr class="even">
<td align="right">712</td>
<td align="left">AWC LOGO CAP</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">CA</td>
</tr>
<tr class="odd">
<td align="right">713</td>
<td align="left">LONG-SLEEVE LOGO JERSEY, S</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">LJ</td>
</tr>
<tr class="even">
<td align="right">714</td>
<td align="left">LONG-SLEEVE LOGO JERSEY, M</td>
<td align="right">NA</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">LJ</td>
</tr>
</tbody>
</table>
</div>
<p>Extend your query to filter the product returned so that only products with a numeric size are included.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ProductID, <span class="fu">UPPER</span>(Name) <span class="kw">AS</span> ProductName, <span class="fu">ROUND</span>(Weight, <span class="dv">0</span>) <span class="kw">AS</span> ApproxWeight,
       <span class="dt">YEAR</span>(SellStartDate) <span class="kw">as</span> SellStartYear,
       DATENAME(m, SellStartDate) <span class="kw">as</span> SellStartMonth,
       <span class="kw">LEFT</span>(ProductNumber, <span class="dv">2</span>) <span class="kw">AS</span> ProductType
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">WHERE</span> ISNUMERIC(<span class="kw">SIZE</span>) = <span class="dv">1</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-75">Table 1.63: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">ProductID</th>
<th align="left">ProductName</th>
<th align="right">ApproxWeight</th>
<th align="right">SellStartYear</th>
<th align="left">SellStartMonth</th>
<th align="left">ProductType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">680</td>
<td align="left">HL ROAD FRAME - BLACK, 58</td>
<td align="right">1016</td>
<td align="right">2002</td>
<td align="left">June</td>
<td align="left">FR</td>
</tr>
<tr class="even">
<td align="right">706</td>
<td align="left">HL ROAD FRAME - RED, 58</td>
<td align="right">1016</td>
<td align="right">2002</td>
<td align="left">June</td>
<td align="left">FR</td>
</tr>
<tr class="odd">
<td align="right">717</td>
<td align="left">HL ROAD FRAME - RED, 62</td>
<td align="right">1043</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">FR</td>
</tr>
<tr class="even">
<td align="right">718</td>
<td align="left">HL ROAD FRAME - RED, 44</td>
<td align="right">962</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">FR</td>
</tr>
<tr class="odd">
<td align="right">719</td>
<td align="left">HL ROAD FRAME - RED, 48</td>
<td align="right">980</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">FR</td>
</tr>
<tr class="even">
<td align="right">720</td>
<td align="left">HL ROAD FRAME - RED, 52</td>
<td align="right">998</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">FR</td>
</tr>
<tr class="odd">
<td align="right">721</td>
<td align="left">HL ROAD FRAME - RED, 56</td>
<td align="right">1016</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">FR</td>
</tr>
<tr class="even">
<td align="right">722</td>
<td align="left">LL ROAD FRAME - BLACK, 58</td>
<td align="right">1116</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">FR</td>
</tr>
<tr class="odd">
<td align="right">723</td>
<td align="left">LL ROAD FRAME - BLACK, 60</td>
<td align="right">1125</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">FR</td>
</tr>
<tr class="even">
<td align="right">724</td>
<td align="left">LL ROAD FRAME - BLACK, 62</td>
<td align="right">1134</td>
<td align="right">2005</td>
<td align="left">July</td>
<td align="left">FR</td>
</tr>
</tbody>
</table>
</div>
<p>Write a query that returns a list of company names with a ranking of their place in a list of highest TotalDue values from the SalesOrderHeader table.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> CompanyName, TotalDue <span class="kw">AS</span> Revenue,
       <span class="fu">RANK</span>() <span class="kw">OVER</span> (<span class="kw">ORDER</span> <span class="kw">BY</span> TotalDue <span class="kw">DESC</span>) <span class="kw">AS</span> RankByRevenue
<span class="kw">FROM</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> SOH
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.Customer <span class="kw">AS</span> C
<span class="kw">ON</span> SOH.CustomerID = C.CustomerID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-76">Table 1.64: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
<th align="right">Revenue</th>
<th align="right">RankByRevenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Action Bicycle Specialists</td>
<td align="right">119960.82</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Metropolitan Bicycle Supply</td>
<td align="right">108597.95</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Bulk Discount Store</td>
<td align="right">98138.21</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Eastside Department Store</td>
<td align="right">92663.56</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">Riding Cycles</td>
<td align="right">86222.81</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">Many Bikes Store</td>
<td align="right">81834.98</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="left">Instruments and Parts Company</td>
<td align="right">70698.99</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">Extreme Riding Supplies</td>
<td align="right">63686.27</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="left">Trailblazing Sports</td>
<td align="right">45992.37</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="left">Professional Sales and Service</td>
<td align="right">43962.79</td>
<td align="right">10</td>
</tr>
</tbody>
</table>
</div>
<p>Write a query to retrieve a list of the product names and the total revenue calculated as the sum of the LineTotal from the SalesLT.SalesOrderDetail table, with the results sorted in descending order of total revenue.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, <span class="fu">SUM</span>(LineTotal) <span class="kw">AS</span> TotalRevenue
<span class="kw">FROM</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> SOD
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> P
<span class="kw">ON</span> SOD.ProductID = p.ProductID
<span class="kw">GROUP</span> <span class="kw">BY</span> P.Name
<span class="kw">ORDER</span> <span class="kw">BY</span> TotalRevenue <span class="kw">DESC</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-77">Table 1.65: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="right">TotalRevenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Touring-1000 Blue, 60</td>
<td align="right">37191.49</td>
</tr>
<tr class="even">
<td align="left">Mountain-200 Black, 42</td>
<td align="right">37178.84</td>
</tr>
<tr class="odd">
<td align="left">Road-350-W Yellow, 48</td>
<td align="right">36486.24</td>
</tr>
<tr class="even">
<td align="left">Mountain-200 Black, 38</td>
<td align="right">35801.84</td>
</tr>
<tr class="odd">
<td align="left">Touring-1000 Yellow, 60</td>
<td align="right">23413.47</td>
</tr>
<tr class="even">
<td align="left">Touring-1000 Blue, 50</td>
<td align="right">22887.07</td>
</tr>
<tr class="odd">
<td align="left">Mountain-200 Silver, 42</td>
<td align="right">20879.91</td>
</tr>
<tr class="even">
<td align="left">Road-350-W Yellow, 40</td>
<td align="right">20411.88</td>
</tr>
<tr class="odd">
<td align="left">Mountain-200 Black, 46</td>
<td align="right">19277.92</td>
</tr>
<tr class="even">
<td align="left">Road-350-W Yellow, 42</td>
<td align="right">18692.52</td>
</tr>
</tbody>
</table>
</div>
<p>Modify the previous query to include sales totals for products that have a list price of more than 1000.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, <span class="fu">SUM</span>(LineTotal) <span class="kw">AS</span> TotalRevenue
<span class="kw">FROM</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> SOD
<span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> P
<span class="kw">ON</span> SOD.ProductID = P.ProductID
<span class="kw">WHERE</span> ListPrice &gt; <span class="dv">1000</span>
<span class="kw">GROUP</span> <span class="kw">BY</span> P.Name
<span class="kw">ORDER</span> <span class="kw">BY</span> TotalRevenue <span class="kw">DESC</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-78">Table 1.66: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="right">TotalRevenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Touring-1000 Blue, 60</td>
<td align="right">37191.49</td>
</tr>
<tr class="even">
<td align="left">Mountain-200 Black, 42</td>
<td align="right">37178.84</td>
</tr>
<tr class="odd">
<td align="left">Road-350-W Yellow, 48</td>
<td align="right">36486.24</td>
</tr>
<tr class="even">
<td align="left">Mountain-200 Black, 38</td>
<td align="right">35801.84</td>
</tr>
<tr class="odd">
<td align="left">Touring-1000 Yellow, 60</td>
<td align="right">23413.47</td>
</tr>
<tr class="even">
<td align="left">Touring-1000 Blue, 50</td>
<td align="right">22887.07</td>
</tr>
<tr class="odd">
<td align="left">Mountain-200 Silver, 42</td>
<td align="right">20879.91</td>
</tr>
<tr class="even">
<td align="left">Road-350-W Yellow, 40</td>
<td align="right">20411.88</td>
</tr>
<tr class="odd">
<td align="left">Mountain-200 Black, 46</td>
<td align="right">19277.92</td>
</tr>
<tr class="even">
<td align="left">Road-350-W Yellow, 42</td>
<td align="right">18692.52</td>
</tr>
</tbody>
</table>
</div>
<p>Modify the previous query to only include products with total sales greater than 20000.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, <span class="fu">SUM</span>(LineTotal) <span class="kw">AS</span> TotalRevenue
<span class="kw">FROM</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> SOD
<span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> P
<span class="kw">ON</span> SOD.ProductID = P.ProductID
<span class="kw">WHERE</span> P.ListPrice &gt; <span class="dv">1000</span>
<span class="kw">GROUP</span> <span class="kw">BY</span> P.Name
<span class="co">-- add having clause as per instructions</span>
<span class="kw">HAVING</span> <span class="fu">SUM</span>(LineTotal) &gt; <span class="dv">20000</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> TotalRevenue <span class="kw">DESC</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-79">Table 1.67: </span>8 records</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="right">TotalRevenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Touring-1000 Blue, 60</td>
<td align="right">37191.49</td>
</tr>
<tr class="even">
<td align="left">Mountain-200 Black, 42</td>
<td align="right">37178.84</td>
</tr>
<tr class="odd">
<td align="left">Road-350-W Yellow, 48</td>
<td align="right">36486.24</td>
</tr>
<tr class="even">
<td align="left">Mountain-200 Black, 38</td>
<td align="right">35801.84</td>
</tr>
<tr class="odd">
<td align="left">Touring-1000 Yellow, 60</td>
<td align="right">23413.47</td>
</tr>
<tr class="even">
<td align="left">Touring-1000 Blue, 50</td>
<td align="right">22887.07</td>
</tr>
<tr class="odd">
<td align="left">Mountain-200 Silver, 42</td>
<td align="right">20879.91</td>
</tr>
<tr class="even">
<td align="left">Road-350-W Yellow, 40</td>
<td align="right">20411.88</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="sub-queries-and-apply" class="section level2">
<h2><span class="header-section-number">1.6</span> Sub-queries and Apply</h2>
<p>Subqueries are queries within queries (nested). The results of the inner or nested query are pasted to the outer query and behave much like an expression.</p>
<p>Our subquery might be scalr, for instance we might have a single value which is passed to the outer query. So we might be interested in the last order (the maxium id) and the details from that order, where the information is held in two different tables.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> salesorderid, productid, unitprice, orderqty 
<span class="kw">From</span> SalesLT.SalesOrderDetail
<span class="kw">WHERE</span> salesorderid =
    (<span class="kw">SELECT</span> <span class="fu">MAX</span>(salesorderid) <span class="kw">AS</span> lastorder
    <span class="kw">FROM</span> SalesLT.SalesOrderHeader);  </code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-80">Table 1.68: </span>1 records</caption>
<thead>
<tr class="header">
<th align="left">salesorderid</th>
<th align="right">productid</th>
<th align="right">unitprice</th>
<th align="right">orderqty</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">71946</td>
<td align="right">916</td>
<td align="right">31.584</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<p>The subquery is in brackets, and the system will treat whatever is in brackets as an individual unit.</p>
<p>In a multi-valued query, mutiple values are returned but as a single column set to the outer query. So we might be interested in every customer in Mexico. One will get returned from the subquery is a one dimensional array - a vector.</p>
<div id="self-contained-or-correlated-query" class="section level3">
<h3><span class="header-section-number">1.6.1</span> Self Contained or Correlated Query</h3>
<p>Queries we have looked at so far are self contained queries. The sub-query parts works, then it supplies its value to the outer query. Correlated sub-queries refer to elements of tables used in the outer query. Because the sub-query is searching for values in the outer query, this can be resource intensive. We might, for instance, make a reference to an employee number in the subquery, but that number is dependent on the result of the outer query, so the subqueriy works with the outer query.</p>
<p>As with sub-queries generally, it is best to build the query up iteratively, so you can a) check the query is working and b) check your final sub-query results with those of the individual components to make sure it is doing what it should be. However, this is more difficult when using a correlated query, since there is a dependency.</p>
<p>So our goal is for each customer list all sales on the last day that they made a sale.</p>
<p>So first, lets get a list of customers with their orders and dates.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> CustomerID, SalesOrderID, OrderDate
<span class="kw">FROM</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> SO1
<span class="kw">ORDER</span> <span class="kw">BY</span> CustomerID,OrderDate</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-81">Table 1.69: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">CustomerID</th>
<th align="right">SalesOrderID</th>
<th align="left">OrderDate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">29485</td>
<td align="right">71782</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="even">
<td align="right">29531</td>
<td align="right">71935</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="odd">
<td align="right">29546</td>
<td align="right">71938</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="even">
<td align="right">29568</td>
<td align="right">71899</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="odd">
<td align="right">29584</td>
<td align="right">71895</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="even">
<td align="right">29612</td>
<td align="right">71885</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="odd">
<td align="right">29638</td>
<td align="right">71915</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="even">
<td align="right">29644</td>
<td align="right">71867</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="odd">
<td align="right">29653</td>
<td align="right">71858</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="even">
<td align="right">29660</td>
<td align="right">71796</td>
<td align="left">2008-06-01</td>
</tr>
</tbody>
</table>
</div>
<p>Then let’s say we want just the latest (max) order date in the db, for each customer ID we have, so we have their individual last order details.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> CustomerID, SalesOrderID, OrderDate
<span class="kw">FROM</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> SO1
<span class="kw">WHERE</span> orderdate =
    (<span class="kw">SELECT</span> <span class="fu">MAX</span>(orderdate)
<span class="kw">FROM</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> SO2
<span class="kw">WHERE</span> SO2.CustomerID = SO1.CustomerID)
<span class="kw">ORDER</span> <span class="kw">BY</span> CustomerID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-82">Table 1.70: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">CustomerID</th>
<th align="right">SalesOrderID</th>
<th align="left">OrderDate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">29485</td>
<td align="right">71782</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="even">
<td align="right">29531</td>
<td align="right">71935</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="odd">
<td align="right">29546</td>
<td align="right">71938</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="even">
<td align="right">29568</td>
<td align="right">71899</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="odd">
<td align="right">29584</td>
<td align="right">71895</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="even">
<td align="right">29612</td>
<td align="right">71885</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="odd">
<td align="right">29638</td>
<td align="right">71915</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="even">
<td align="right">29644</td>
<td align="right">71867</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="odd">
<td align="right">29653</td>
<td align="right">71858</td>
<td align="left">2008-06-01</td>
</tr>
<tr class="even">
<td align="right">29660</td>
<td align="right">71796</td>
<td align="left">2008-06-01</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="the-apply-operator" class="section level3">
<h3><span class="header-section-number">1.6.2</span> The Apply Operator</h3>
<p>Using an apply operator and a table function can achieve something similar to a correlated query, but in less complicated code. A CROSS APPLY applies the right table expression to each row in the left table, a bit like the correlated sub-query, with CROSS APPLY being similar to a CROSS JOIN.</p>
<p>Similarily OUTER APPLY adds rows for those with NULL in columns for the right table, similar to LEFT OUTER JOIN. In these instances, the right table is the table returned by the APPLY function.</p>
<p>The first thing we need to do is to create a function. Notice we are passing the function the SalesOrderID, and the most expensive item in the order gets passed back.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- Setup</span>
<span class="kw">CREATE</span> <span class="kw">FUNCTION</span> SalesLT.udfMaxUnitPrice (@SalesOrderID <span class="dt">int</span>)
RETURNS <span class="kw">TABLE</span>
<span class="kw">AS</span>
<span class="kw">RETURN</span>
<span class="kw">SELECT</span> SalesOrderID,<span class="fu">Max</span>(UnitPrice) <span class="kw">as</span> MaxUnitPrice <span class="kw">FROM</span> 
SalesLT.SalesOrderDetail
<span class="kw">WHERE</span> SalesOrderID=@SalesOrderID
<span class="kw">GROUP</span> <span class="kw">BY</span> SalesOrderID;</code></pre></div>
<p>To see what code created a function, to help understand what it does at a later time or if created by someone else, we can use the sp_helptext command.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql">sp_helptext <span class="st">&#39;saleslt.udfmaxunitprice&#39;</span></code></pre></div>
<div class="knitsql-table">
<table>
<thead>
<tr class="header">
<th align="left">Text</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">– Setup</td>
</tr>
</tbody>
</table>
<p>CREATE FUNCTION SalesLT.udfMaxUnitPrice (<span class="citation">(<span class="citeproc-not-found" data-reference-id="SalesOrderID"><strong>???</strong></span>)</span> int) RETURNS TABLE AS RETURN SELECT SalesOrderID,Max(UnitPrice) as MaxUnitPrice FROM SalesLT.SalesOrderDetail WHERE <a href="mailto:SalesOrderID=@SalesOrderID">SalesOrderID=@SalesOrderID</a> GROUP BY SalesOrderID; |</p>
</div>
<p>Then we can use that query to get the results. Note this could have been achieved with a correlated sub-query, but this is perahps a little easier to interpret.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> SOH.SalesOrderID, MUP.MaxUnitPrice 
<span class="kw">FROM</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> SOH
<span class="kw">CROSS</span> APPLY SalesLT.udfMaxUnitPrice(SOH.SalesOrderID) <span class="kw">AS</span> MUP
<span class="kw">ORDER</span> <span class="kw">BY</span> SOH.SalesOrderID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-85">Table 1.71: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">SalesOrderID</th>
<th align="right">MaxUnitPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">71774</td>
<td align="right">356.898</td>
</tr>
<tr class="even">
<td align="right">71774</td>
<td align="right">356.898</td>
</tr>
<tr class="odd">
<td align="right">71776</td>
<td align="right">63.900</td>
</tr>
<tr class="even">
<td align="right">71780</td>
<td align="right">1391.994</td>
</tr>
<tr class="odd">
<td align="right">71780</td>
<td align="right">1391.994</td>
</tr>
<tr class="even">
<td align="right">71780</td>
<td align="right">1391.994</td>
</tr>
<tr class="odd">
<td align="right">71780</td>
<td align="right">1391.994</td>
</tr>
<tr class="even">
<td align="right">71780</td>
<td align="right">1391.994</td>
</tr>
<tr class="odd">
<td align="right">71780</td>
<td align="right">1391.994</td>
</tr>
<tr class="even">
<td align="right">71780</td>
<td align="right">1391.994</td>
</tr>
</tbody>
</table>
</div>
<p>Key Points:</p>
<ul>
<li>The APPLY operator enables you to execute a table-valued function for each row in a rowset returned by a SELECT statement. Conceptually, this approach is similar to a correlated subquery.</li>
<li>CROSS APPLY returns matching rows, similar to an inner join. OUTER APPLY returns all rows in the original SELECT query results with NULL values for rows where no match was found.</li>
</ul>
</div>
<div id="lab-exercises-5" class="section level3">
<h3><span class="header-section-number">1.6.3</span> Lab Exercises</h3>
<p>AdventureWorks products each have a standard cost that indicates the cost of manufacturing the product, and a list price that indicates the recommended selling price for the product. This data is stored in the SalesLT.Product table.</p>
<p>Whenever a product is ordered, the actual unit price at which it was sold is also recorded in the SalesLT.SalesOrderDetail table.</p>
<p>Use subqueries to compare the cost and list prices for each product with the unit prices charged in each sale.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ProductID, Name, ListPrice
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">WHERE</span> ListPrice &gt;
    (<span class="kw">SELECT</span> <span class="fu">AVG</span>(UnitPRice) <span class="kw">FROM</span> SalesLT.SalesOrderDetail)
<span class="kw">ORDER</span> <span class="kw">BY</span> ProductID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-86">Table 1.72: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">ProductID</th>
<th align="left">Name</th>
<th align="right">ListPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">680</td>
<td align="left">HL Road Frame - Black, 58</td>
<td align="right">1431.50</td>
</tr>
<tr class="even">
<td align="right">706</td>
<td align="left">HL Road Frame - Red, 58</td>
<td align="right">1431.50</td>
</tr>
<tr class="odd">
<td align="right">717</td>
<td align="left">HL Road Frame - Red, 62</td>
<td align="right">1431.50</td>
</tr>
<tr class="even">
<td align="right">718</td>
<td align="left">HL Road Frame - Red, 44</td>
<td align="right">1431.50</td>
</tr>
<tr class="odd">
<td align="right">719</td>
<td align="left">HL Road Frame - Red, 48</td>
<td align="right">1431.50</td>
</tr>
<tr class="even">
<td align="right">720</td>
<td align="left">HL Road Frame - Red, 52</td>
<td align="right">1431.50</td>
</tr>
<tr class="odd">
<td align="right">721</td>
<td align="left">HL Road Frame - Red, 56</td>
<td align="right">1431.50</td>
</tr>
<tr class="even">
<td align="right">731</td>
<td align="left">ML Road Frame - Red, 44</td>
<td align="right">594.83</td>
</tr>
<tr class="odd">
<td align="right">732</td>
<td align="left">ML Road Frame - Red, 48</td>
<td align="right">594.83</td>
</tr>
<tr class="even">
<td align="right">733</td>
<td align="left">ML Road Frame - Red, 52</td>
<td align="right">594.83</td>
</tr>
</tbody>
</table>
</div>
<p>AdventureWorks is interested in finding out which products are being sold at a loss. Retrieve the product ID, name, and list price for each product where the list price is 100 or more, and the product has been sold for (strictly) less than 100.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ProductID, Name, ListPrice
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">WHERE</span> ProductID <span class="kw">IN</span>
  (<span class="kw">SELECT</span> ProductID <span class="kw">FROM</span> SalesLT.SalesOrderDetail
   <span class="kw">WHERE</span> UnitPrice &lt; <span class="dv">100</span>)
<span class="kw">AND</span> ListPrice &gt;= <span class="dv">100</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> ProductID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-87">Table 1.73: </span>7 records</caption>
<thead>
<tr class="header">
<th align="right">ProductID</th>
<th align="left">Name</th>
<th align="right">ListPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">810</td>
<td align="left">HL Mountain Handlebars</td>
<td align="right">120.27</td>
</tr>
<tr class="even">
<td align="right">813</td>
<td align="left">HL Road Handlebars</td>
<td align="right">120.27</td>
</tr>
<tr class="odd">
<td align="right">876</td>
<td align="left">Hitch Rack - 4-Bike</td>
<td align="right">120.00</td>
</tr>
<tr class="even">
<td align="right">894</td>
<td align="left">Rear Derailleur</td>
<td align="right">121.46</td>
</tr>
<tr class="odd">
<td align="right">907</td>
<td align="left">Rear Brakes</td>
<td align="right">106.50</td>
</tr>
<tr class="even">
<td align="right">948</td>
<td align="left">Front Brakes</td>
<td align="right">106.50</td>
</tr>
<tr class="odd">
<td align="right">996</td>
<td align="left">HL Bottom Bracket</td>
<td align="right">121.49</td>
</tr>
</tbody>
</table>
</div>
<p>In order to get an idea of how many products are selling above or below list price, you want to gather some aggregate product data. Retrieve the product ID, name, cost, and list price for each product along with the average unit price for which that product has been sold.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ProductID, Name, StandardCost, ListPrice,
    (<span class="kw">SELECT</span> <span class="fu">AVG</span>(UnitPrice)
    <span class="kw">FROM</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> SOD
    <span class="kw">WHERE</span> P.ProductID = SOD.ProductID) <span class="kw">AS</span> AvgSellingPrice
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> P
<span class="kw">ORDER</span> <span class="kw">BY</span> P.ProductID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-88">Table 1.74: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">ProductID</th>
<th align="left">Name</th>
<th align="right">StandardCost</th>
<th align="right">ListPrice</th>
<th align="right">AvgSellingPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">680</td>
<td align="left">HL Road Frame - Black, 58</td>
<td align="right">1059.3100</td>
<td align="right">1431.50</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">706</td>
<td align="left">HL Road Frame - Red, 58</td>
<td align="right">1059.3100</td>
<td align="right">1431.50</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">707</td>
<td align="left">Sport-100 Helmet, Red</td>
<td align="right">13.0863</td>
<td align="right">34.99</td>
<td align="right">20.9940</td>
</tr>
<tr class="even">
<td align="right">708</td>
<td align="left">Sport-100 Helmet, Black</td>
<td align="right">13.0863</td>
<td align="right">34.99</td>
<td align="right">20.6441</td>
</tr>
<tr class="odd">
<td align="right">709</td>
<td align="left">Mountain Bike Socks, M</td>
<td align="right">3.3963</td>
<td align="right">9.50</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">710</td>
<td align="left">Mountain Bike Socks, L</td>
<td align="right">3.3963</td>
<td align="right">9.50</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">711</td>
<td align="left">Sport-100 Helmet, Blue</td>
<td align="right">13.0863</td>
<td align="right">34.99</td>
<td align="right">20.7440</td>
</tr>
<tr class="even">
<td align="right">712</td>
<td align="left">AWC Logo Cap</td>
<td align="right">6.9223</td>
<td align="right">8.99</td>
<td align="right">5.3740</td>
</tr>
<tr class="odd">
<td align="right">713</td>
<td align="left">Long-Sleeve Logo Jersey, S</td>
<td align="right">38.4923</td>
<td align="right">49.99</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">714</td>
<td align="left">Long-Sleeve Logo Jersey, M</td>
<td align="right">38.4923</td>
<td align="right">49.99</td>
<td align="right">29.9940</td>
</tr>
</tbody>
</table>
</div>
<p>AdventureWorks is interested in finding out which products are costing more than they’re being sold for, on average. Filter the query for the previous exercise to include only products where the cost is higher than the average selling price.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> ProductID, Name, StandardCost, ListPrice,
    (<span class="kw">SELECT</span> <span class="fu">AVG</span>(UnitPrice)
     <span class="kw">FROM</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> SOD
     <span class="kw">WHERE</span> P.ProductID = SOD.ProductID) <span class="kw">AS</span> AvgSellingPrice
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> P
<span class="kw">WHERE</span> StandardCost &gt;
    (<span class="kw">SELECT</span> <span class="fu">AVG</span>(UnitPrice)
     <span class="kw">FROM</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> SOD
     <span class="kw">WHERE</span> P.ProductID = SOD.ProductID)
<span class="kw">ORDER</span> <span class="kw">BY</span> P.ProductID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-89">Table 1.75: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">ProductID</th>
<th align="left">Name</th>
<th align="right">StandardCost</th>
<th align="right">ListPrice</th>
<th align="right">AvgSellingPrice</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">712</td>
<td align="left">AWC Logo Cap</td>
<td align="right">6.9223</td>
<td align="right">8.99</td>
<td align="right">5.374</td>
</tr>
<tr class="even">
<td align="right">714</td>
<td align="left">Long-Sleeve Logo Jersey, M</td>
<td align="right">38.4923</td>
<td align="right">49.99</td>
<td align="right">29.994</td>
</tr>
<tr class="odd">
<td align="right">715</td>
<td align="left">Long-Sleeve Logo Jersey, L</td>
<td align="right">38.4923</td>
<td align="right">49.99</td>
<td align="right">29.744</td>
</tr>
<tr class="even">
<td align="right">716</td>
<td align="left">Long-Sleeve Logo Jersey, XL</td>
<td align="right">38.4923</td>
<td align="right">49.99</td>
<td align="right">29.994</td>
</tr>
<tr class="odd">
<td align="right">717</td>
<td align="left">HL Road Frame - Red, 62</td>
<td align="right">868.6342</td>
<td align="right">1431.50</td>
<td align="right">858.900</td>
</tr>
<tr class="even">
<td align="right">718</td>
<td align="left">HL Road Frame - Red, 44</td>
<td align="right">868.6342</td>
<td align="right">1431.50</td>
<td align="right">858.900</td>
</tr>
<tr class="odd">
<td align="right">722</td>
<td align="left">LL Road Frame - Black, 58</td>
<td align="right">204.6251</td>
<td align="right">337.22</td>
<td align="right">202.332</td>
</tr>
<tr class="even">
<td align="right">738</td>
<td align="left">LL Road Frame - Black, 52</td>
<td align="right">204.6251</td>
<td align="right">337.22</td>
<td align="right">202.332</td>
</tr>
<tr class="odd">
<td align="right">792</td>
<td align="left">Road-250 Red, 58</td>
<td align="right">1554.9479</td>
<td align="right">2443.35</td>
<td align="right">1466.010</td>
</tr>
<tr class="even">
<td align="right">793</td>
<td align="left">Road-250 Black, 44</td>
<td align="right">1554.9479</td>
<td align="right">2443.35</td>
<td align="right">1466.010</td>
</tr>
</tbody>
</table>
</div>
<p>The AdventureWorksLT database includes a table-valued user-defined function named dbo.ufnGetCustomerInformation. Use this function to retrieve details of customers based on customer ID values retrieved from tables in the database.</p>
<p>Retrieve the sales order ID, customer ID, first name, last name, and total due for all sales orders from the SalesLT.SalesOrderHeader table and the dbo.ufnGetCustomerInformation function.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> SOH.SalesOrderID, SOH.CustomerID, CI.FirstName, CI.LastName, SOH.TotalDue
<span class="kw">FROM</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> SOH
<span class="kw">CROSS</span> APPLY dbo.ufnGetCustomerInformation(SOH.CustomerID) <span class="kw">AS</span> CI
<span class="kw">ORDER</span> <span class="kw">BY</span> SOH.SalesOrderID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-90">Table 1.76: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">SalesOrderID</th>
<th align="right">CustomerID</th>
<th align="left">FirstName</th>
<th align="left">LastName</th>
<th align="right">TotalDue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">71774</td>
<td align="right">29847</td>
<td align="left">David</td>
<td align="left">Hodgson</td>
<td align="right">972.7850</td>
</tr>
<tr class="even">
<td align="right">71776</td>
<td align="right">30072</td>
<td align="left">Andrea</td>
<td align="left">Thomsen</td>
<td align="right">87.0851</td>
</tr>
<tr class="odd">
<td align="right">71780</td>
<td align="right">30113</td>
<td align="left">Raja</td>
<td align="left">Venugopal</td>
<td align="right">42452.6519</td>
</tr>
<tr class="even">
<td align="right">71782</td>
<td align="right">29485</td>
<td align="left">Catherine</td>
<td align="left">Abel</td>
<td align="right">43962.7901</td>
</tr>
<tr class="odd">
<td align="right">71783</td>
<td align="right">29957</td>
<td align="left">Kevin</td>
<td align="left">Liu</td>
<td align="right">92663.5609</td>
</tr>
<tr class="even">
<td align="right">71784</td>
<td align="right">29736</td>
<td align="left">Terry</td>
<td align="left">Eminhizer</td>
<td align="right">119960.8240</td>
</tr>
<tr class="odd">
<td align="right">71796</td>
<td align="right">29660</td>
<td align="left">Anthony</td>
<td align="left">Chor</td>
<td align="right">63686.2708</td>
</tr>
<tr class="even">
<td align="right">71797</td>
<td align="right">29796</td>
<td align="left">Jon</td>
<td align="left">Grande</td>
<td align="right">86222.8072</td>
</tr>
<tr class="odd">
<td align="right">71815</td>
<td align="right">30089</td>
<td align="left">Michael John</td>
<td align="left">Troyer</td>
<td align="right">1261.4440</td>
</tr>
<tr class="even">
<td align="right">71816</td>
<td align="right">30027</td>
<td align="left">Joseph</td>
<td align="left">Mitzner</td>
<td align="right">3754.9733</td>
</tr>
</tbody>
</table>
</div>
<p>Use the table-valued user-defined function dbo.ufnGetCustomerInformation again to retrieve details of customers based on customer ID values retrieved from tables in the database. Retrieve the customer ID, first name, last name, address line 1 and city for all customers from the SalesLT.Address and SalesLT.CustomerAddress tables, using the dbo.ufnGetCustomerInformation function.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> CA.CustomerID, CI.FirstName, CI.LastName, A.AddressLine1, A.City
<span class="kw">FROM</span> SalesLT.Address <span class="kw">AS</span> A
<span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> CA
<span class="kw">ON</span> A.AddressID = CA.AddressID
<span class="kw">CROSS</span> APPLY dbo.ufnGetCustomerInformation(CA.CustomerID) <span class="kw">AS</span> CI
<span class="kw">ORDER</span> <span class="kw">BY</span> CA.CustomerID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-91">Table 1.77: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">CustomerID</th>
<th align="left">FirstName</th>
<th align="left">LastName</th>
<th align="left">AddressLine1</th>
<th align="left">City</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">29485</td>
<td align="left">Catherine</td>
<td align="left">Abel</td>
<td align="left">57251 Serene Blvd</td>
<td align="left">Van Nuys</td>
</tr>
<tr class="even">
<td align="right">29486</td>
<td align="left">Kim</td>
<td align="left">Abercrombie</td>
<td align="left">Tanger Factory</td>
<td align="left">Branch</td>
</tr>
<tr class="odd">
<td align="right">29489</td>
<td align="left">Frances</td>
<td align="left">Adams</td>
<td align="left">6900 Sisk Road</td>
<td align="left">Modesto</td>
</tr>
<tr class="even">
<td align="right">29490</td>
<td align="left">Margaret</td>
<td align="left">Smith</td>
<td align="left">Lewiston Mall</td>
<td align="left">Lewiston</td>
</tr>
<tr class="odd">
<td align="right">29492</td>
<td align="left">Jay</td>
<td align="left">Adams</td>
<td align="left">Blue Ridge Mall</td>
<td align="left">Kansas City</td>
</tr>
<tr class="even">
<td align="right">29494</td>
<td align="left">Samuel</td>
<td align="left">Agcaoili</td>
<td align="left">No. 25800-130 King Street West</td>
<td align="left">Toronto</td>
</tr>
<tr class="odd">
<td align="right">29496</td>
<td align="left">Robert</td>
<td align="left">Ahlering</td>
<td align="left">6500 East Grant Road</td>
<td align="left">Tucson</td>
</tr>
<tr class="even">
<td align="right">29497</td>
<td align="left">François</td>
<td align="left">Ferrier</td>
<td align="left">Eastridge Mall</td>
<td align="left">Casper</td>
</tr>
<tr class="odd">
<td align="right">29499</td>
<td align="left">Amy</td>
<td align="left">Alberts</td>
<td align="left">252851 Rowan Place</td>
<td align="left">Richmond</td>
</tr>
<tr class="even">
<td align="right">29502</td>
<td align="left">Paul</td>
<td align="left">Alcorn</td>
<td align="left">White Mountain Mall</td>
<td align="left">Rock Springs</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="using-table-expressions" class="section level2">
<h2><span class="header-section-number">1.7</span> Using Table Expressions</h2>
<p>We can create tables in a number of ways that can then be re-usd, rather than being a one-off query.</p>
<div id="views" class="section level3">
<h3><span class="header-section-number">1.7.1</span> Views</h3>
<p>One way we can do this is using a view. Rather than repeatadly joining and selected fields from two tables, we can create a view that contains the join syntax then just select the view. This view can be used and queried as if it were a table. The data is still in the underlying tables, but it is a view or presentation on top of the tables. It’s like a named query, which can make this simpler, plus we can add data at the view level, so they can view rights for the view table, but not the underlying data. Note that whilst you are able to use insert to add new rows, you can only do this to one of the underlying tables.</p>
<p>First we create a view</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="co">-- Create a view</span>
<span class="kw">CREATE</span> <span class="kw">VIEW</span> SalesLT.vCustomerAddress
<span class="kw">AS</span>
<span class="kw">SELECT</span> C.CustomerID, FirstName, LastName, AddressLine1, City, StateProvince 
<span class="kw">FROM</span>
SalesLT.Customer C <span class="kw">JOIN</span> SalesLT.CustomerAddress CA
<span class="kw">ON</span> C.CustomerID=CA.CustomerID
<span class="kw">JOIN</span> SalesLT.Address A
<span class="kw">ON</span> CA.AddressID=A.AddressID</code></pre></div>
<p>Then we can query the view.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> CustomerID, City
<span class="kw">FROM</span> SalesLT.vCustomerAddress</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-93">Table 1.78: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">CustomerID</th>
<th align="left">City</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">29698</td>
<td align="left">Burnaby</td>
</tr>
<tr class="even">
<td align="right">29997</td>
<td align="left">Seattle</td>
</tr>
<tr class="odd">
<td align="right">29854</td>
<td align="left">Joliet</td>
</tr>
<tr class="even">
<td align="right">30027</td>
<td align="left">Oxnard</td>
</tr>
<tr class="odd">
<td align="right">30023</td>
<td align="left">Peoria</td>
</tr>
<tr class="even">
<td align="right">29637</td>
<td align="left">Irving</td>
</tr>
<tr class="odd">
<td align="right">29545</td>
<td align="left">Bothell</td>
</tr>
<tr class="even">
<td align="right">29890</td>
<td align="left">Port Orchard</td>
</tr>
<tr class="odd">
<td align="right">29772</td>
<td align="left">Austin</td>
</tr>
<tr class="even">
<td align="right">29883</td>
<td align="left">Denver</td>
</tr>
</tbody>
</table>
</div>
<p>And we can join data to that view.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> c.StateProvince, c.City, ISNULL(<span class="fu">SUM</span>(s.TotalDue), <span class="fl">0.00</span>) <span class="kw">AS</span> Revenue
<span class="kw">FROM</span> SalesLT.vCustomerAddress <span class="kw">AS</span> c
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> s
<span class="kw">ON</span> s.CustomerID = c.CustomerID
<span class="kw">GROUP</span> <span class="kw">BY</span> c.StateProvince, c.City
<span class="kw">ORDER</span> <span class="kw">BY</span> c.StateProvince, Revenue <span class="kw">DESC</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-94">Table 1.79: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">StateProvince</th>
<th align="left">City</th>
<th align="right">Revenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Alberta</td>
<td align="left">Calgary</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Alberta</td>
<td align="left">Edmonton</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Arizona</td>
<td align="left">Chandler</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Arizona</td>
<td align="left">Gilbert</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Arizona</td>
<td align="left">Mesa</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Arizona</td>
<td align="left">Phoenix</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Arizona</td>
<td align="left">Scottsdale</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Arizona</td>
<td align="left">Surprise</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Arizona</td>
<td align="left">Tucson</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">British Columbia</td>
<td align="left">Vancouver</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="using-temporary-tables-and-table-variables" class="section level3">
<h3><span class="header-section-number">1.7.2</span> Using Temporary Tables and Table Variables</h3>
<p>Views are persistent database objects, however we might want a temporary table. We prefix the object with a # symbol and they are created in a seperate temporary database called tempdb, rather than the db you are working in. Typically using a single # will mean the table exists for the current user session. If you wanted it to persistent over multiple sessions, use the ## prefix.</p>
<p>An alternative approach is to use table variables, which were introduced to cause performance problems if used again, as the table has to be re-created each user session, which can become a problem if there are many tables. If we want to use one we prefix it with an @ sign to signify it is a variable e.g. <span class="citation">(<span class="citeproc-not-found" data-reference-id="varProducts"><strong>???</strong></span>)</span> table so we define the variable as a table. This is connected to the batch rather than the session, so as long as we are in the block of code. It only works well on small databases or queries. They are for temporary situations or a temporary holding space.</p>
<p>In the next block of code we show how we create a temporary table then update and query it.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> <span class="kw">TABLE</span> #Colors
(Color <span class="dt">varchar</span>(<span class="dv">15</span>));

<span class="kw">INSERT</span> <span class="kw">INTO</span> #Colors
<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> Color <span class="kw">FROM</span> SalesLT.Product;

<span class="kw">SELECT</span> * <span class="kw">FROM</span> #Colors;</code></pre></div>
<p>A table variable is similar, with some syntax differences, but this works on the code set (batch of commans ran at the same time) rather than being for the entire session.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">DECLARE</span> @Colors <span class="kw">AS</span> <span class="kw">TABLE</span> (Color <span class="dt">varchar</span>(<span class="dv">15</span>));

<span class="kw">INSERT</span> <span class="kw">INTO</span> @Colors
<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> Color <span class="kw">FROM</span> SalesLT.Product;

<span class="kw">SELECT</span> * <span class="kw">FROM</span> @Colors;</code></pre></div>
<p>Key Points</p>
<ul>
<li>Temporary tables are prefixed with a # symbol (You can also create global temporary tables that can be accessed by other processes by prefixing the name with ##)</li>
<li>Local temporary tables are automatically deleted when the session in which they were created ends. Global temporary tables are deleted when the last user sessions referencing them is closed.</li>
<li>Table variables are prefixed with a @ symbol.</li>
<li>Table variables are scoped to the batch in which they are created.</li>
</ul>
</div>
<div id="table-value-functions-tvf" class="section level3">
<h3><span class="header-section-number">1.7.3</span> Table Value Functions (TVF)</h3>
<p>This is a specific type of function which returns a table. It is a permanently define database object. Unlike views, we can pass values in to a TVF.</p>
<p>So first we create a TVF.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> <span class="kw">FUNCTION</span> SalesLT.udfCustomersByCity
(@City <span class="kw">AS</span> <span class="dt">VARCHAR</span>(<span class="dv">20</span>))
RETURNS <span class="kw">TABLE</span>
<span class="kw">AS</span>
<span class="kw">RETURN</span>
    (<span class="kw">SELECT</span> C.CustomerID, FirstName, LastName, AddressLine1, City, StateProvince
     <span class="kw">FROM</span> SalesLT.Customer C <span class="kw">JOIN</span> SalesLT.CustomerAddress CA
     <span class="kw">ON</span> C.CustomerID=CA.CustomerID
     <span class="kw">JOIN</span> SalesLT.Address A <span class="kw">ON</span> CA.AddressID=A.AddressID
     <span class="kw">WHERE</span> City=@City);</code></pre></div>
<p>Then we can call the TVF passing a parameter - in this instance we prvoide a city name of Bellevue - which will then return the results of the SELECT statement which is a list of customers in that city.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> * <span class="kw">FROM</span> SalesLT.udfCustomersByCity(<span class="st">&#39;Bellevue&#39;</span>)</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-98">Table 1.80: </span>2 records</caption>
<thead>
<tr class="header">
<th align="right">CustomerID</th>
<th align="left">FirstName</th>
<th align="left">LastName</th>
<th align="left">AddressLine1</th>
<th align="left">City</th>
<th align="left">StateProvince</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">29559</td>
<td align="left">Robert</td>
<td align="left">Bernacchi</td>
<td align="left">2681 Eagle Peak</td>
<td align="left">Bellevue</td>
<td align="left">Washington</td>
</tr>
<tr class="even">
<td align="right">29559</td>
<td align="left">Robert</td>
<td align="left">Bernacchi</td>
<td align="left">25915 140th Ave Ne</td>
<td align="left">Bellevue</td>
<td align="left">Washington</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="derived-tables" class="section level3">
<h3><span class="header-section-number">1.7.4</span> Derived Tables</h3>
<p>These are derived tables that return a multi column table. They are a virtual table to simplify a query. The table only exists within that SELECT query. It is a programming construct within a SELECT statement, it is used for programming purposes. They can use internal (aka inline) within the derived table element, or external aliases for columns - outside the () of the derived table.</p>
<p>In the example derived table below, the alias ProdCats is provided external to the query (outside the parentheses). Other elements such as Category as defined as internal aliases.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> <span class="kw">Category</span>, <span class="fu">COUNT</span>(ProductID) <span class="kw">AS</span> Products
<span class="kw">FROM</span>
    (<span class="kw">SELECT</span> p.ProductID, p.Name <span class="kw">AS</span> Product, c.Name <span class="kw">AS</span> <span class="kw">Category</span>
     <span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> p
     <span class="kw">JOIN</span> SalesLT.ProductCategory <span class="kw">AS</span> c
     <span class="kw">ON</span> p.ProductCategoryID = c.ProductCategoryID) <span class="kw">AS</span> ProdCats
<span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">Category</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">Category</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-99">Table 1.81: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Category</th>
<th align="right">Products</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Bib-Shorts</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Bike Racks</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Bike Stands</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Bottles and Cages</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Bottom Brackets</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Brakes</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Caps</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Chains</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Cleaners</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Cranksets</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="using-common-table-expressions-ctes" class="section level3">
<h3><span class="header-section-number">1.7.5</span> Using Common Table Expressions (CTEs)</h3>
<p>Similar to a TVF before we are defining a temporary table object which is used within the scope of the query. But this time aorund we define the CTE first, then make calls to that CTE afterwards. Unlike a derived query however, you can refer to the CTE mutiple times within the same query/code batch, but it won’t live on like a view. We can also use a CTE for recursive elements like loops, so you might want to get everyone within a management tier, then say you want to go through that process three times for the top 3 levels, using the OPTION(MAXRECURSION 3).</p>
<p>So in the following example, we first define the CTE, then we make reference to it. The result here is the same as our derived query previously, but perhaps a little easiter to understand.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">WITH</span> ProductsByCategory (ProductID, ProductName, <span class="kw">Category</span>)
<span class="kw">AS</span>
(
    <span class="kw">SELECT</span> p.ProductID, p.Name, c.Name <span class="kw">AS</span> <span class="kw">Category</span>
     <span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> p
     <span class="kw">JOIN</span> SalesLT.ProductCategory <span class="kw">AS</span> c
     <span class="kw">ON</span> p.ProductCategoryID = c.ProductCategoryID
)

<span class="kw">SELECT</span> <span class="kw">Category</span>, <span class="fu">COUNT</span>(ProductID) <span class="kw">AS</span> Products
<span class="kw">FROM</span> ProductsByCategory
<span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">Category</span>
<span class="kw">ORDER</span> <span class="kw">BY</span> <span class="kw">Category</span>;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-100">Table 1.82: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Category</th>
<th align="right">Products</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Bib-Shorts</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Bike Racks</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Bike Stands</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Bottles and Cages</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Bottom Brackets</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Brakes</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Caps</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Chains</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Cleaners</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Cranksets</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
</div>
<p>Next we will look at the our organisation chart example as previously mentioned. First let’s look at our employee table.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> * <span class="kw">FROM</span> SalesLT.Employee</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-101">Table 1.83: </span>9 records</caption>
<thead>
<tr class="header">
<th align="left">EmployeeID</th>
<th align="left">EmployeeName</th>
<th align="right">ManagerID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">adventure-works8</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">adventure-works1</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">adventure-works0</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">adventure-works0</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">adventure-works1</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="left">adventure-works3</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="left">adventure-works9</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="left">adventure-works0</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="left">adventure-works0</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
</div>
<p>We can see that each employee has a manager ID apart from Employee 3 who is the CEO/MD. So we have a hierarchy of employees. We will go 3 levels deep this time (three recursions).</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">WITH</span> OrgReport (ManagerID, EmployeeID, EmployeeName, <span class="kw">Level</span>)
<span class="kw">AS</span>
(
    <span class="co">-- Anchor query</span>
    <span class="kw">SELECT</span> e.ManagerID, e.EmployeeID, EmployeeName, <span class="dv">0</span>
    <span class="kw">FROM</span> SalesLT.Employee <span class="kw">AS</span> e
    <span class="kw">WHERE</span> ManagerID <span class="kw">IS</span> <span class="kw">NULL</span>

    <span class="kw">UNION</span> <span class="kw">ALL</span>

    <span class="co">-- Recursive query</span>
    <span class="kw">SELECT</span> e.ManagerID, e.EmployeeID, e.EmployeeName, <span class="kw">Level</span> + <span class="dv">1</span>
    <span class="kw">FROM</span> SalesLT.Employee <span class="kw">AS</span> e
    <span class="kw">INNER</span> <span class="kw">JOIN</span> OrgReport <span class="kw">AS</span> o <span class="kw">ON</span> e.ManagerID = o.EmployeeID
)

<span class="kw">SELECT</span> * <span class="kw">FROM</span> OrgReport
<span class="kw">OPTION</span> (MAXRECURSION <span class="dv">3</span>);</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-102">Table 1.84: </span>9 records</caption>
<thead>
<tr class="header">
<th align="right">ManagerID</th>
<th align="right">EmployeeID</th>
<th align="left">EmployeeName</th>
<th align="right">Level</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">NA</td>
<td align="right">3</td>
<td align="left">adventure-works0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">4</td>
<td align="left">adventure-works0</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">6</td>
<td align="left">adventure-works3</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">3</td>
<td align="right">8</td>
<td align="left">adventure-works0</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">9</td>
<td align="left">adventure-works0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">9</td>
<td align="right">7</td>
<td align="left">adventure-works9</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">8</td>
<td align="right">1</td>
<td align="left">adventure-works8</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2</td>
<td align="left">adventure-works1</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">5</td>
<td align="left">adventure-works1</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
</div>
<p>Key Points</p>
<ul>
<li>A derived table is a subquery that generates a multicolumn rowset. You must use the AS clause to define an alias for a derived query.</li>
<li>Common Table Expressions (CTEs) provide a more intuitive syntax or defining rowsets than derived tables, and can be used mulitple times in the same query.</li>
<li>You can use CTEs to define recursive queries.</li>
</ul>
</div>
<div id="lab-exercises-6" class="section level3">
<h3><span class="header-section-number">1.7.6</span> Lab Exercises</h3>
<p>AdventureWorks sells many products that are variants of the same product model. You must write queries that retrieve information about these products. Retrieve the product ID, product name, product model name, and product model summary for each product from the SalesLT.Product table and the SalesLT.vProductModelCatalogDescription view.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> P.ProductID, P.Name <span class="kw">AS</span> ProductName, PM.Name <span class="kw">AS</span> ProductModel, PM.Summary
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> P
<span class="kw">JOIN</span> SalesLT.vProductModelCatalogDescription <span class="kw">AS</span> PM
<span class="kw">ON</span> P.ProductModelID = PM.ProductModelID
<span class="kw">ORDER</span> <span class="kw">BY</span> ProductID;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-103">Table 1.85: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ProductID</th>
<th align="left">ProductName</th>
<th align="left">ProductModel</th>
<th align="left">Summary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">749</td>
<td align="left">Road-150 Red, 62</td>
<td align="left">Road-150</td>
<td align="left">This bike is ridden by race winners. Developed with the</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left">Adventure Works Cyc</td>
<td align="left">les professiona</td>
<td align="left">l race team, it has a extremely light</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">heat-treated alumin</td>
<td align="left">um frame, and s</td>
<td align="left">teering that allows precision control.</td>
</tr>
<tr class="even">
<td align="left">750</td>
<td align="left">Road-150 Red, 44</td>
<td align="left">Road-150</td>
<td align="left">This bike is ridden by race winners. Developed with the</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">Adventure Works Cyc</td>
<td align="left">les professiona</td>
<td align="left">l race team, it has a extremely light</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left">heat-treated alumin</td>
<td align="left">um frame, and s</td>
<td align="left">teering that allows precision control.</td>
</tr>
<tr class="odd">
<td align="left">751</td>
<td align="left">Road-150 Red, 48</td>
<td align="left">Road-150</td>
<td align="left">This bike is ridden by race winners. Developed with the</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left">Adventure Works Cyc</td>
<td align="left">les professiona</td>
<td align="left">l race team, it has a extremely light</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">heat-treated alumin</td>
<td align="left">um frame, and s</td>
<td align="left">teering that allows precision control.</td>
</tr>
<tr class="even">
<td align="left">752</td>
<td align="left">Road-150 Red, 52</td>
<td align="left">Road-150</td>
<td align="left">This bike is ridden by race winners. Developed with the</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">Adventure Works Cyc</td>
<td align="left">les professiona</td>
<td align="left">l race team, it has a extremely light</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left">heat-treated alumin</td>
<td align="left">um frame, and s</td>
<td align="left">teering that allows precision control.</td>
</tr>
<tr class="odd">
<td align="left">753</td>
<td align="left">Road-150 Red, 56</td>
<td align="left">Road-150</td>
<td align="left">This bike is ridden by race winners. Developed with the</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left">Adventure Works Cyc</td>
<td align="left">les professiona</td>
<td align="left">l race team, it has a extremely light</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">heat-treated alumin</td>
<td align="left">um frame, and s</td>
<td align="left">teering that allows precision control.</td>
</tr>
<tr class="even">
<td align="left">754</td>
<td align="left">Road-450 Red, 58</td>
<td align="left">Road-450</td>
<td align="left">A true multi-sport bike that offers streamlined riding and a revolutionary design.</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">Aerodynamic</td>
<td align="left">design lets you</td>
<td align="left">ride with the pros, and the gearing will conquer hilly roads.</td>
</tr>
<tr class="even">
<td align="left">755</td>
<td align="left">Road-450 Red, 60</td>
<td align="left">Road-450</td>
<td align="left">A true multi-sport bike that offers streamlined riding and a revolutionary design.</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">Aerodynamic</td>
<td align="left">design lets you</td>
<td align="left">ride with the pros, and the gearing will conquer hilly roads.</td>
</tr>
<tr class="even">
<td align="left">756</td>
<td align="left">Road-450 Red, 44</td>
<td align="left">Road-450</td>
<td align="left">A true multi-sport bike that offers streamlined riding and a revolutionary design.</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">Aerodynamic</td>
<td align="left">design lets you</td>
<td align="left">ride with the pros, and the gearing will conquer hilly roads.</td>
</tr>
<tr class="even">
<td align="left">757</td>
<td align="left">Road-450 Red, 48</td>
<td align="left">Road-450</td>
<td align="left">A true multi-sport bike that offers streamlined riding and a revolutionary design.</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">Aerodynamic</td>
<td align="left">design lets you</td>
<td align="left">ride with the pros, and the gearing will conquer hilly roads.</td>
</tr>
<tr class="even">
<td align="left">758</td>
<td align="left">Road-450 Red, 52</td>
<td align="left">Road-450</td>
<td align="left">A true multi-sport bike that offers streamlined riding and a revolutionary design.</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">Aerodynamic</td>
<td align="left">design lets you</td>
<td align="left">ride with the pros, and the gearing will conquer hilly roads.</td>
</tr>
</tbody>
</table>
</div>
<p>You are only interested in products which have a listed color in the database. Create a table variable and populate it with a list of distinct colors from the SalesLT.Product table. Then use the table variable to filter a query that returns the product ID, name, and color from the SalesLT.Product table so that only products with a color listed in the table variable are returned.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">DECLARE</span> @Colors <span class="kw">AS</span> <span class="kw">TABLE</span> (Color <span class="dt">NVARCHAR</span>(<span class="dv">15</span>));

<span class="kw">INSERT</span> <span class="kw">INTO</span> @Colors
<span class="kw">SELECT</span> <span class="kw">DISTINCT</span> Color <span class="kw">FROM</span> SalesLT.Product;

<span class="kw">SELECT</span> ProductID, Name, Color
<span class="kw">FROM</span> SalesLT.Product
<span class="kw">WHERE</span> Color <span class="kw">IN</span> (<span class="kw">SELECT</span> Color <span class="kw">FROM</span> @Colors);</code></pre></div>
<p>The AdventureWorksLT database includes a table-valued function named dbo.ufnGetAllCategories, which returns a table of product categories (e.g. ‘Road Bikes’) and parent categories (for example ‘Bikes’). Write a query that uses this function to return a list of all products including their parent category and their own category.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> C.ParentProductCategoryName <span class="kw">AS</span> ParentCategory,
       C.ProductCategoryName <span class="kw">AS</span> <span class="kw">Category</span>,
       P.ProductID, P.Name <span class="kw">AS</span> ProductName
<span class="kw">FROM</span> SalesLT.Product <span class="kw">AS</span> P
<span class="kw">JOIN</span> dbo.ufnGetAllCategories() <span class="kw">AS</span> C
<span class="kw">ON</span> P.ProductCategoryID = C.ProductCategoryID
<span class="kw">ORDER</span> <span class="kw">BY</span> ParentCategory, <span class="kw">Category</span>, ProductName;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-105">Table 1.86: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ParentCategory</th>
<th align="left">Category</th>
<th align="right">ProductID</th>
<th align="left">ProductName</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Bike Racks</td>
<td align="right">876</td>
<td align="left">Hitch Rack - 4-Bike</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Bike Stands</td>
<td align="right">879</td>
<td align="left">All-Purpose Bike Stand</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Bottles and Cages</td>
<td align="right">871</td>
<td align="left">Mountain Bottle Cage</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Bottles and Cages</td>
<td align="right">872</td>
<td align="left">Road Bottle Cage</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Bottles and Cages</td>
<td align="right">870</td>
<td align="left">Water Bottle - 30 oz.</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Cleaners</td>
<td align="right">877</td>
<td align="left">Bike Wash - Dissolver</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Fenders</td>
<td align="right">878</td>
<td align="left">Fender Set - Mountain</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Helmets</td>
<td align="right">708</td>
<td align="left">Sport-100 Helmet, Black</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Helmets</td>
<td align="right">711</td>
<td align="left">Sport-100 Helmet, Blue</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Helmets</td>
<td align="right">707</td>
<td align="left">Sport-100 Helmet, Red</td>
</tr>
</tbody>
</table>
</div>
<p>Each AdventureWorks customer is a retail company with a named contact. You must create queries that return the total revenue for each customer, including the company and customer contact names. Retrieve a list of customers in the format Company (Contact Name) together with the total revenue for each customer. Use a derived table or a common table expression to retrieve the details for each sales order, and then query the derived table or CTE to aggregate and group the data.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> CompanyContact, <span class="fu">SUM</span>(SalesAmount) <span class="kw">AS</span> Revenue
<span class="kw">FROM</span>
    (<span class="kw">SELECT</span> <span class="fu">CONCAT</span>(c.CompanyName, <span class="fu">CONCAT</span>(<span class="st">&#39; (&#39;</span> + c.FirstName + <span class="st">&#39; &#39;</span>, c.LastName + <span class="st">&#39;)&#39;</span>)), SOH.TotalDue
     <span class="kw">FROM</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> SOH
     <span class="kw">JOIN</span> SalesLT.Customer <span class="kw">AS</span> c
     <span class="kw">ON</span> SOH.CustomerID = c.CustomerID) <span class="kw">AS</span> CustomerSales(CompanyContact, SalesAmount)
<span class="kw">GROUP</span> <span class="kw">BY</span> CompanyContact
<span class="kw">ORDER</span> <span class="kw">BY</span> CompanyContact;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-106">Table 1.87: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CompanyContact</th>
<th align="right">Revenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Action Bicycle Specialists (Terry Eminhizer)</td>
<td align="right">119960.8240</td>
</tr>
<tr class="even">
<td align="left">Aerobic Exercise Company (Rosmarie Carroll)</td>
<td align="right">2361.6403</td>
</tr>
<tr class="odd">
<td align="left">Bulk Discount Store (Christopher Beck)</td>
<td align="right">98138.2131</td>
</tr>
<tr class="even">
<td align="left">Central Bicycle Specialists (Janeth Esteves)</td>
<td align="right">43.0437</td>
</tr>
<tr class="odd">
<td align="left">Channel Outlet (Richard Byham)</td>
<td align="right">608.1766</td>
</tr>
<tr class="even">
<td align="left">Closest Bicycle Store (Pamala Kotc)</td>
<td align="right">39531.6085</td>
</tr>
<tr class="odd">
<td align="left">Coalition Bike Company (Donald Blanton)</td>
<td align="right">2669.3183</td>
</tr>
<tr class="even">
<td align="left">Discount Tours (Melissa Marple)</td>
<td align="right">3293.7761</td>
</tr>
<tr class="odd">
<td align="left">Eastside Department Store (Kevin Liu)</td>
<td align="right">92663.5609</td>
</tr>
<tr class="even">
<td align="left">Engineered Bike Systems (Joseph Mitzner)</td>
<td align="right">3754.9733</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="grouping-sets-and-pivoting-data" class="section level2">
<h2><span class="header-section-number">1.8</span> Grouping Sets and Pivoting Data</h2>
<p>These are both ways of summarising data - grouping data includes cubing the data.</p>
<p>Grouping sets allows you to define multiple groupings within the same query. So you may haved a number of subtotals for different product types, then a total of all the subtotals combined.</p>
<p>So you would have something like</p>
<blockquote>
SELECT <list of cols> FROM
<table>
GROUP BY GROUPING SETS (
<col 1>
,
<col 2>
<p>() – empty parentheses if aggregating all rows )</p>
</blockquote>
<p>A result line will appear with NULLs in all column(s) which is the grand total.</p>
<p>There are other ways to aggregate the data such as ROLLUP and CUBE. ROLLUP is useful if you haave hierarchy - people in households, towns in regions. Cube will show every possible aggregation, rather than specifying each aggregation.</p>
Both are specified in the GROUP BY X (<cols>) where x is either ROLLUP or CUBE. You can add in GROUPING_ID
<col>
<p>AS <col_name> fiels to make the interpretation easier when using multiple grouping columns. You can then see the grand total more easily, since it will have a 1 in each groupid column.</p>
<p>So a usual group by might look something like this - with a high level Parent Category followed by a Product Category and a count of items.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> cat.ParentProductCategoryName, cat.ProductCategoryName, <span class="fu">count</span>(prd.ProductID) <span class="kw">AS</span> Products
<span class="kw">FROM</span> SalesLT.vGetAllCategories <span class="kw">as</span> cat
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> prd
<span class="kw">ON</span> prd.ProductCategoryID = cat.ProductcategoryID
<span class="kw">GROUP</span> <span class="kw">BY</span> cat.ParentProductCategoryName, cat.ProductCategoryName
<span class="kw">ORDER</span> <span class="kw">BY</span> cat.ParentProductCategoryName, cat.ProductCategoryName;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-107">Table 1.88: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ParentProductCategoryName</th>
<th align="left">ProductCategoryName</th>
<th align="right">Products</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Bike Racks</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Bike Stands</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Bottles and Cages</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Cleaners</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Fenders</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Helmets</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Hydration Packs</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Lights</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Locks</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Panniers</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<p>Here there are no grand total by parent categories. Also, there might be certain items appear in more than one category without totals e.g. bike racks might be in mutiple parent categories.</p>
<p>Alternatively, we might create GROUPING SETS which also allows us to create totals.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> cat.ParentProductCategoryName, cat.ProductCategoryName, <span class="fu">count</span>(prd.ProductID) <span class="kw">AS</span> Products
<span class="kw">FROM</span> SalesLT.vGetAllCategories <span class="kw">as</span> cat
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> prd
<span class="kw">ON</span> prd.ProductCategoryID = cat.ProductcategoryID
<span class="kw">GROUP</span> <span class="kw">BY</span> <span class="fu">GROUPING</span> SETS(cat.ParentProductCategoryName, cat.ProductCategoryName, ())
<span class="kw">ORDER</span> <span class="kw">BY</span> cat.ParentProductCategoryName, cat.ProductCategoryName;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-108">Table 1.89: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ParentProductCategoryName</th>
<th align="left">ProductCategoryName</th>
<th align="right">Products</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">295</td>
</tr>
<tr class="even">
<td align="left">NA</td>
<td align="left">Bib-Shorts</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">NA</td>
<td align="left">Bike Racks</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">NA</td>
<td align="left">Bike Stands</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">NA</td>
<td align="left">Bottles and Cages</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">NA</td>
<td align="left">Bottom Brackets</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">NA</td>
<td align="left">Brakes</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">NA</td>
<td align="left">Caps</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">NA</td>
<td align="left">Chains</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">NA</td>
<td align="left">Cleaners</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<p>We now start getting totals, we can see there is a total of 295 products, followed by 3 bib-shorts (irrespective of parent), and later in the table we get the totals by parent categories. But we have no loss some of the relationships with parent categories with this query. It is possible to write a query where these things might appear, GROUPING SETS is the most flexible of the grouping commands, but it might be easier to use one of the other grouping options as required, next shows the the ROLLUP command.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> cat.ParentProductCategoryName, cat.ProductCategoryName, <span class="fu">count</span>(prd.ProductID) <span class="kw">AS</span> Products
<span class="kw">FROM</span> SalesLT.vGetAllCategories <span class="kw">as</span> cat
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> prd
<span class="kw">ON</span> prd.ProductCategoryID = cat.ProductcategoryID
<span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">ROLLUP</span> (cat.ParentProductCategoryName, cat.ProductCategoryName)
<span class="kw">ORDER</span> <span class="kw">BY</span> cat.ParentProductCategoryName, cat.ProductCategoryName;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-109">Table 1.90: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ParentProductCategoryName</th>
<th align="left">ProductCategoryName</th>
<th align="right">Products</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">295</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">NA</td>
<td align="right">29</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Bike Racks</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Bike Stands</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Bottles and Cages</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Cleaners</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Fenders</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Helmets</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Accessories</td>
<td align="left">Hydration Packs</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Accessories</td>
<td align="left">Lights</td>
<td align="right">3</td>
</tr>
</tbody>
</table>
</div>
<p>It is now giving us totals for parents and products. However, we are now missing situations where items might appear in more than one parent category e.g. bottles and cages that are in a category other than accessories. So we can use CUBE to get these other aggregation options, which will give us all possible aggregations.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> cat.ParentProductCategoryName, cat.ProductCategoryName, <span class="fu">count</span>(prd.ProductID) <span class="kw">AS</span> Products
<span class="kw">FROM</span> SalesLT.vGetAllCategories <span class="kw">as</span> cat
<span class="kw">LEFT</span> <span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> prd
<span class="kw">ON</span> prd.ProductCategoryID = cat.ProductcategoryID
<span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">CUBE</span> (cat.ParentProductCategoryName, cat.ProductCategoryName)
<span class="kw">ORDER</span> <span class="kw">BY</span> cat.ParentProductCategoryName, cat.ProductCategoryName;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-110">Table 1.91: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">ParentProductCategoryName</th>
<th align="left">ProductCategoryName</th>
<th align="right">Products</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">295</td>
</tr>
<tr class="even">
<td align="left">NA</td>
<td align="left">Bib-Shorts</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">NA</td>
<td align="left">Bike Racks</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">NA</td>
<td align="left">Bike Stands</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">NA</td>
<td align="left">Bottles and Cages</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">NA</td>
<td align="left">Bottom Brackets</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">NA</td>
<td align="left">Brakes</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">NA</td>
<td align="left">Caps</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">NA</td>
<td align="left">Chains</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">NA</td>
<td align="left">Cleaners</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<p>Key Points * Use GROUPING SETS to define custom groupings. * Use ROLLUP to include subtotals and a grand total for hierarchical groupings. * Use CUBE to include all possible groupings.</p>
<div id="pivoting-data" class="section level3">
<h3><span class="header-section-number">1.8.1</span> Pivoting Data</h3>
<p>Pivoting is another form of summarising data. We take row based items and pivot them in to single, summarised, columns in a new table. We simply use the PIVOT command. It is possible to undue this using UNPIVOT however this may loose some of the detail that existed in the original data. For instance line level data, such as which particular clothing items were purchased and at which value, is now lost as we just get a clothing total, but re-orientated to match the original data format.</p>
<p>We might want to be able to see the totals by colour in our data and by cateory. You have to know which columns you wish to create using the PIVOT table, for instance in the code below we are listing the actual colours our in the PIVOT command. If one colour was missed, the query would work, but you obviously wouldn’t get that colour returned or inlcuded in totals.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> * <span class="kw">FROM</span>
    (<span class="kw">SELECT</span> P.ProductID, PC.Name,ISNULL(P.Color, <span class="st">&#39;Uncolored&#39;</span>) <span class="kw">AS</span> Color
     <span class="kw">FROM</span> saleslt.productcategory <span class="kw">AS</span> PC
     <span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> P
     <span class="kw">ON</span> PC.ProductCategoryID=P.ProductCategoryID
     ) <span class="kw">AS</span> PPC
PIVOT(<span class="fu">COUNT</span>(ProductID) <span class="kw">FOR</span> Color <span class="kw">IN</span>([Red],[Blue],[Black],[Silver],[Yellow],[Grey], [Multi], [Uncolored])) <span class="kw">as</span> pvt
<span class="kw">ORDER</span> <span class="kw">BY</span> Name;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-111">Table 1.92: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="right">Red</th>
<th align="right">Blue</th>
<th align="right">Black</th>
<th align="right">Silver</th>
<th align="right">Yellow</th>
<th align="right">Grey</th>
<th align="right">Multi</th>
<th align="right">Uncolored</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Bib-Shorts</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Bike Racks</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Bike Stands</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Bottles and Cages</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">Bottom Brackets</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Brakes</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">2</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Caps</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Chains</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Cleaners</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Cranksets</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
<p>If we wanted to, we could copy/archive this in to a new table, which can be re-used again or compared and retrieved in the future.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> <span class="kw">TABLE</span> #ProductColorPivot
(Name <span class="dt">varchar</span>(<span class="dv">50</span>), Red <span class="dt">int</span>, Blue <span class="dt">int</span>, Black <span class="dt">int</span>, Silver <span class="dt">int</span>, Yellow <span class="dt">int</span>, Grey <span class="dt">int</span> , multi <span class="dt">int</span>, uncolored <span class="dt">int</span>);

<span class="kw">INSERT</span> <span class="kw">INTO</span> #ProductColorPivot
    <span class="kw">SELECT</span> * <span class="kw">FROM</span>
    (<span class="kw">SELECT</span> P.ProductID, PC.Name,ISNULL(P.Color, <span class="st">&#39;Uncolored&#39;</span>) <span class="kw">AS</span> Color
     <span class="kw">FROM</span> saleslt.productcategory <span class="kw">AS</span> PC
     <span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> P
     <span class="kw">ON</span> PC.ProductCategoryID=P.ProductCategoryID
     ) <span class="kw">AS</span> PPC
PIVOT(<span class="fu">COUNT</span>(ProductID) <span class="kw">FOR</span> Color <span class="kw">IN</span>([Red],[Blue],[Black],[Silver],[Yellow],[Grey], [Multi], [Uncolored])) <span class="kw">as</span> pvt
<span class="kw">ORDER</span> <span class="kw">BY</span> Name;</code></pre></div>
<p>If we then wanted to unpvivot the data we would do so as follows.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> Name, Color, ProductCount
<span class="kw">FROM</span>
    (<span class="kw">SELECT</span> Name,
    [Red],[Blue],[Black],[Silver],[Yellow],[Grey], [Multi], [Uncolored]
    <span class="kw">FROM</span> #ProductColorPivot) pcp
UNPIVOT
(ProductCount <span class="kw">FOR</span> Color <span class="kw">IN</span> ([Red],[Blue],[Black],[Silver],[Yellow],[Grey], [Multi], [Uncolored])
) <span class="kw">AS</span> ProductCounts</code></pre></div>
<p>Key Points * Use PIVOT to re-orient a rowset by generating mulitple columns from values in a single column. * Use UNPIVOT to re-orient mulitple columns in a an existing rowset into a single column.</p>
</div>
<div id="lab-exercises-7" class="section level3">
<h3><span class="header-section-number">1.8.2</span> Lab Exercises</h3>
<p>AdventureWorks sells products to customers in multiple country/regions around the world.</p>
<p>An existing report uses the query provided in the editor to return total sales revenue grouped by country/region and state/province. Modify the query so that the results include a grand total for all sales revenue and a subtotal for each country/region in addition to the state/province subtotals that are already returned.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> a.CountryRegion, a.StateProvince, <span class="fu">SUM</span>(soh.TotalDue) <span class="kw">AS</span> Revenue
<span class="kw">FROM</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="kw">ON</span> a.AddressID = ca.AddressID
<span class="kw">JOIN</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">ON</span> ca.CustomerID = c.CustomerID
<span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">as</span> soh
<span class="kw">ON</span> c.CustomerID = soh.CustomerID
<span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">ROLLUP</span> (a.CountryRegion, a.StateProvince)
<span class="kw">ORDER</span> <span class="kw">BY</span> a.CountryRegion, a.StateProvince;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-114">Table 1.93: </span>9 records</caption>
<thead>
<tr class="header">
<th align="left">CountryRegion</th>
<th align="left">StateProvince</th>
<th align="right">Revenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">956303.5949</td>
</tr>
<tr class="even">
<td align="left">United Kingdom</td>
<td align="left">NA</td>
<td align="right">572496.5594</td>
</tr>
<tr class="odd">
<td align="left">United Kingdom</td>
<td align="left">England</td>
<td align="right">572496.5594</td>
</tr>
<tr class="even">
<td align="left">United States</td>
<td align="left">NA</td>
<td align="right">383807.0355</td>
</tr>
<tr class="odd">
<td align="left">United States</td>
<td align="left">California</td>
<td align="right">346517.6072</td>
</tr>
<tr class="even">
<td align="left">United States</td>
<td align="left">Colorado</td>
<td align="right">14017.9083</td>
</tr>
<tr class="odd">
<td align="left">United States</td>
<td align="left">Nevada</td>
<td align="right">7330.8972</td>
</tr>
<tr class="even">
<td align="left">United States</td>
<td align="left">New Mexico</td>
<td align="right">15275.1977</td>
</tr>
<tr class="odd">
<td align="left">United States</td>
<td align="left">Utah</td>
<td align="right">665.4251</td>
</tr>
</tbody>
</table>
</div>
<p>Modify your query to include a column named Level that indicates at which level in the total, country/region, and state/province hierarchy the revenue figure in the row is aggregated.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> a.CountryRegion, a.StateProvince,
    IIF(<span class="fu">GROUPING_ID</span>(a.CountryRegion) = <span class="dv">1</span> <span class="kw">AND</span> <span class="fu">GROUPING_ID</span>(a.StateProvince) = <span class="dv">1</span>, <span class="st">&#39;Total&#39;</span>, IIF(<span class="fu">GROUPING_ID</span>(a.StateProvince) = <span class="dv">1</span>, a.CountryRegion     + <span class="st">&#39; Subtotal&#39;</span>, a.StateProvince + <span class="st">&#39; Subtotal&#39;</span>)) <span class="kw">AS</span> <span class="kw">Level</span>,
<span class="fu">SUM</span>(soh.TotalDue) <span class="kw">AS</span> Revenue
<span class="kw">FROM</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="kw">ON</span> a.AddressID = ca.AddressID
<span class="kw">JOIN</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">ON</span> ca.CustomerID = c.CustomerID
<span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">as</span> soh
<span class="kw">ON</span> c.CustomerID = soh.CustomerID
<span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">ROLLUP</span>(a.CountryRegion, a.StateProvince)
<span class="kw">ORDER</span> <span class="kw">BY</span> a.CountryRegion, a.StateProvince;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-115">Table 1.94: </span>9 records</caption>
<thead>
<tr class="header">
<th align="left">CountryRegion</th>
<th align="left">StateProvince</th>
<th align="left">Level</th>
<th align="right">Revenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">Total</td>
<td align="right">956303.5949</td>
</tr>
<tr class="even">
<td align="left">United Kingdom</td>
<td align="left">NA</td>
<td align="left">United Kingdom Subtotal</td>
<td align="right">572496.5594</td>
</tr>
<tr class="odd">
<td align="left">United Kingdom</td>
<td align="left">England</td>
<td align="left">England Subtotal</td>
<td align="right">572496.5594</td>
</tr>
<tr class="even">
<td align="left">United States</td>
<td align="left">NA</td>
<td align="left">United States Subtotal</td>
<td align="right">383807.0355</td>
</tr>
<tr class="odd">
<td align="left">United States</td>
<td align="left">California</td>
<td align="left">California Subtotal</td>
<td align="right">346517.6072</td>
</tr>
<tr class="even">
<td align="left">United States</td>
<td align="left">Colorado</td>
<td align="left">Colorado Subtotal</td>
<td align="right">14017.9083</td>
</tr>
<tr class="odd">
<td align="left">United States</td>
<td align="left">Nevada</td>
<td align="left">Nevada Subtotal</td>
<td align="right">7330.8972</td>
</tr>
<tr class="even">
<td align="left">United States</td>
<td align="left">New Mexico</td>
<td align="left">New Mexico Subtotal</td>
<td align="right">15275.1977</td>
</tr>
<tr class="odd">
<td align="left">United States</td>
<td align="left">Utah</td>
<td align="left">Utah Subtotal</td>
<td align="right">665.4251</td>
</tr>
</tbody>
</table>
</div>
<p>Or to extend your query to include a grouping for individual cities.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> a.CountryRegion, a.StateProvince, a.City,
<span class="kw">CHOOSE</span> (<span class="dv">1</span> + <span class="fu">GROUPING_ID</span>(a.CountryRegion) + <span class="fu">GROUPING_ID</span>(a.StateProvince) + <span class="fu">GROUPING_ID</span>(a.City),
        a.City + <span class="st">&#39; Subtotal&#39;</span>, a.StateProvince + <span class="st">&#39; Subtotal&#39;</span>,
        a.CountryRegion + <span class="st">&#39; Subtotal&#39;</span>, <span class="st">&#39;Total&#39;</span>) <span class="kw">AS</span> <span class="kw">Level</span>,
<span class="fu">SUM</span>(soh.TotalDue) <span class="kw">AS</span> Revenue
<span class="kw">FROM</span> SalesLT.Address <span class="kw">AS</span> a
<span class="kw">JOIN</span> SalesLT.CustomerAddress <span class="kw">AS</span> ca
<span class="kw">ON</span> a.AddressID = ca.AddressID
<span class="kw">JOIN</span> SalesLT.Customer <span class="kw">AS</span> c
<span class="kw">ON</span> ca.CustomerID = c.CustomerID
<span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">as</span> soh
<span class="kw">ON</span> c.CustomerID = soh.CustomerID
<span class="kw">GROUP</span> <span class="kw">BY</span> <span class="kw">ROLLUP</span>(a.CountryRegion, a.StateProvince, a.City)
<span class="kw">ORDER</span> <span class="kw">BY</span> a.CountryRegion, a.StateProvince, a.City;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-116">Table 1.95: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CountryRegion</th>
<th align="left">StateProvince</th>
<th align="left">City</th>
<th align="left">Level</th>
<th align="right">Revenue</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">Total</td>
<td align="right">956303.5949</td>
</tr>
<tr class="even">
<td align="left">United Kingdom</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">United Kingdom Subtotal</td>
<td align="right">572496.5594</td>
</tr>
<tr class="odd">
<td align="left">United Kingdom</td>
<td align="left">England</td>
<td align="left">NA</td>
<td align="left">England Subtotal</td>
<td align="right">572496.5594</td>
</tr>
<tr class="even">
<td align="left">United Kingdom</td>
<td align="left">England</td>
<td align="left">Abingdon</td>
<td align="left">Abingdon Subtotal</td>
<td align="right">45.1995</td>
</tr>
<tr class="odd">
<td align="left">United Kingdom</td>
<td align="left">England</td>
<td align="left">Cambridge</td>
<td align="left">Cambridge Subtotal</td>
<td align="right">2711.4098</td>
</tr>
<tr class="even">
<td align="left">United Kingdom</td>
<td align="left">England</td>
<td align="left">Gloucestershire</td>
<td align="left">Gloucestershire Subtotal</td>
<td align="right">70698.9922</td>
</tr>
<tr class="odd">
<td align="left">United Kingdom</td>
<td align="left">England</td>
<td align="left">High Wycombe</td>
<td align="left">High Wycombe Subtotal</td>
<td align="right">608.1766</td>
</tr>
<tr class="even">
<td align="left">United Kingdom</td>
<td align="left">England</td>
<td align="left">Liverpool</td>
<td align="left">Liverpool Subtotal</td>
<td align="right">86222.8072</td>
</tr>
<tr class="odd">
<td align="left">United Kingdom</td>
<td align="left">England</td>
<td align="left">London</td>
<td align="left">London Subtotal</td>
<td align="right">206736.1667</td>
</tr>
<tr class="even">
<td align="left">United Kingdom</td>
<td align="left">England</td>
<td align="left">Maidenhead</td>
<td align="left">Maidenhead Subtotal</td>
<td align="right">43.0437</td>
</tr>
</tbody>
</table>
</div>
<p>AdventureWorks products are grouped into categories, which in turn have parent categories (defined in the SalesLT.vGetAllCategories view).</p>
<p>AdventureWorks customers are retail companies, and they may place orders for products of any category. The revenue for each product in an order is recorded as the LineTotal value in the SalesLT.SalesOrderDetail table.</p>
<p>Retrieve a list of customer company names together with their total revenue for each parent category in Accessories, Bikes, Clothing, and Components. Make sure to use the aliases provided, and default column names elsewhere.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> * <span class="kw">FROM</span>
(<span class="kw">SELECT</span> cat.ParentProductCategoryName, cust.CompanyName, sod.LineTotal
 <span class="kw">FROM</span> SalesLT.SalesOrderDetail <span class="kw">AS</span> sod
 <span class="kw">JOIN</span> SalesLT.SalesOrderHeader <span class="kw">AS</span> soh <span class="kw">ON</span> sod.SalesOrderID = soh.SalesOrderID
 <span class="kw">JOIN</span> SalesLT.Customer <span class="kw">AS</span> cust <span class="kw">ON</span> soh.CustomerID = cust.CustomerID
 <span class="kw">JOIN</span> SalesLT.Product <span class="kw">AS</span> prod <span class="kw">ON</span> sod.ProductID = prod.ProductID
 <span class="kw">JOIN</span> SalesLT.vGetAllCategories <span class="kw">AS</span> cat <span class="kw">ON</span> prod.ProductcategoryID = cat.ProductCategoryID) <span class="kw">AS</span> catsales
PIVOT (<span class="fu">SUM</span>(LineTotal) <span class="kw">FOR</span> ParentProductCategoryName
<span class="kw">IN</span> ([Accessories], [Bikes], [Clothing], [Components])) <span class="kw">AS</span> pivotedsales
<span class="kw">ORDER</span> <span class="kw">BY</span> CompanyName;</code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-117">Table 1.96: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="left">CompanyName</th>
<th align="right">Accessories</th>
<th align="right">Bikes</th>
<th align="right">Clothing</th>
<th align="right">Components</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Action Bicycle Specialists</td>
<td align="right">1299.885</td>
<td align="right">76613.6518</td>
<td align="right">2461.6573</td>
<td align="right">9494.082</td>
</tr>
<tr class="even">
<td align="left">Aerobic Exercise Company</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">1732.890</td>
</tr>
<tr class="odd">
<td align="left">Bulk Discount Store</td>
<td align="right">730.464</td>
<td align="right">70597.2840</td>
<td align="right">851.5620</td>
<td align="right">1980.918</td>
</tr>
<tr class="even">
<td align="left">Central Bicycle Specialists</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">31.584</td>
</tr>
<tr class="odd">
<td align="left">Channel Outlet</td>
<td align="right">216.000</td>
<td align="right">NA</td>
<td align="right">308.6640</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">Closest Bicycle Store</td>
<td align="right">NA</td>
<td align="right">20389.6680</td>
<td align="right">559.1641</td>
<td align="right">8001.846</td>
</tr>
<tr class="odd">
<td align="left">Coalition Bike Company</td>
<td align="right">NA</td>
<td align="right">529.4928</td>
<td align="right">124.7760</td>
<td align="right">1201.938</td>
</tr>
<tr class="even">
<td align="left">Discount Tours</td>
<td align="right">72.000</td>
<td align="right">2041.1880</td>
<td align="right">341.0580</td>
<td align="right">72.882</td>
</tr>
<tr class="odd">
<td align="left">Eastside Department Store</td>
<td align="right">1220.236</td>
<td align="right">51096.0548</td>
<td align="right">2772.2296</td>
<td align="right">10594.848</td>
</tr>
<tr class="even">
<td align="left">Engineered Bike Systems</td>
<td align="right">NA</td>
<td align="right">2604.7620</td>
<td align="right">178.7460</td>
<td align="right">63.900</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="modifying-data" class="section level2">
<h2><span class="header-section-number">1.9</span> Modifying Data</h2>
<p>This section isn’t about querying data, but adding, deleting and updating data in our database.</p>
<p>To add data we use the INSERT … VALUES command, where you can leave blank columns that allow NULLs and cols with default constraints. You can also leave identify/primary key fields blank since they will be generated automatically, depending on what seed and increment values were specified when the table was set up, however it is possible to overide these values if you wish. You can add a NULL value to a column if you wish.</p>
<p>You can also insert the results of another query in to an existing table using INSERT … SELECT or INSERT … EXEC where EXEC is the execution of a stored query.</p>
<p>Another option is SELECT … INTO will explicity create a new table, inserting data based on query. However this newly created table will not have contraints, defaults, indexes or primary keys, just a set of columns with the results of the query. This is currently not supported in Azure, however you could create the table first with the items needed such as columns and pk, then use the INSERT INTO for Azure.</p>
<p>Our Identity property of a column generates sequential numbers for insertations of new data into a database and we can set the parameters of this identity column. If you insert a new item (row) in to a table, you might want to then get back this identity column for this new item e.g. you automatically generate a new sales ID but a new order, however you might want to then present this back to the customer, this is acheived using @<span class="citation">(<span class="citeproc-not-found" data-reference-id="IDENITY"><strong>???</strong></span>)</span>, but this returns the last identity referenced, so if you are adding the sales order first then the individual items in a seperate table, it will retrieve the idenity column from the sales order details rather than sales order header. This command therefore returns the last identity from the current connected session.</p>
<p>An alternative is to use SELECT SCOPE_IDENTITY() AS ORDERID which wil bring back the last identity column for the specified table in the current session, but again this can be problematic. The alternative is to use IDENT_CURRENT(’<table_name'>) which passes the last identity inserted into a particular table, however this is across all sessions, so if others are inserting the table this can be problematic. So generally the best option is to use SCOPE_IDENTITY and present that, before then going on to do other things.</p>
<p>If you perhaps wanted to have two different tables for two different order types - say in store purchases and online purchases as two dinstinct tables - but to both use the same sequential list for order ID, you could do this using sequences. They exist independently of tables so can be referenced by mutiple tables, the query will ask the server what the next id is in the sequence and be provided with that. It is like a central store that issues new numbers on request.</p>
<p>So to create a new table for customer call logs we do the following:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">CREATE</span> <span class="kw">TABLE</span> SalesLT.CallLog
(
    CallID <span class="dt">int</span> IDENTITY <span class="kw">PRIMARY</span> <span class="kw">KEY</span> <span class="kw">NOT</span> <span class="kw">NULL</span>, <span class="co">-- no seed or increment set, so will start at 1 then add 1</span>
    CallTime datetime <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> GETDATE(), <span class="co">-- if not date and time set, it will get the current date and time</span>
    SalesPerson <span class="dt">nvarchar</span>(<span class="dv">256</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,
    CustomerID <span class="dt">int</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">REFERENCES</span> SalesLT.Customer(CustomerID), <span class="co">-- references a foreign key from the customer table</span>
    PhoneNumber <span class="dt">nvarchar</span>(<span class="dv">25</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,
    Notes <span class="dt">nvarchar</span>(<span class="fu">max</span>) <span class="kw">NULL</span> <span class="co">-- the only column which is allowed to be NULL, since perhaps the customer does not answer</span>
);
GO</code></pre></div>
<p>If we then wanted to explicitly add or insert a row in to the datbase we do the following - note the CallID does not need to be given since this is automatically created :</p>
<p>– INT is optional, we state values as we are explicitly stating the values</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">INSERT</span> <span class="kw">INTO</span> SalesLT.CallLog 
<span class="kw">VALUES</span> 
(<span class="st">&#39;2015-01-01T12:30:00&#39;</span>, <span class="st">&#39;adventure-works\pamela0&#39;</span>, <span class="dv">1</span>, <span class="st">&#39;245-555-0173&#39;</span>, <span class="st">&#39;Returning call re: enquiry about delivery&#39;</span>);</code></pre></div>
<p>If we wantedc to accept the default options, we can do that by using DEFAULT (e.g. for data/time) and if there are no notes we can use NULL.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">INSERT</span> <span class="kw">INTO</span> SalesLT.CallLog
<span class="kw">VALUES</span>
(<span class="kw">DEFAULT</span>, <span class="st">&#39;adventure-works\david8&#39;</span>, <span class="dv">2</span>, <span class="st">&#39;170-555-0127&#39;</span>, <span class="kw">NULL</span>);</code></pre></div>
<p>Perhaps we need to re-order our fields rather than accepting the default sequence, perhaps it is a modified table or a table form another source. To do this, we explicitly state the columns.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">INSERT</span> <span class="kw">INTO</span> SalesLT.CallLog (SalesPerson, CustomerID, PhoneNumber)
<span class="kw">VALUES</span>
(<span class="st">&#39;adventure-works\jillian0&#39;</span>, <span class="dv">3</span>, <span class="st">&#39;279-555-0130&#39;</span>);</code></pre></div>
<p>If we wanted to add two records, we can do this at the same time, and even use some different options for the different rows.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">INSERT</span> <span class="kw">INTO</span> SalesLT.CallLog
<span class="kw">VALUES</span>
(DATEADD(mi,-<span class="dv">2</span>, GETDATE()), <span class="st">&#39;adventure-works\jillian0&#39;</span>, <span class="dv">4</span>, <span class="st">&#39;710-555-0173&#39;</span>, <span class="kw">NULL</span>),
(<span class="kw">DEFAULT</span>, <span class="st">&#39;adventure-works\shu0&#39;</span>, <span class="dv">5</span>, <span class="st">&#39;828-555-0186&#39;</span>, <span class="st">&#39;Called to arrange deliver of order 10987&#39;</span>);</code></pre></div>
<p>There are more examples with adding query results into tables and getting identity values in the demo files.</p>
<p>Key Points * Use the INSERT statement to insert one or more rows into a table. * When inserting explicit values, you can omit identity columns, columns that allow NULLs, and columns on which a default constraint is defined. * Identity columns generate a unique integer identifier for each row. You can also use a sequence to generate unique values that can be used in multiple tables.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["BI-Notes.pdf", "BI-Notes.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
